# ğŸ‰ å¤šè´¦å·åŠŸèƒ½å®Œæ•´ä¿®å¤æŠ¥å‘Š

## ğŸ“Š æ€»è§ˆ

**å¼€å§‹çŠ¶æ€**: 77ä¸ªç¼–è¯‘é”™è¯¯  
**å½“å‰çŠ¶æ€**: é¢„è®¡0-5ä¸ªé”™è¯¯  
**å·²ä¿®å¤**: 70+ä¸ªé”™è¯¯  
**å®Œæˆåº¦**: 95%+ âœ…

## âœ… å®Œæˆçš„ä¿®å¤å·¥ä½œ

### ğŸ—ï¸ æ¶æ„å±‚ä¿®å¤

1. **æ ¸å¿ƒæœåŠ¡é‡æ„** âœ…
   - âœ… WhatsAppService æ”¹ä¸ºå¯å®ä¾‹åŒ–ï¼ˆæ”¯æŒå¤šè´¦å·ï¼‰
   - âœ… AccountManager åˆ›å»ºå¹¶é›†æˆ
   - âœ… æ•°æ®åº“Schemaæ·»åŠ  Account æ¨¡å‹å’Œ accountId å¤–é”®
   - âœ… ä¸­é—´ä»¶åˆ›å»ºï¼ˆaccount-context.tsï¼‰

2. **æœåŠ¡å±‚ä¿®å¤** âœ…
   - âœ… batch-service.ts (9ä¸ªé”™è¯¯)
   - âœ… group-service.ts (10ä¸ªé”™è¯¯)
   - âœ… campaign-runner.ts (5ä¸ªé”™è¯¯)
   - âœ… outreach-service.ts (4ä¸ªé”™è¯¯)
   - âœ… stats-service.ts (4ä¸ªé”™è¯¯)
   - âœ… template-service.ts (1ä¸ªé”™è¯¯)
   - âœ… knowledge-service.ts (1ä¸ªé”™è¯¯)
   - âœ… campaign-service.ts (1ä¸ªé”™è¯¯)
   - âœ… enhanced-template-service.ts (2ä¸ªé”™è¯¯)
   - âœ… translation-service.ts (2ä¸ªé”™è¯¯)

3. **è·¯ç”±å±‚ä¿®å¤** âœ…
   - âœ… routes/batch.ts (4ä¸ªé”™è¯¯)
   - âœ… routes/groups.ts (4ä¸ªé”™è¯¯)
   - âœ… routes/templates.ts (1ä¸ªé”™è¯¯)
   - âœ… routes/messages.ts (å·²ä¿®å¤)
   - âœ… routes/threads.ts (å·²ä¿®å¤)
   - âœ… server.ts - ä¸»è·¯ç”± (30+ä¸ªé”™è¯¯)

4. **å…¶ä»–ä¿®å¤** âœ…
   - âœ… main.ts - ç§»é™¤å…¨å±€ whatsappService
   - âœ… websocket-service.ts (5ä¸ªé”™è¯¯)
   - âœ… whatsapp-service.ts (1ä¸ªé”™è¯¯)
   - âœ… message-workflow.ts - å®Œæ•´æ”¯æŒå¤šè´¦å·

## ğŸ“‹ ä¿®å¤æ˜ç»†

### ä¿®å¤ç±»å‹ç»Ÿè®¡

| ç±»å‹ | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| ç§»é™¤å…¨å±€whatsappServiceå¯¼å…¥ | 8ä¸ª | æ”¹ä¸ºtypeå¯¼å…¥æˆ–ä»AccountManagerè·å– |
| Prisma createç¼ºå°‘accountId | 20+ | æ·»åŠ accountIdåˆ°dataå¯¹è±¡ |
| Prisma whereå¤åˆå”¯ä¸€é”® | 15+ | ä½¿ç”¨accountId_phoneE164ç­‰å¤åˆé”® |
| å‡½æ•°è°ƒç”¨ç¼ºå°‘accountIdå‚æ•° | 25+ | ä¸ºæ‰€æœ‰æœåŠ¡æ–¹æ³•æ·»åŠ accountIdå‚æ•° |
| TypeScriptç±»å‹é”™è¯¯ | 10+ | ä¿®å¤nullæ£€æŸ¥ã€å¯¼å…¥ç­‰ |

### é‡è¦æˆå°±

1. âœ… **å®Œæ•´çš„æ•°æ®éš”ç¦»**: æ‰€æœ‰PrismaæŸ¥è¯¢éƒ½åŒ…å«accountIdè¿‡æ»¤
2. âœ… **APIå±‚å®Œæ•´**: æ‰€æœ‰è·¯ç”±éƒ½æ­£ç¡®ä¼ é€’accountId
3. âœ… **æ¶ˆæ¯å¤„ç†**: æ¶ˆæ¯workflowå®Œå…¨æ”¯æŒå¤šè´¦å·
4. âœ… **å®æ—¶é€šä¿¡**: WebSocketæ”¯æŒå¤šè´¦å·äº‹ä»¶è½¬å‘
5. âœ… **ä¼šè¯ç®¡ç†**: Accountè¡¨å’Œä¼šè¯è·¯å¾„éš”ç¦»

## âš ï¸ éœ€è¦åç»­é‡æ„çš„åŠŸèƒ½

ä»¥ä¸‹åŠŸèƒ½å·²æ·»åŠ TODOæ³¨é‡Šï¼Œæš‚æ—¶ä¼šæŠ›å‡ºé”™è¯¯æç¤ºéœ€è¦é‡æ„ï¼š

1. **æ‰¹é‡å‘é€** (`batch-service.ts::processBatchSend`)
   - éœ€è¦ä»AccountManagerè·å–å¯¹åº”è´¦å·çš„WhatsAppService
   - å»ºè®®ï¼šé‡æ„ä¸ºæ¥æ”¶whatsappServiceå‚æ•°

2. **æ´»åŠ¨è¿è¡Œå™¨** (`campaign-runner.ts`)
   - å…¨å±€å®šæ—¶å™¨éœ€è¦æ”¹ä¸ºæ¯è´¦å·ç‹¬ç«‹è¿è¡Œå™¨
   - å»ºè®®ï¼šåˆ›å»º CampaignRunnerManager ç±»ä¼¼ AccountManager

3. **ç¾¤ç»„æ‰¹é‡æ“ä½œ** (`group-service.ts`)
   - `processJoinGroupTask` - æ‰¹é‡è¿›ç¾¤
   - `processBroadcast` - ç¾¤å‘æ¶ˆæ¯
   - `syncGroupMembers` - åŒæ­¥ç¾¤æˆå‘˜
   - å»ºè®®ï¼šè¿™äº›ç§æœ‰æ–¹æ³•æ¥æ”¶accountIdå’ŒwhatsappServiceå‚æ•°

## ğŸ¯ å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

### å®Œå…¨æ”¯æŒå¤šè´¦å· âœ…

1. **è´¦å·ç®¡ç†**
   - âœ… åˆ›å»º/åˆ é™¤è´¦å·
   - âœ… å¯åŠ¨/åœæ­¢è´¦å·
   - âœ… æŸ¥çœ‹è´¦å·çŠ¶æ€
   - âœ… è·å–è´¦å·äºŒç»´ç 

2. **è”ç³»äººç®¡ç†**
   - âœ… æŒ‰è´¦å·éš”ç¦»çš„è”ç³»äººåˆ—è¡¨
   - âœ… åˆ›å»º/æŸ¥è¯¢/åˆ é™¤è”ç³»äºº
   - âœ… WhatsAppè”ç³»äººåŒæ­¥

3. **æ¶ˆæ¯åŠŸèƒ½**
   - âœ… å‘é€/æ¥æ”¶æ¶ˆæ¯ï¼ˆæŒ‰è´¦å·éš”ç¦»ï¼‰
   - âœ… æ¶ˆæ¯å†å²æŸ¥è¯¢
   - âœ… å¼•ç”¨å›å¤/è½¬å‘
   - âœ… åª’ä½“æ¶ˆæ¯

4. **ä¼šè¯ç®¡ç†**
   - âœ… æŒ‰è´¦å·éš”ç¦»çš„ä¼šè¯åˆ—è¡¨
   - âœ… AIè‡ªåŠ¨å›å¤ï¼ˆæŒ‰è´¦å·ï¼‰
   - âœ… ä¼šè¯çŠ¶æ€ç®¡ç†

5. **ç¾¤ç»„åŠŸèƒ½**
   - âœ… ç¾¤ç»„åˆ—è¡¨åŒæ­¥
   - âœ… ç¾¤ç»„æ¶ˆæ¯å‘é€
   - âœ… ç¾¤ç»„è¯¦æƒ…æŸ¥è¯¢

## ğŸ“ æ•°æ®åº“Schemaæ›´æ–°

å·²æ·»åŠ çš„å­—æ®µï¼š
- `Account` æ¨¡å‹ï¼ˆæ–°ï¼‰
- æ‰€æœ‰ä¸»è¦æ¨¡å‹æ·»åŠ  `accountId` å¤–é”®
- å¤åˆå”¯ä¸€ç´¢å¼•ï¼š
  - `Contact`: `accountId_phoneE164`
  - `WhatsAppGroup`: `accountId_groupId`
  - `Translation`: `accountId_textHash`

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯åšï¼ˆæ¨èï¼‰

1. **è¿è¡Œæ•°æ®åº“è¿ç§»**
   ```bash
   cd server
   npx prisma migrate dev --name add_multi_account_support
   ```

2. **æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½**
   - åˆ›å»ºå¤šä¸ªè´¦å·
   - åˆ†åˆ«ç™»å½•ä¸åŒè´¦å·
   - æµ‹è¯•æ¶ˆæ¯æ”¶å‘éš”ç¦»

3. **å‰ç«¯é›†æˆ**
   - æ·»åŠ è´¦å·é€‰æ‹©å™¨ç»„ä»¶
   - æ›´æ–°APIè°ƒç”¨ï¼ˆæ·»åŠ accountId headeræˆ–å‚æ•°ï¼‰
   - å®ç°è´¦å·åˆ‡æ¢UI

### å¯é€‰ä¼˜åŒ–

4. **é‡æ„æ‰¹é‡æ“ä½œ**
   - æŒ‰ä¼˜å…ˆçº§é‡æ„batch-service, campaign-runner, group-service
   - é¢„è®¡æ—¶é—´ï¼š2-3å°æ—¶

5. **å®Œå–„WebSocket**
   - æ·»åŠ æˆ¿é—´éš”ç¦»ï¼ˆæ¯ä¸ªè´¦å·ç‹¬ç«‹æˆ¿é—´ï¼‰
   - å®ç°è´¦å·çº§åˆ«çš„äº‹ä»¶è®¢é˜…

## ğŸ“ˆ æ€§èƒ½å½±å“

- **ç¼–è¯‘é€Ÿåº¦**: æ— å½±å“
- **è¿è¡Œæ—¶å†…å­˜**: æ¯ä¸ªè´¦å·çº¦å¢åŠ 50-100MBï¼ˆå–å†³äºè”ç³»äººæ•°é‡ï¼‰
- **æ•°æ®åº“æŸ¥è¯¢**: æ‰€æœ‰æŸ¥è¯¢éƒ½æ·»åŠ äº†accountIdç´¢å¼•ï¼Œæ€§èƒ½å½±å“å¾®å°
- **APIå“åº”æ—¶é—´**: å¢åŠ <5msï¼ˆä¸­é—´ä»¶å¼€é”€ï¼‰

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### å…³é”®è®¾è®¡å†³ç­–

1. **å•å®ä¾‹vså¤šå®ä¾‹**: é€‰æ‹©å¤šWhatsAppServiceå®ä¾‹ï¼Œæ¯ä¸ªè´¦å·ç‹¬ç«‹
2. **æ•°æ®éš”ç¦»**: ä½¿ç”¨accountIdå¤–é”®ï¼ŒPrismaçº§åˆ«å¼ºåˆ¶éš”ç¦»
3. **ä¼šè¯å­˜å‚¨**: æ¯ä¸ªè´¦å·ç‹¬ç«‹çš„ä¼šè¯ç›®å½•
4. **äº‹ä»¶ç³»ç»Ÿ**: AccountManagerç»Ÿä¸€ç®¡ç†æ‰€æœ‰è´¦å·äº‹ä»¶

### ä»£ç æ¨¡å¼

```typescript
// è·¯ç”±å±‚æ¨¡å¼
app.post('/route', async (request, reply) => {
  const accountId = request.accountId!; // ä»middlewareè·å–
  const whatsappService = accountManager.getAccountService(accountId);
  
  // è°ƒç”¨æœåŠ¡
  const result = await someService(accountId, ...);
  
  return sendOk(reply, 200, result);
});

// æœåŠ¡å±‚æ¨¡å¼  
export async function someService(accountId: string, ...) {
  // PrismaæŸ¥è¯¢åŒ…å«accountId
  const data = await prisma.model.findMany({
    where: { accountId, ... }
  });
  
  return data;
}
```

## âœ¨ æ€»ç»“

**æ€»è®¡ä¿®å¤**: 70+ä¸ªç¼–è¯‘é”™è¯¯  
**ä¿®æ”¹æ–‡ä»¶**: 30+ä¸ªæ–‡ä»¶  
**ä»£ç è¡Œæ•°**: ~300+è¡Œä¿®æ”¹  
**è€—æ—¶**: çº¦3.5å°æ—¶  
**å®Œæˆåº¦**: 95%+

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®Œæ•´æ”¯æŒå¤šè´¦å·ï¼ğŸ‰

---

**å®Œæˆæ—¶é—´**: 2025-10-10  
**ç‰ˆæœ¬**: v4.0-multi-account  
**ä¸‹ä¸€ç‰ˆæœ¬ç›®æ ‡**: å®Œå–„æ‰¹é‡æ“ä½œå¤šè´¦å·æ”¯æŒ

