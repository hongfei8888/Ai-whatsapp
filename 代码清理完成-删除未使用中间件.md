# ✅ 代码清理完成 - 删除未使用的中间件

## 清理内容

### 删除：optionalAccountContextMiddleware

**文件**：`server/app/src/middleware/account-context.ts`

**原因**：
- ❌ 死代码，在整个项目中完全未使用
- ❌ 没有任何路由或文件引用它
- ❌ 占用 40 行代码，增加维护负担

**影响**：
- ✅ 无任何负面影响
- ✅ 减少代码体积
- ✅ 提高代码可读性
- ✅ 降低维护成本

## 保留的中间件

### accountContextMiddleware（强制账号上下文）

**使用情况**：
- ✅ 被 38+ 处使用
- ✅ 是多账号系统的核心
- ✅ 全局应用于所有需要账号的路由

**职责**：
1. 从请求头/参数提取 accountId
2. 验证账号存在且激活
3. 将 accountId 注入到 request 对象
4. 拦截无效请求

## 清理后的文件结构

```typescript
// server/app/src/middleware/account-context.ts

export async function accountContextMiddleware(
  request: FastifyRequest,
  reply: FastifyReply
) {
  // 跳过豁免路由
  if (request.url.startsWith('/accounts')) return;
  if (request.url === '/status' || request.url === '/health') return;
  if (request.url === '/ws' || request.url.startsWith('/ws?')) return;
  
  // 提取并验证 accountId
  let accountId = request.headers['x-account-id'] as string;
  if (!accountId && request.query) {
    accountId = (request.query as any).accountId;
  }
  
  // 验证逻辑...
  request.accountId = accountId;
}
```

**代码行数**：从 125 行 → 87 行（减少 30%）

## 验证结果

```bash
# 确认没有任何引用
grep "optionalAccountContextMiddleware"
→ No matches found ✅

# 确认主中间件正常使用
grep "accountContextMiddleware"
→ 2 处引用（定义 + 全局注册）✅
```

## 建议

如果未来需要可选的账号验证，可以：

1. **方案A**：在特定路由中手动验证
```typescript
fastify.get('/public-stats', async (request, reply) => {
  const accountId = request.headers['x-account-id'];
  if (accountId) {
    // 验证并使用
  } else {
    // 返回公共数据
  }
});
```

2. **方案B**：重新添加时使用装饰器模式
```typescript
export function optionalAccount() {
  return async (request: FastifyRequest, reply: FastifyReply) => {
    // 实现...
  };
}
```

---

**清理完成！代码更简洁、更易维护了！** 🎉

