# 📝 多账号架构-前端批量修复指南

## 🎯 修复策略

由于 `api.getStatus()`, `api.getContacts()`, `api.createContact()` 这些全局API已被废弃，所有前端组件都需要：

1. **导入 `useAccount` hook**
2. **获取 `currentAccountId`**
3. **使用新的多账号API**

---

## 🔧 通用修复模式

### Pattern 1: 修复 `api.getStatus()`

```typescript
// ❌ 旧代码
import { api } from '@/lib/api';

const status = await api.getStatus();

// ✅ 新代码
import { api } from '@/lib/api';
import { useAccount } from '@/lib/account-context';

const { currentAccountId } = useAccount();

if (!currentAccountId) {
  // 处理未选择账号
  console.warn('No account selected');
  return;
}

const status = await api.accounts.getStatus(currentAccountId);
```

### Pattern 2: 修复 `api.getContacts()`

```typescript
// ❌ 旧代码
const response = await api.getContacts();
const contacts = response.contacts || [];

// ✅ 新代码 - 方案A：如果有多账号contacts API
const { currentAccountId } = useAccount();
if (!currentAccountId) return;

const response = await api.contacts.list(currentAccountId);
const contacts = response || [];

// ✅ 新代码 - 方案B：如果使用threads/messages
const threads = await api.getThreads();
// 从threads中提取contacts
```

### Pattern 3: 修复 `api.createContact()`

```typescript
// ❌ 旧代码
await api.createContact({
  phoneE164: '+1234567890',
  name: 'John Doe'
});

// ✅ 新代码
const { currentAccountId } = useAccount();
if (!currentAccountId) return;

await api.contacts.create(currentAccountId, {
  phoneE164: '+1234567890',
  name: 'John Doe'
});
```

---

## 📋 需要修复的文件清单

### 🔴 高优先级（影响核心功能）

#### 1. `web/app/contacts/page.tsx`
**问题**：
- Line 329: `api.getContacts()`
- Line 438: `api.createContact()`

**修复**：已在之前修复（使用 `currentAccountId`）

**状态**：✅ 部分完成（contacts list加载可能已修复）

---

#### 2. `web/app/settings/page.tsx`
**问题**：
- Line 285: `api.getStatus()`

**修复**：
```typescript
// 在组件开头添加
const { currentAccountId } = useAccount();

// 修改 loadWhatsappStatus
const loadWhatsappStatus = async () => {
  if (!currentAccountId) {
    console.warn('No account selected');
    return;
  }
  
  try {
    const data = await api.accounts.getStatus(currentAccountId);
    setWhatsappStatus(data);
  } catch (error) {
    console.error('加载WhatsApp状态失败:', error);
  }
};
```

---

#### 3. `web/app/batch/send/page.tsx`
**问题**：
- Line 342: `api.getContacts()`

**修复**：
```typescript
// 添加 useAccount
import { useAccount } from '@/lib/account-context';

const { currentAccountId } = useAccount();

// 修改 loadContacts
const loadContacts = async () => {
  if (!currentAccountId) {
    alert('请先选择账号');
    return;
  }
  
  setContactsLoading(true);
  try {
    // 方案：通过 threads 获取 contacts
    const threads = await api.getThreads();
    const contactsData = threads.map(t => t.contact).filter(Boolean);
    setContacts(contactsData);
  } catch (error) {
    console.error('加载联系人失败:', error);
    setContacts([]);
  } finally {
    setContactsLoading(false);
  }
};
```

---

### 🟡 中优先级（影响辅助功能）

#### 4. `web/components/ContactSelector.tsx`
**问题**：
- Line 289: `api.getContacts()`

**修复**：
```typescript
import { useAccount } from '@/lib/account-context';

// 在组件中
const { currentAccountId } = useAccount();

const loadContacts = async () => {
  if (!currentAccountId) {
    setContacts([]);
    return;
  }
  
  try {
    setLoading(true);
    const threads = await api.getThreads();
    const contactsData = threads.map(t => t.contact).filter(Boolean);
    setContacts(contactsData);
  } catch (error) {
    console.error('加载联系人失败:', error);
    setContacts([]);
  } finally {
    setLoading(false);
  }
};
```

---

#### 5. `web/app/chat/group/[id]/page.tsx`
**问题**：
- Line 1373: `api.createContact()`
- Line 1381: `api.getContacts()`

**修复**：
```typescript
// 这个文件已经使用了 useAccount，只需要更新API调用

// 修改 createContact 调用
const contactData = await api.contacts.create(currentAccountId, {
  phoneE164: phoneNumber,
  name: member.displayName || phoneNumber
});

// 修改 getContacts 调用（如果使用）
const threads = await api.getThreads();
const contacts = threads.map(t => t.contact).filter(Boolean);
```

---

### 🟢 低优先级（开发/调试组件）

#### 6-11. Dashboard对话框组件
这些组件主要用于开发调试，可以：
- 选项A：暂时禁用（添加 `if (!currentAccountId) return null;`）
- 选项B：全部修复为使用 `api.accounts.getStatus(currentAccountId)`
- 选项C：移除这些组件（如果不再需要）

文件列表：
- `web/components/auth/login-modal.tsx`
- `web/components/dashboard/account-dialog.tsx`
- `web/components/dashboard/status-dialog.tsx`
- `web/components/dashboard/settings-dialog.tsx`
- `web/components/dashboard/status-card.tsx`
- `web/components/account/AccountDrawer.tsx`

---

## 🚀 推荐修复顺序

### 第1步：核心功能（必须）
1. ✅ `web/app/contacts/page.tsx` - 已修复
2. `web/app/settings/page.tsx`
3. `web/app/batch/send/page.tsx`

### 第2步：辅助功能（重要）
4. `web/components/ContactSelector.tsx`
5. `web/app/chat/group/[id]/page.tsx`

### 第3步：开发组件（可选）
6-11. 各种Dashboard对话框

---

## 💡 快速修复方案

### 方案A：立即可用（推荐）
由于没有全局的 `api.contacts` API，使用 `api.getThreads()` 来获取联系人：

```typescript
// 替代 api.getContacts()
const threads = await api.getThreads();
const contacts = threads.map(t => ({
  id: t.contact.id,
  name: t.contact.name,
  phoneE164: t.contact.phoneE164,
  ...t.contact
})).filter(Boolean);
```

### 方案B：添加新的Contacts API（最佳实践）
如果需要专门的contacts API，需要：
1. 后端添加 contacts 路由
2. 前端添加对应的 API 方法
3. 更新所有调用

---

## ⚠️ 注意事项

1. **所有使用 `useAccount` 的组件都需要检查 `currentAccountId` 是否存在**
2. **未选择账号时应该显示友好提示，而不是报错**
3. **contacts 功能可以通过 threads 间接获取**
4. **一些旧的Dashboard组件可能不再需要（多账号系统有新的UI）**

---

## ✅ 修复完成标准

- [ ] 所有 `api.getStatus()` 调用已替换
- [ ] 所有 `api.getContacts()` 调用已替换或移除
- [ ] 所有 `api.createContact()` 调用已替换
- [ ] 未选择账号时有友好提示
- [ ] 编译无错误
- [ ] 功能测试通过

---

**建议**：由于修改较多，建议逐个文件测试，确保不影响现有功能。

