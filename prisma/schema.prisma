generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 🆕 多账号管理模型
model Account {
  id          String    @id @default(cuid())
  name        String    // 账号名称（用于区分）
  phoneNumber String?   // 电话号码
  phoneE164   String?   // E.164格式电话号码
  sessionPath String    @unique // 会话数据存储路径
  status      String    @default("offline") // online, offline, qr, connecting
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastOnline  DateTime? // 最后在线时间
  
  // 级联删除关联数据
  contacts    Contact[]
  groups      Group[]
  messages    Message[]
  templates   MessageTemplate[]
  campaigns   Campaign[]
  batches     BatchOperation[]
  knowledge   KnowledgeBase[]
  
  @@index([status, isActive])
}

// 🆕 群组管理模型
model Group {
  id          String    @id @default(cuid())
  accountId   String    // 所属账号
  groupId     String    // WhatsApp群组ID
  name        String    // 群组名称
  description String?   // 群组描述
  imageUrl    String?   // 群组头像URL
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // 群组设置
  isMonitoring Boolean  @default(false) // 是否监控
  isActive     Boolean  @default(true)  // 是否激活
  
  // 统计数据
  memberCount  Int      @default(0)     // 成员数量
  messageCount Int      @default(0)     // 消息数量
  lastMessageAt DateTime?               // 最后消息时间
  
  // 关联
  account      Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  members      GroupMember[]
  
  @@unique([accountId, groupId])
  @@index([accountId, isActive])
}

// 🆕 群组成员模型
model GroupMember {
  id          String    @id @default(cuid())
  groupId     String    // 所属群组
  phoneE164   String    // 成员电话（E.164格式）
  name        String?   // 成员名称
  role        String    @default("member") // admin, member
  isActive    Boolean   @default(true)     // 是否活跃
  joinedAt    DateTime  @default(now())
  lastSeenAt  DateTime?
  
  // 关联
  group       Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@unique([groupId, phoneE164])
  @@index([groupId, isActive])
}

enum MessageDirection {
  IN
  OUT
}

enum MessageStatus {
  SENT
  FAILED
  QUEUED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  DONE
  CANCELLED
}

enum CampaignRecipientStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  SKIPPED
}

model Contact {
  consent        Boolean   @default(true)
  optedOutAt     DateTime?
  tags           Json?     // 联系人标签
  source         String?   // 导入来源
  importBatchId  String?   // 批量导入批次ID
  notes          String?   // 备注信息

  id             String    @id @default(cuid())
  accountId      String    // 🆕 所属账号
  phoneE164      String
  name           String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  // 关联
  account        Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  threads        Thread[]
  campaignRecipients CampaignRecipient[]
  
  @@unique([accountId, phoneE164])
  @@index([accountId])
}

model Thread {
  id           String    @id @default(cuid())
  contactId    String    @unique
  aiEnabled    Boolean   @default(false)
  takenOver    Boolean   @default(false)
  takenOverAt  DateTime?
  lastHumanAt  DateTime?
  lastBotAt    DateTime?
  autoTranslate Boolean  @default(false) // 是否启用自动翻译
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  contact      Contact   @relation(fields: [contactId], references: [id])
  messages     Message[]
}

model Message {
  id             String           @id @default(cuid())
  accountId      String           // 🆕 所属账号
  threadId       String
  externalId     String?
  direction      MessageDirection
  text           String?
  translatedText String?          // 翻译后的文本
  status         MessageStatus    @default(SENT)
  createdAt      DateTime         @default(now())
  
  // 关联
  account        Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  thread         Thread           @relation(fields: [threadId], references: [id])

  // 媒体文件支持
  mediaUrl         String?        // 媒体文件URL
  mediaType        String?        // 类型: image, document, audio, video
  mediaMimeType    String?        // MIME类型
  mediaSize        Int?           // 文件大小(字节)
  mediaFileName    String?        // 服务器上的文件名(唯一)
  originalFileName String?        // 客户端原始文件名(用于显示)
  thumbnailUrl     String?        // 缩略图URL(用于图片/视频)
  duration         Int?           // 音视频时长(秒)

  // 消息引用
  replyToId     String?        // 引用的消息ID
  replyTo       Message?       @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies       Message[]      @relation("MessageReplies")

  // 消息编辑
  isEdited      Boolean        @default(false)
  editedAt      DateTime?
  originalText  String?        // 编辑前的原文

  // 消息删除
  isDeleted     Boolean        @default(false)
  deletedAt     DateTime?
  deletedBy     String?        // 删除者(对方/自己)

  // 消息转发
  isForwarded   Boolean        @default(false)
  forwardedFrom String?        // 原始发送者信息

  // 消息标记
  isStarred     Boolean        @default(false)
  starredAt     DateTime?

  // 消息状态扩展
  deliveredAt   DateTime?      // 送达时间
  readAt        DateTime?      // 已读时间

  @@unique([accountId, externalId])
  @@index([accountId, threadId, createdAt])
  @@index([threadId, createdAt])
  @@index([replyToId])
}

model AiConfig {
  id           String   @id @default("global")
  systemPrompt String
  maxTokens    Int      @default(384)
  temperature  Float    @default(0.4)
  minChars     Int      @default(80)
  stylePreset  String   @default("concise-cn")
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())
}

// 扩展的MessageTemplate模型
model MessageTemplate {
  id          String   @id @default(cuid())
  accountId   String   // 🆕 所属账号
  name        String
  content     String
  description String?  // 模板描述
  category    String   @default("general") // 模板分类
  tags        Json?    // 标签数组
  variables   Json?    // 变量数组
  isActive    Boolean  @default(true) // 是否激活
  usageCount  Int      @default(0) // 使用次数
  lastUsedAt  DateTime? // 最后使用时间
  sortOrder   Int      @default(0) // 排序顺序
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // 关联
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  campaigns   Campaign[]

  @@index([accountId, category, isActive])
  @@index([usageCount, lastUsedAt])
}

// 模板分类模型
model TemplateCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  icon        String?  // 图标
  color       String?  // 颜色
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Campaign {
  id             String          @id @default(cuid())
  accountId      String          // 🆕 所属账号
  name           String
  templateId     String?
  content        String?
  scheduleAt     DateTime?
  ratePerMinute  Int             @default(8)
  jitterMs       Int             @default(300)
  status         CampaignStatus  @default(DRAFT)
  total          Int             @default(0)
  sent           Int             @default(0)
  failed         Int             @default(0)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  // 关联
  account        Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  template       MessageTemplate? @relation(fields: [templateId], references: [id])
  recipients     CampaignRecipient[]
  
  @@index([accountId, status])
}

model CampaignRecipient {
  id         String                    @id @default(cuid())
  campaignId String
  contactId  String?
  phoneE164  String
  status     CampaignRecipientStatus   @default(PENDING)
  lastError  String?
  sentAt     DateTime?
  tries      Int                       @default(0)
  maxTries   Int                       @default(3)
  createdAt  DateTime                  @default(now())
  updatedAt  DateTime                  @updatedAt
  campaign   Campaign                  @relation(fields: [campaignId], references: [id])
  contact    Contact?                  @relation(fields: [contactId], references: [id])

  @@index([campaignId, status])
}

// 批量操作记录表
model BatchOperation {
  id            String    @id @default(cuid())
  accountId     String    // 🆕 所属账号
  type          String    // 'import', 'send', 'tag', 'delete', 'archive'
  status        String    @default("pending") // 'pending', 'processing', 'completed', 'failed', 'cancelled'
  title         String
  description   String?
  totalCount    Int       @default(0)
  processedCount Int      @default(0)
  successCount  Int       @default(0)
  failedCount   Int       @default(0)
  config        Json?     // 配置信息
  result        Json?     // 结果信息
  errorMessage  String?
  progress      Int       @default(0) // 0-100
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  startedAt     DateTime?
  completedAt   DateTime?
  createdBy     String    @default("system")
  
  // 关联
  account       Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  items         BatchOperationItem[]

  @@index([accountId, type, status])
  @@index([type, status])
}

// 批量操作明细表
model BatchOperationItem {
  id           String    @id @default(cuid())
  batchId      String
  itemIndex    Int
  itemData     Json?     // 项目数据
  status       String    @default("pending") // 'pending', 'processing', 'completed', 'failed', 'skipped'
  errorMessage String?
  result       Json?     // 处理结果
  processedAt  DateTime?
  createdAt    DateTime  @default(now())
  batch        BatchOperation @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId, status])
}

// 知识库表
model KnowledgeBase {
  id          String    @id @default(cuid())
  accountId   String    // 🆕 所属账号
  title       String
  content     String
  category    String    @default("general")
  tags        Json?     // 标签数组
  keywords    Json?     // 关键词数组
  priority    Int       @default(0) // 优先级
  usageCount  Int       @default(0) // 使用次数
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String    @default("system")
  
  // 关联
  account     Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, category, isActive])
  @@index([category, isActive])
  @@index([priority, usageCount])
}

// FAQ分类表
model FAQCategory {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  icon        String?
  color       String?
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
}

// 翻译缓存表
model Translation {
  id             String   @id @default(cuid())
  originalText   String   // 原文
  translatedText String   // 译文
  sourceLang     String   // 源语言（auto-detect）
  targetLang     String   // 目标语言（zh）
  textHash       String   @unique // MD5 hash for caching
  provider       String   @default("baidu") // 翻译服务提供商
  usageCount     Int      @default(1) // 使用次数
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([textHash])
  @@map("translations")
}