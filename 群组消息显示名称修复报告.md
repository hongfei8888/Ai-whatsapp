# 🔧 群组消息显示名称修复报告

## 📅 修复时间
2025-10-10

## 🐛 问题描述

**现象：**
- 群组聊天中收到的消息显示 WhatsApp ID（如 `120363442952033929@g.us`）
- 没有显示发送者的真实名称
- 只有自己发送的消息能正确显示为"我"

**根本原因：**
后端在处理接收到的群组消息时（`GroupService.handleGroupMessage`），WebSocket 广播事件中没有包含发送者的名称（`fromName`）字段。

## ✅ 解决方案

### 修改文件
`server/app/src/services/group-service.ts`

### 修改 1：添加发送者名称到 WebSocket 广播

**位置：** `handleGroupMessage` 方法

**修改前：**
```typescript
// 通过 WebSocket 广播新消息（所有群组消息）
webSocketService.broadcast({
  type: 'group_message',
  data: {
    groupId: group.id,
    groupName: group.name,
    messageId: message.id._serialized,
    from: message.from,  // 只有电话号码
    body: message.body,
    timestamp: Date.now(),
  },
  timestamp: Date.now(),
});
```

**修改后：**
```typescript
// 获取发送者信息用于 WebSocket 广播
const contact = await message.getContact();
const fromName = contact?.pushname || contact?.name || message.from;

// 通过 WebSocket 广播新消息（所有群组消息）
webSocketService.broadcast({
  type: 'group_message',
  data: {
    groupId: group.id,
    groupName: group.name,
    messageId: message.id._serialized,
    from: message.from,
    fromName: fromName,  // ✅ 添加发送者名称
    body: message.body,
    mediaType: message.type || 'chat',  // ✅ 添加消息类型
    timestamp: Date.now(),
  },
  timestamp: Date.now(),
});
```

### 修改 2：改进数据库保存逻辑

**位置：** `saveGroupMessage` 方法

**修改前：**
```typescript
const contact = await message.getContact();

await prisma.groupMessage.create({
  data: {
    groupId,
    messageId: message.id._serialized,
    fromPhone: message.from,
    fromName: contact?.pushname || contact?.name || null,  // ❌ 可能为 null
    text: message.body || null,
    mediaType: message.type || null,
  },
});
```

**修改后：**
```typescript
const contact = await message.getContact();
// 优先使用 pushname，然后 name，最后使用电话号码
const fromName = contact?.pushname || contact?.name || message.from;  // ✅ 始终有值

await prisma.groupMessage.create({
  data: {
    groupId,
    messageId: message.id._serialized,
    fromPhone: message.from,
    fromName: fromName,  // ✅ 保证有名称
    text: message.body || null,
    mediaType: message.type || null,
  },
});
```

## 📊 名称优先级

系统按以下顺序获取发送者名称：

1. **`contact.pushname`** - WhatsApp 用户设置的昵称（最优先）
2. **`contact.name`** - 联系人名称
3. **`message.from`** - 电话号码（后备方案）

这确保了即使无法获取用户昵称，至少也会显示电话号码而不是 `null`。

## 🎨 UI 显示效果

### Before（修复前）
```
┌────────────────────────────────┐
│ 120363442952033929@g.us         │
│ 测试                            │
│                           12:40│
└────────────────────────────────┘
```

### After（修复后）
```
┌────────────────────────────────┐
│ 张三                            │
│ 测试                            │
│                           12:40│
└────────────────────────────────┘
```

## 🔄 数据流程

### 接收消息流程

1. **WhatsApp 收到群组消息**
   ```
   WhatsApp → message event
   ```

2. **后端处理消息**
   ```typescript
   GroupService.handleGroupMessage(chat, message)
   ├─ 获取发送者联系人信息
   │  const contact = await message.getContact();
   │  const fromName = contact?.pushname || contact?.name || message.from;
   │
   ├─ 保存到数据库（带名称）
   │  await saveGroupMessage(groupId, message)
   │
   └─ 广播 WebSocket 事件（带名称）
      webSocketService.broadcast({
        type: 'group_message',
        data: {
          from: message.from,
          fromName: fromName,  // ✅ 包含名称
          body: message.body,
          ...
        }
      })
   ```

3. **前端接收并显示**
   ```typescript
   useWebSocket({
     onGroupMessage: (message) => {
       // message.fromName 现在包含真实名称
       const newMessage = {
         fromPhone: message.from,
         fromName: message.fromName,  // ✅ 显示名称
         text: message.body,
         ...
       };
       setMessages(prev => [...prev, newMessage]);
     }
   });
   ```

## 🚀 重启步骤

### 1. 停止旧服务

如果后端服务正在运行，先停止它：
- 按 `Ctrl + C` 停止
- 或使用任务管理器结束进程

### 2. 启动新服务

```bash
cd server
npm run dev
```

等待看到：
```
Server listening on port 4000
```

### 3. 测试修复

1. 在手机 WhatsApp 向测试群组发送消息
2. 网页端应该实时显示消息
3. ✅ 消息应该显示发送者的真实名称，而不是电话号码

## ⚠️ 注意事项

### 1. 联系人信息

- 如果 WhatsApp 联系人没有设置昵称，可能仍会显示电话号码
- 这是正常的，因为 WhatsApp 本身就是这样工作的

### 2. 数据库历史消息

- 修复只影响新收到的消息
- 历史消息的名称不会自动更新
- 如需更新历史消息，需要重新同步群组

### 3. 性能考虑

- 每条消息都会调用 `message.getContact()`
- 这可能有轻微的性能影响
- 但对于正常的群组聊天流量是可以接受的

## 📋 测试清单

- [ ] 后端编译无错误
- [ ] 后端服务成功启动
- [ ] 接收群组消息显示真实名称
- [ ] 自己发送的消息显示"我"
- [ ] 消息实时更新
- [ ] 左侧群组列表正常
- [ ] 消息位置正确（自己右边，他人左边）

## 🎉 总结

### 修复的核心问题
- ✅ WebSocket 事件现在包含 `fromName` 字段
- ✅ 数据库保存时确保有名称（不会是 null）
- ✅ 前端正确显示发送者名称

### 用户体验提升
- 🎯 清晰显示是谁发送的消息
- 📱 更接近 WhatsApp Web 的体验
- ✨ 专业的聊天界面

修复完成后，群组聊天将正确显示所有成员的名称！🎊

