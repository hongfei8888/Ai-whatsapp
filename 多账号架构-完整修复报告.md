# 🔧 多账号架构-完整修复报告

## 📋 修复范围

检测到项目中 **1个后端** 和 **11个前端文件** 仍在使用旧的单账号API，需要更新为多账号架构。

---

## ✅ 已完成修复

### 1️⃣ 通讯录-同步群组功能 ✅
**文件**：`web/app/contacts/page.tsx`  
**问题**：使用 `api.getStatus()` 调用已废弃路由  
**修复**：改用 `api.accounts.getStatus(currentAccountId)`  
**状态**：✅ 完成

### 2️⃣ 通讯录-同步群成员功能 ✅
**文件**：
- `server/app/src/routes/groups.ts`
- `server/app/src/services/group-service.ts`
- `server/app/src/wppconnect-service.ts`

**问题**：
- 路由未传递 `whatsappService` 实例
- `syncGroupMembers` 方法未实现多账号支持
- 数据库字段名不匹配

**修复**：
1. ✅ 路由添加 `accountId` 验证和 `whatsappService` 获取
2. ✅ 实现完整的群成员同步逻辑
3. ✅ 添加 `getGroupParticipants` 方法到 WPPConnect服务
4. ✅ 修正数据库字段名：
   - `chatId` → `groupId`
   - `groupParticipant` → `groupMember`
   - `participantCount` → `memberCount`
   - `isAdmin` → `role` (使用 'admin' 或 'member')
   - `name` → `displayName`

**状态**：✅ 完成并通过编译

---

## ⏳ 待修复列表

### 🔴 后端 (1个)

#### 1. Campaign Runner 功能
**文件**：`server/app/src/services/campaign-runner.ts`  
**问题**：直接抛出错误 "Campaign runner needs refactoring for multi-account support"  
**需要**：重构为接收 `whatsappService` 参数

---

### 🔴 前端 (11个文件)

#### 问题分类：

**A. 使用 `api.getStatus()`（旧的全局状态API）**
1. `web/components/auth/login-modal.tsx`
2. `web/components/dashboard/account-dialog.tsx`
3. `web/components/dashboard/status-dialog.tsx`
4. `web/components/dashboard/settings-dialog.tsx`
5. `web/app/settings/page.tsx`
6. `web/components/dashboard/status-card.tsx`
7. `web/components/account/AccountDrawer.tsx`

**B. 使用 `api.getContacts()`（旧的全局联系人API）**
8. `web/app/contacts/page.tsx`
9. `web/components/ContactSelector.tsx`
10. `web/app/chat/group/[id]/page.tsx`
11. `web/components/contacts/contacts-table.tsx`
12. `web/app/batch/send/page.tsx`

**C. 使用 `api.createContact()`（旧的全局创建联系人API）**
13. `web/app/contacts/page.tsx`
14. `web/app/chat/group/[id]/page.tsx`
15. `web/components/contacts/contacts-table.tsx`

---

## 🎯 修复方案

### 后端修复方案

```typescript
// ❌ 旧代码
throw new Error('Campaign runner needs refactoring for multi-account support');

// ✅ 新代码
async function executeCampaign(
  campaignId: string, 
  whatsappService: WPPConnectService  // 添加参数
) {
  // 使用传入的 whatsappService 实例
  await whatsappService.sendTextMessage(...);
}
```

### 前端修复方案

#### A. 修复 `api.getStatus()`
```typescript
// ❌ 旧代码
const status = await api.getStatus();

// ✅ 新代码
const { currentAccountId } = useAccount();
if (!currentAccountId) {
  // 处理未选择账号的情况
  return;
}
const status = await api.accounts.getStatus(currentAccountId);
```

#### B. 修复 `api.getContacts()`
```typescript
// ❌ 旧代码
const contacts = await api.getContacts();

// ✅ 新代码
const { currentAccountId } = useAccount();
if (!currentAccountId) {
  // 处理未选择账号的情况
  return;
}
const contacts = await api.contacts.list(currentAccountId);
```
