# WhatsApp AI 自动回复工具 - 最终配置指南

## 🎯 项目状态

项目已成功实现了所有核心功能，包括：
- ✅ 后端API完整实现
- ✅ 前端管理界面完整
- ✅ WhatsApp集成正常工作
- ✅ 数据库模型完整
- ✅ AI自动回复管道实现
- ✅ CORS配置完成

## 🚀 快速启动步骤

### 1. 环境准备
确保已安装：
- Node.js 18+
- npm

### 2. 配置环境变量
项目根目录的 `.env` 文件应包含：
```env
NODE_ENV=development
DATABASE_URL=file:./dev.db
DEEPSEEK_API_KEY=sk-xxxx
DEEPSEEK_MODEL=deepseek-chat
SESSION_PATH=./.session
PORT=4000
COOLDOWN_HOURS=24
PER_CONTACT_REPLY_COOLDOWN=10
API_TOKEN=change-me
BANNED_KEYWORDS=退款,投诉,敏感词

NEXT_PUBLIC_API_BASE_URL=http://localhost:4000
NEXT_PUBLIC_API_TOKEN=change-me
```

### 3. 启动后端服务器
```bash
# 在项目根目录
npm install
npx prisma generate
npx prisma db push
npm run build
npm run dev
```

后端将运行在：`http://localhost:4000`

### 4. 启动前端服务器
```bash
# 在新的终端窗口
cd web
npm install

# 创建前端环境变量
echo "NEXT_PUBLIC_API_BASE_URL=http://localhost:4000" > .env.local
echo "NEXT_PUBLIC_API_TOKEN=change-me" >> .env.local

npm run dev
```

前端将运行在：`http://localhost:3000` 或 `http://localhost:3001`

## 🔧 使用流程

### 1. WhatsApp 扫码登录
- 访问前端Dashboard页面
- 查看二维码
- 使用WhatsApp手机版扫码登录

### 2. 添加联系人
- 进入Contacts页面
- 点击"Add Contact"按钮
- 输入E.164格式的手机号（如：+8613800138000）
- 输入联系人姓名（可选）

### 3. 发送首发消息
- 在联系人列表中点击"Outreach"按钮
- 输入首发消息内容
- 发送后，该联系人进入24小时冷却期

### 4. 自动回复管理
- 对方回复后，系统自动启用AI回复
- 在Threads页面查看对话
- 可以使用"Takeover"人工接管，或"Release"释放给AI

## ⚙️ 重要配置说明

### 冷却机制
- **联系人冷却**：24小时内只能发一次首发消息
- **回复冷却**：每个联系人10分钟内不会重复自动回复

### AI回复顺序
1. 关键词规则匹配（快速响应常见问题）
2. DeepSeek API调用（智能回复）
3. 兜底话术（"我记录下来了，会尽快回复你"）

### 安全措施
- API请求需要Bearer Token认证
- 违禁词自动过滤
- 所有消息记录入库

## 🐛 故障排除

### 1. CORS错误
如果前端显示CORS错误：
- 确保后端包含 `@fastify/cors` 包
- 检查后端服务器是否在4000端口运行
- 重启后端服务器

### 2. 401 Unauthorized
- 检查前端 `.env.local` 文件中的 `NEXT_PUBLIC_API_TOKEN`
- 确保与后端 `.env` 中的 `API_TOKEN` 一致
- 重启前端服务器

### 3. WhatsApp连接问题
- 检查 `.session` 目录权限
- 尝试删除 `.session` 目录重新扫码
- 确保网络连接正常

### 4. 端口占用
- 使用 `netstat -an | findstr :4000` 检查后端端口
- 使用 `netstat -an | findstr :3000` 检查前端端口
- 如需更改端口，同时修改后端和前端配置

## 📁 项目结构

```
项目根目录/
├── app/src/          # 后端TypeScript源码
├── web/              # 前端Next.js应用
├── prisma/           # 数据库模型和迁移
├── .env              # 后端环境变量
├── web/.env.local    # 前端环境变量
└── dev.db           # SQLite数据库文件
```

## 🎉 验收完成

项目已完全按照design.md实现，所有功能正常运行：
- WhatsApp扫码登录 ✅
- 联系人管理 ✅  
- 首发消息冷却 ✅
- AI自动回复 ✅
- 管理台界面 ✅
- 人工接管/释放 ✅

如需技术支持，请参考 `completion_report.md` 获取详细的实现说明。
