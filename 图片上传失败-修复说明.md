# ğŸ“¤ å›¾ç‰‡ä¸Šä¼ å¤±è´¥ - ä¿®å¤è¯´æ˜

> ä¿®å¤ POST /media/upload è¿”å› 400 Bad Request çš„é—®é¢˜

---

## ğŸ› é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯ï¼š**
```
POST http://localhost:4000/media/upload 400 (Bad Request)
âŒ ä¸Šä¼ å¤±è´¥: Error: ä¸Šä¼ å¤±è´¥: Bad Request
```

**è¡¨ç°ï¼š**
- ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æŒ‰é’®
- é€‰æ‹©å›¾ç‰‡æ–‡ä»¶
- æ˜¾ç¤º"ä¸Šä¼ å¤±è´¥"é”™è¯¯
- åç«¯è¿”å› 400 Bad Request

---

## ğŸ” å¯èƒ½çš„åŸå› 

### åŸå›  1ï¼šç¼ºå°‘ X-Account-Id è¯·æ±‚å¤´ âœ… å·²ä¿®å¤

**é—®é¢˜ï¼š** å‰ç«¯ä½¿ç”¨ XMLHttpRequest ä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œæ²¡æœ‰æ·»åŠ  `X-Account-Id` è¯·æ±‚å¤´ã€‚

**ä¿®å¤ï¼š** åœ¨ `web/lib/api.ts` ä¸­æ·»åŠ äº†è´¦å· ID å¤´éƒ¨ï¼š

```typescript
// ğŸ”¥ æ·»åŠ è´¦å· ID å¤´éƒ¨ï¼ˆä¸ apiFetch ä¿æŒä¸€è‡´ï¼‰
try {
  const currentAccountId = localStorage.getItem('whatsapp_current_account_id');
  if (currentAccountId) {
    xhr.setRequestHeader('X-Account-Id', currentAccountId);
  }
} catch (error) {
  console.warn('Cannot access localStorage:', error);
}
```

### åŸå›  2ï¼šåç«¯æ—¥å¿—ä¸è¶³ âœ… å·²ä¿®å¤

**é—®é¢˜ï¼š** åç«¯æ²¡æœ‰è¯¦ç»†çš„æ—¥å¿—ï¼Œæ— æ³•è¯Šæ–­é—®é¢˜ã€‚

**ä¿®å¤ï¼š** åœ¨ `server/app/src/routes/media.ts` ä¸­æ·»åŠ äº†è¯¦ç»†æ—¥å¿—ï¼š

```typescript
console.log('ğŸ“¤ æ”¶åˆ°æ–‡ä»¶ä¸Šä¼ è¯·æ±‚');
console.log('Content-Type:', request.headers['content-type']);
console.log('X-Account-Id:', request.headers['x-account-id']);

const data = await request.file();

console.log('æ–‡ä»¶æ•°æ®:', data ? 'æ¥æ”¶åˆ°æ–‡ä»¶' : 'æœªæ¥æ”¶åˆ°æ–‡ä»¶');
if (data) {
  console.log('æ–‡ä»¶å:', data.filename);
  console.log('MIMEç±»å‹:', data.mimetype);
  console.log('å­—æ®µå:', data.fieldname);
}
```

---

## âœ… ä¿®å¤æ­¥éª¤

### 1. ç¼–è¯‘åç«¯ä»£ç 

```bash
cd server
npm run build
```

### 2. é‡å¯åç«¯æœåŠ¡

åœæ­¢å¹¶é‡æ–°å¯åŠ¨åç«¯

### 3. åˆ·æ–°å‰ç«¯é¡µé¢

åˆ·æ–°æµè§ˆå™¨ï¼ˆCtrl + F5ï¼‰

### 4. æµ‹è¯•ä¸Šä¼ 

1. è¿›å…¥å¯¹è¯é¡µé¢
2. ç‚¹å‡» ğŸ“ æŒ‰é’®
3. é€‰æ‹©å›¾ç‰‡æ–‡ä»¶
4. æŸ¥çœ‹æ˜¯å¦æˆåŠŸä¸Šä¼ 

### 5. æŸ¥çœ‹åç«¯æ—¥å¿—

å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼ŒæŸ¥çœ‹åç«¯æ—¥å¿—ï¼š

**åº”è¯¥çœ‹åˆ°ï¼š**
```
ğŸ“¤ æ”¶åˆ°æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary...
X-Account-Id: cxxxxxxxx
æ–‡ä»¶æ•°æ®: æ¥æ”¶åˆ°æ–‡ä»¶
æ–‡ä»¶å: image.jpg
MIMEç±»å‹: image/jpeg
å­—æ®µå: file
ğŸ“¤ å¼€å§‹æµå¼ä¸Šä¼ æ–‡ä»¶: image.jpg -> 1234567890-abcdef.jpg
âœ… æ–‡ä»¶å†™å…¥å®Œæˆ: 1234567890-abcdef.jpg
âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: 1234567890-abcdef.jpg
```

**å¦‚æœçœ‹åˆ°ï¼š**
```
ğŸ“¤ æ”¶åˆ°æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary...
X-Account-Id: cxxxxxxxx
æ–‡ä»¶æ•°æ®: æœªæ¥æ”¶åˆ°æ–‡ä»¶
âŒ æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶
```

è¯´æ˜åç«¯æ— æ³•è§£ææ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ä»¥ä¸‹åŸå› ä¹‹ä¸€ã€‚

---

## ğŸ”§ è¿›ä¸€æ­¥è¯Šæ–­

### å¦‚æœåç«¯æ—¥å¿—æ˜¾ç¤º"æœªæ¥æ”¶åˆ°æ–‡ä»¶"

#### æ£€æŸ¥ 1ï¼šMultipart æ’ä»¶æ˜¯å¦æ­£ç¡®æ³¨å†Œ

æŸ¥çœ‹ `server/app/src/server.ts`ï¼š

```typescript
await app.register(require('@fastify/multipart'), {
  limits: {
    fileSize: Infinity,
    files: 1,
  },
});
```

âœ… å·²ç¡®è®¤æ­£ç¡®æ³¨å†Œ

#### æ£€æŸ¥ 2ï¼šFormData å­—æ®µåæ˜¯å¦æ­£ç¡®

å‰ç«¯ï¼š
```typescript
formData.append('file', file);
```

åç«¯æœŸæœ›ï¼š
```typescript
const data = await request.file();
// data.fieldname åº”è¯¥æ˜¯ 'file'
```

âœ… å·²ç¡®è®¤å­—æ®µåä¸€è‡´

#### æ£€æŸ¥ 3ï¼šContent-Type æ˜¯å¦æ­£ç¡®

æµè§ˆå™¨åº”è¯¥è‡ªåŠ¨è®¾ç½®ï¼š
```
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary...
```

â— **ä¸è¦æ‰‹åŠ¨è®¾ç½® Content-Type**ï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®ï¼ˆåŒ…æ‹¬ boundaryï¼‰

#### æ£€æŸ¥ 4ï¼šæ˜¯å¦æœ‰å…¶ä»–ä¸­é—´ä»¶å¹²æ‰°

ç¡®è®¤æ²¡æœ‰å…¶ä»–ä¸­é—´ä»¶æ‹¦æˆªæˆ–ä¿®æ”¹è¯·æ±‚ä½“ã€‚

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `web/lib/api.ts`

**ä¿®æ”¹å†…å®¹ï¼š** æ·»åŠ  X-Account-Id è¯·æ±‚å¤´

```diff
  xhr.open('POST', `${API_BASE_URL}/media/upload`);
  if (API_TOKEN) {
    xhr.setRequestHeader('Authorization', `Bearer ${API_TOKEN}`);
  }
  
+ // ğŸ”¥ æ·»åŠ è´¦å· ID å¤´éƒ¨ï¼ˆä¸ apiFetch ä¿æŒä¸€è‡´ï¼‰
+ try {
+   const currentAccountId = localStorage.getItem('whatsapp_current_account_id');
+   if (currentAccountId) {
+     xhr.setRequestHeader('X-Account-Id', currentAccountId);
+   }
+ } catch (error) {
+   console.warn('Cannot access localStorage:', error);
+ }
  
  xhr.send(formData);
```

### 2. `server/app/src/routes/media.ts`

**ä¿®æ”¹å†…å®¹ï¼š** æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

```diff
  fastify.post('/media/upload', async (request, reply) => {
    try {
+     console.log('ğŸ“¤ æ”¶åˆ°æ–‡ä»¶ä¸Šä¼ è¯·æ±‚');
+     console.log('Content-Type:', request.headers['content-type']);
+     console.log('X-Account-Id:', request.headers['x-account-id']);
+     
      const data = await request.file();
      
+     console.log('æ–‡ä»¶æ•°æ®:', data ? 'æ¥æ”¶åˆ°æ–‡ä»¶' : 'æœªæ¥æ”¶åˆ°æ–‡ä»¶');
+     if (data) {
+       console.log('æ–‡ä»¶å:', data.filename);
+       console.log('MIMEç±»å‹:', data.mimetype);
+       console.log('å­—æ®µå:', data.fieldname);
+     }
      
      if (!data) {
+       console.error('âŒ æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶');
        return reply.code(400).send({
          ok: false,
          code: 'NO_FILE',
          message: 'æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶',
        });
      }

      const result = await mediaService.handleFileUpload(data);
+     
+     console.log('âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', result.fileName);

      return reply.send({
        ok: true,
        data: result,
      });
    } catch (error: any) {
-     console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
+     console.error('âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
+     console.error('é”™è¯¯å †æ ˆ:', error.stack);
      return reply.code(500).send({
        ok: false,
        code: 'UPLOAD_FAILED',
        message: error.message || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥',
      });
    }
  });
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šä¸Šä¼ å›¾ç‰‡

1. é€‰æ‹© JPG/PNG å›¾ç‰‡
2. ç‚¹å‡»ä¸Šä¼ 
3. åº”è¯¥æˆåŠŸä¸Šä¼ 

### åœºæ™¯ 2ï¼šä¸Šä¼ è§†é¢‘

1. é€‰æ‹© MP4 è§†é¢‘
2. ç‚¹å‡»ä¸Šä¼ 
3. åº”è¯¥æˆåŠŸä¸Šä¼ 

### åœºæ™¯ 3ï¼šä¸Šä¼ æ–‡æ¡£

1. é€‰æ‹© PDF/Word æ–‡æ¡£
2. ç‚¹å‡»ä¸Šä¼ 
3. åº”è¯¥æˆåŠŸä¸Šä¼ 

### åœºæ™¯ 4ï¼šå¤§æ–‡ä»¶ä¸Šä¼ 

1. é€‰æ‹©è¶…è¿‡ 10MB çš„æ–‡ä»¶
2. ç‚¹å‡»ä¸Šä¼ 
3. åº”è¯¥çœ‹åˆ°ä¸Šä¼ è¿›åº¦æ¡
4. åº”è¯¥æˆåŠŸä¸Šä¼ 

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šè¿˜æ˜¯è¿”å› 400

**æ£€æŸ¥ï¼š**
1. åç«¯æ˜¯å¦å·²é‡å¯
2. å‰ç«¯æ˜¯å¦å·²åˆ·æ–°
3. æŸ¥çœ‹åç«¯æ—¥å¿—è¾“å‡ºä»€ä¹ˆ

### é—®é¢˜ 2ï¼šè¿”å› 500 é”™è¯¯

**å¯èƒ½åŸå› ï¼š**
- ä¸Šä¼ ç›®å½•ä¸å­˜åœ¨
- ç£ç›˜ç©ºé—´ä¸è¶³
- æ–‡ä»¶æƒé™é—®é¢˜

**æ£€æŸ¥ï¼š**
```bash
# ç¡®è®¤ä¸Šä¼ ç›®å½•å­˜åœ¨
ls -la server/uploads/

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥ç›®å½•æƒé™
ls -ld server/uploads/
```

### é—®é¢˜ 3ï¼šä¸Šä¼ æˆåŠŸä½†æ— æ³•æ˜¾ç¤º

**å¯èƒ½åŸå› ï¼š**
- mediaUrl è·¯å¾„é”™è¯¯
- æ–‡ä»¶æœªæ­£ç¡®ä¿å­˜

**æ£€æŸ¥ï¼š**
```bash
# æŸ¥çœ‹ä¸Šä¼ çš„æ–‡ä»¶
ls -la server/uploads/

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼æ–‡ä»¶ï¼š
# 1234567890-abcdef.jpg
```

---

## ğŸ“Š å®Œæ•´çš„ä¸Šä¼ æµç¨‹

### å‰ç«¯æµç¨‹

```
ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
  â†“
åˆ›å»º FormData
  â†“
formData.append('file', file)
  â†“
XMLHttpRequest.open('POST', '/media/upload')
  â†“
è®¾ç½® Authorization å¤´éƒ¨ï¼ˆå¦‚æœæœ‰ tokenï¼‰
  â†“
è®¾ç½® X-Account-Id å¤´éƒ¨ âœ… NEW
  â†“
xhr.send(formData)
  â†“
ç›‘å¬ progress äº‹ä»¶ï¼ˆæ˜¾ç¤ºè¿›åº¦æ¡ï¼‰
  â†“
æ¥æ”¶å“åº” { ok: true, data: { ... } }
  â†“
è·å– mediaUrl, mediaFileName ç­‰
  â†“
ä¿å­˜åˆ°æ¶ˆæ¯æ•°æ®åº“
  â†“
å‰ç«¯æ˜¾ç¤ºé¢„è§ˆ
```

### åç«¯æµç¨‹

```
æ”¶åˆ° POST /media/upload è¯·æ±‚
  â†“
æ‰“å°æ—¥å¿—ï¼ˆContent-Type, X-Account-Idï¼‰âœ… NEW
  â†“
è°ƒç”¨ request.file() è§£ææ–‡ä»¶
  â†“
æ£€æŸ¥ data æ˜¯å¦ä¸ºç©º
  â†“
å¦‚æœä¸ºç©º â†’ è¿”å› 400 âŒ
  â†“
å¦‚æœä¸ä¸ºç©º â†’ ç»§ç»­å¤„ç†
  â†“
è°ƒç”¨ mediaService.handleFileUpload(data)
  â†“
ç”Ÿæˆå®‰å…¨æ–‡ä»¶å
  â†“
æµå¼å†™å…¥æ–‡ä»¶åˆ° uploads/ ç›®å½•
  â†“
ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆå¦‚æœæ˜¯å›¾ç‰‡ï¼‰
  â†“
è¿”å› { mediaUrl, mediaFileName, ... }
  â†“
å‰ç«¯æ¥æ”¶å¹¶ä¿å­˜ âœ…
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **ç¼–è¯‘åç«¯ä»£ç **
   ```bash
   cd server
   npm run build
   ```

2. **é‡å¯åç«¯æœåŠ¡**

3. **åˆ·æ–°å‰ç«¯é¡µé¢**

4. **æµ‹è¯•ä¸Šä¼ å›¾ç‰‡**
   - é€‰æ‹©å›¾ç‰‡
   - ç‚¹å‡»ä¸Šä¼ 
   - æŸ¥çœ‹åç«¯æ—¥å¿—

5. **æ ¹æ®æ—¥å¿—è¯Šæ–­**
   - å¦‚æœçœ‹åˆ°"æ¥æ”¶åˆ°æ–‡ä»¶" â†’ ç»§ç»­æŸ¥çœ‹åç»­æ—¥å¿—
   - å¦‚æœçœ‹åˆ°"æœªæ¥æ”¶åˆ°æ–‡ä»¶" â†’ å‚è€ƒ"è¿›ä¸€æ­¥è¯Šæ–­"éƒ¨åˆ†

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **åç«¯æ—¥å¿—**ï¼ˆä»"ğŸ“¤ æ”¶åˆ°æ–‡ä»¶ä¸Šä¼ è¯·æ±‚"å¼€å§‹ï¼‰
2. **å‰ç«¯æ§åˆ¶å°æ—¥å¿—**
3. **é€‰æ‹©çš„æ–‡ä»¶ç±»å‹å’Œå¤§å°**
4. **æµè§ˆå™¨ç±»å‹å’Œç‰ˆæœ¬**

---

## ğŸ“… ç‰ˆæœ¬ä¿¡æ¯

- **é—®é¢˜ï¼š** POST /media/upload 400 Bad Request
- **ä¿®å¤æ—¥æœŸï¼š** 2025-10-11
- **ä¿®æ”¹æ–‡ä»¶ï¼š**
  - `web/lib/api.ts` - æ·»åŠ  X-Account-Id å¤´éƒ¨
  - `server/app/src/routes/media.ts` - æ·»åŠ è¯¦ç»†æ—¥å¿—
- **çŠ¶æ€ï¼š** ğŸ” å¾…æµ‹è¯•

---

**è¯·ç¼–è¯‘åç«¯å¹¶é‡æ–°æµ‹è¯•ï¼ŒæŸ¥çœ‹åç«¯æ—¥å¿—è¾“å‡ºï¼** ğŸš€

