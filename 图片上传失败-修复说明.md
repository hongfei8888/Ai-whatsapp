# 📤 图片上传失败 - 修复说明

> 修复 POST /media/upload 返回 400 Bad Request 的问题

---

## 🐛 问题描述

**错误信息：**
```
POST http://localhost:4000/media/upload 400 (Bad Request)
❌ 上传失败: Error: 上传失败: Bad Request
```

**表现：**
- 点击上传图片按钮
- 选择图片文件
- 显示"上传失败"错误
- 后端返回 400 Bad Request

---

## 🔍 可能的原因

### 原因 1：缺少 X-Account-Id 请求头 ✅ 已修复

**问题：** 前端使用 XMLHttpRequest 上传文件时，没有添加 `X-Account-Id` 请求头。

**修复：** 在 `web/lib/api.ts` 中添加了账号 ID 头部：

```typescript
// 🔥 添加账号 ID 头部（与 apiFetch 保持一致）
try {
  const currentAccountId = localStorage.getItem('whatsapp_current_account_id');
  if (currentAccountId) {
    xhr.setRequestHeader('X-Account-Id', currentAccountId);
  }
} catch (error) {
  console.warn('Cannot access localStorage:', error);
}
```

### 原因 2：后端日志不足 ✅ 已修复

**问题：** 后端没有详细的日志，无法诊断问题。

**修复：** 在 `server/app/src/routes/media.ts` 中添加了详细日志：

```typescript
console.log('📤 收到文件上传请求');
console.log('Content-Type:', request.headers['content-type']);
console.log('X-Account-Id:', request.headers['x-account-id']);

const data = await request.file();

console.log('文件数据:', data ? '接收到文件' : '未接收到文件');
if (data) {
  console.log('文件名:', data.filename);
  console.log('MIME类型:', data.mimetype);
  console.log('字段名:', data.fieldname);
}
```

---

## ✅ 修复步骤

### 1. 编译后端代码

```bash
cd server
npm run build
```

### 2. 重启后端服务

停止并重新启动后端

### 3. 刷新前端页面

刷新浏览器（Ctrl + F5）

### 4. 测试上传

1. 进入对话页面
2. 点击 📎 按钮
3. 选择图片文件
4. 查看是否成功上传

### 5. 查看后端日志

如果还是失败，查看后端日志：

**应该看到：**
```
📤 收到文件上传请求
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary...
X-Account-Id: cxxxxxxxx
文件数据: 接收到文件
文件名: image.jpg
MIME类型: image/jpeg
字段名: file
📤 开始流式上传文件: image.jpg -> 1234567890-abcdef.jpg
✅ 文件写入完成: 1234567890-abcdef.jpg
✅ 文件上传成功: 1234567890-abcdef.jpg
```

**如果看到：**
```
📤 收到文件上传请求
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary...
X-Account-Id: cxxxxxxxx
文件数据: 未接收到文件
❌ 没有上传文件
```

说明后端无法解析文件，可能是以下原因之一。

---

## 🔧 进一步诊断

### 如果后端日志显示"未接收到文件"

#### 检查 1：Multipart 插件是否正确注册

查看 `server/app/src/server.ts`：

```typescript
await app.register(require('@fastify/multipart'), {
  limits: {
    fileSize: Infinity,
    files: 1,
  },
});
```

✅ 已确认正确注册

#### 检查 2：FormData 字段名是否正确

前端：
```typescript
formData.append('file', file);
```

后端期望：
```typescript
const data = await request.file();
// data.fieldname 应该是 'file'
```

✅ 已确认字段名一致

#### 检查 3：Content-Type 是否正确

浏览器应该自动设置：
```
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary...
```

❗ **不要手动设置 Content-Type**，让浏览器自动设置（包括 boundary）

#### 检查 4：是否有其他中间件干扰

确认没有其他中间件拦截或修改请求体。

---

## 📝 修改的文件

### 1. `web/lib/api.ts`

**修改内容：** 添加 X-Account-Id 请求头

```diff
  xhr.open('POST', `${API_BASE_URL}/media/upload`);
  if (API_TOKEN) {
    xhr.setRequestHeader('Authorization', `Bearer ${API_TOKEN}`);
  }
  
+ // 🔥 添加账号 ID 头部（与 apiFetch 保持一致）
+ try {
+   const currentAccountId = localStorage.getItem('whatsapp_current_account_id');
+   if (currentAccountId) {
+     xhr.setRequestHeader('X-Account-Id', currentAccountId);
+   }
+ } catch (error) {
+   console.warn('Cannot access localStorage:', error);
+ }
  
  xhr.send(formData);
```

### 2. `server/app/src/routes/media.ts`

**修改内容：** 添加详细的调试日志

```diff
  fastify.post('/media/upload', async (request, reply) => {
    try {
+     console.log('📤 收到文件上传请求');
+     console.log('Content-Type:', request.headers['content-type']);
+     console.log('X-Account-Id:', request.headers['x-account-id']);
+     
      const data = await request.file();
      
+     console.log('文件数据:', data ? '接收到文件' : '未接收到文件');
+     if (data) {
+       console.log('文件名:', data.filename);
+       console.log('MIME类型:', data.mimetype);
+       console.log('字段名:', data.fieldname);
+     }
      
      if (!data) {
+       console.error('❌ 没有上传文件');
        return reply.code(400).send({
          ok: false,
          code: 'NO_FILE',
          message: '没有上传文件',
        });
      }

      const result = await mediaService.handleFileUpload(data);
+     
+     console.log('✅ 文件上传成功:', result.fileName);

      return reply.send({
        ok: true,
        data: result,
      });
    } catch (error: any) {
-     console.error('文件上传失败:', error);
+     console.error('❌ 文件上传失败:', error);
+     console.error('错误堆栈:', error.stack);
      return reply.code(500).send({
        ok: false,
        code: 'UPLOAD_FAILED',
        message: error.message || '文件上传失败',
      });
    }
  });
```

---

## 🧪 测试场景

### 场景 1：上传图片

1. 选择 JPG/PNG 图片
2. 点击上传
3. 应该成功上传

### 场景 2：上传视频

1. 选择 MP4 视频
2. 点击上传
3. 应该成功上传

### 场景 3：上传文档

1. 选择 PDF/Word 文档
2. 点击上传
3. 应该成功上传

### 场景 4：大文件上传

1. 选择超过 10MB 的文件
2. 点击上传
3. 应该看到上传进度条
4. 应该成功上传

---

## 🐛 常见问题

### 问题 1：还是返回 400

**检查：**
1. 后端是否已重启
2. 前端是否已刷新
3. 查看后端日志输出什么

### 问题 2：返回 500 错误

**可能原因：**
- 上传目录不存在
- 磁盘空间不足
- 文件权限问题

**检查：**
```bash
# 确认上传目录存在
ls -la server/uploads/

# 检查磁盘空间
df -h

# 检查目录权限
ls -ld server/uploads/
```

### 问题 3：上传成功但无法显示

**可能原因：**
- mediaUrl 路径错误
- 文件未正确保存

**检查：**
```bash
# 查看上传的文件
ls -la server/uploads/

# 应该看到类似文件：
# 1234567890-abcdef.jpg
```

---

## 📊 完整的上传流程

### 前端流程

```
用户选择文件
  ↓
创建 FormData
  ↓
formData.append('file', file)
  ↓
XMLHttpRequest.open('POST', '/media/upload')
  ↓
设置 Authorization 头部（如果有 token）
  ↓
设置 X-Account-Id 头部 ✅ NEW
  ↓
xhr.send(formData)
  ↓
监听 progress 事件（显示进度条）
  ↓
接收响应 { ok: true, data: { ... } }
  ↓
获取 mediaUrl, mediaFileName 等
  ↓
保存到消息数据库
  ↓
前端显示预览
```

### 后端流程

```
收到 POST /media/upload 请求
  ↓
打印日志（Content-Type, X-Account-Id）✅ NEW
  ↓
调用 request.file() 解析文件
  ↓
检查 data 是否为空
  ↓
如果为空 → 返回 400 ❌
  ↓
如果不为空 → 继续处理
  ↓
调用 mediaService.handleFileUpload(data)
  ↓
生成安全文件名
  ↓
流式写入文件到 uploads/ 目录
  ↓
生成缩略图（如果是图片）
  ↓
返回 { mediaUrl, mediaFileName, ... }
  ↓
前端接收并保存 ✅
```

---

## 🚀 下一步

1. **编译后端代码**
   ```bash
   cd server
   npm run build
   ```

2. **重启后端服务**

3. **刷新前端页面**

4. **测试上传图片**
   - 选择图片
   - 点击上传
   - 查看后端日志

5. **根据日志诊断**
   - 如果看到"接收到文件" → 继续查看后续日志
   - 如果看到"未接收到文件" → 参考"进一步诊断"部分

---

## 📞 需要帮助？

提供以下信息：

1. **后端日志**（从"📤 收到文件上传请求"开始）
2. **前端控制台日志**
3. **选择的文件类型和大小**
4. **浏览器类型和版本**

---

## 📅 版本信息

- **问题：** POST /media/upload 400 Bad Request
- **修复日期：** 2025-10-11
- **修改文件：**
  - `web/lib/api.ts` - 添加 X-Account-Id 头部
  - `server/app/src/routes/media.ts` - 添加详细日志
- **状态：** 🔍 待测试

---

**请编译后端并重新测试，查看后端日志输出！** 🚀

