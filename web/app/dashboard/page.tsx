'use client';

import { useState, useEffect, useMemo } from 'react';
import { api } from '@/lib/api';
import QRCodeDialog from '@/components/QRCodeDialog';

// Á±ªÂûãÂÆö‰πâ
interface ButtonProps {
  kind?: 'primary' | 'secondary' | 'ghost';
  children: React.ReactNode;
  onClick?: () => void;
  style?: React.CSSProperties;
  [key: string]: any;
}

interface CardProps {
  children: React.ReactNode;
  style?: React.CSSProperties;
  hoverable?: boolean;
  [key: string]: any;
}

interface TagProps {
  text: string;
  tone?: 'success' | 'warn' | 'error' | 'info';
  style?: React.CSSProperties;
}

interface StatProps {
  label: string;
  value: string | number;
  hint: string;
  color?: string;
}

interface RowProps {
  contact: string;
  messages: number;
  lastActive: string;
  status: React.ReactNode;
  onClick?: () => void;
}

interface ItemProps {
  label: string;
  value: string | number;
  style?: React.CSSProperties;
}

// ÂÜÖËÅîÊ†∑ÂºèÂ∞èÁªÑ‰ª∂
const Button = ({ kind = 'secondary', children, onClick, style = {}, ...props }: ButtonProps) => {
  const baseStyle = {
    padding: '8px 16px',
    borderRadius: '8px',
    border: 'none',
    cursor: 'pointer',
    fontSize: '14px',
    fontWeight: '500',
    fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif',
    transition: 'all 0.2s ease',
    display: 'inline-flex',
    alignItems: 'center',
    gap: '6px',
    ...style
  };

  const kindStyles = {
    primary: {
      backgroundColor: '#4F46E5',
      color: '#FFFFFF',
      boxShadow: '0 1px 2px rgba(0,0,0,.06)',
    },
    secondary: {
      backgroundColor: '#FFFFFF',
      color: '#374151',
      border: '1px solid #E5E7EB',
      boxShadow: '0 1px 2px rgba(0,0,0,.06)',
    },
    ghost: {
      backgroundColor: 'transparent',
      color: '#6B7280',
      border: 'none',
    }
  };

  const hoverStyle = {
    ...baseStyle,
    ...kindStyles[kind],
    transform: 'translateY(-1px)',
    boxShadow: kind === 'ghost' ? 'none' : '0 8px 24px rgba(0,0,0,.08)',
    backgroundColor: kind === 'primary' ? '#3730A3' : 
                   kind === 'secondary' ? '#F9FAFB' : 
                   'rgba(79, 70, 229, 0.1)'
  };

  const [currentStyle, setCurrentStyle] = useState({ ...baseStyle, ...kindStyles[kind] });

  return (
    <button
      style={currentStyle}
      onMouseEnter={() => setCurrentStyle(hoverStyle)}
      onMouseLeave={() => setCurrentStyle({ ...baseStyle, ...kindStyles[kind] })}
      onClick={onClick}
      {...props}
    >
      {children}
    </button>
  );
};

const Card = ({ children, style = {}, hoverable = false, ...props }: CardProps) => {
  const baseStyle = {
    backgroundColor: '#FFFFFF',
    borderRadius: '16px',
    border: '1px solid #E5E7EB',
    boxShadow: '0 1px 2px rgba(0,0,0,.06)',
    padding: '24px',
    transition: 'all 0.2s ease',
    ...style
  };

  const hoverStyle = hoverable ? {
    ...baseStyle,
    transform: 'translateY(-2px)',
    boxShadow: '0 8px 24px rgba(0,0,0,.08)'
  } : baseStyle;

  const [currentStyle, setCurrentStyle] = useState(baseStyle);

  return (
    <div
      style={currentStyle}
      onMouseEnter={() => hoverable && setCurrentStyle(hoverStyle)}
      onMouseLeave={() => hoverable && setCurrentStyle(baseStyle)}
      {...props}
    >
      {children}
    </div>
  );
};

const Tag = ({ text, tone = 'info', style = {} }: TagProps) => {
  const toneStyles = {
    success: { backgroundColor: 'rgba(5, 150, 105, 0.1)', color: '#059669', border: '1px solid #059669' },
    warn: { backgroundColor: 'rgba(180, 83, 9, 0.1)', color: '#B45309', border: '1px solid #B45309' },
    error: { backgroundColor: 'rgba(220, 38, 38, 0.1)', color: '#DC2626', border: '1px solid #DC2626' },
    info: { backgroundColor: 'rgba(37, 99, 235, 0.1)', color: '#2563EB', border: '1px solid #2563EB' }
  };

  return (
    <span
      style={{
        padding: '4px 8px',
        borderRadius: '6px',
        fontSize: '12px',
        fontWeight: '500',
        fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif',
        ...toneStyles[tone],
        ...style
      }}
    >
      {text}
    </span>
  );
};

const Stat = ({ label, value, hint, color = '#4F46E5' }: StatProps) => (
  <div style={{ textAlign: 'center' }}>
    <div
      style={{
        fontSize: '28px',
        fontWeight: '600',
        color: color,
        fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif',
        lineHeight: '1.2',
        marginBottom: '4px'
      }}
    >
      {value}
    </div>
    <div
      style={{
        fontSize: '14px',
        fontWeight: '500',
        color: '#111827',
        fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif',
        marginBottom: '2px'
      }}
    >
      {label}
    </div>
    <div
      style={{
        fontSize: '12px',
        color: '#6B7280',
        fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif'
      }}
    >
      {hint}
    </div>
  </div>
);

const Row = ({ contact, messages, lastActive, status, onClick }: RowProps) => (
  <div
    style={{
      padding: '12px',
      borderRadius: '12px',
      border: '1px solid #E5E7EB',
      marginBottom: '8px',
      cursor: 'pointer',
      transition: 'all 0.2s ease',
      backgroundColor: '#FFFFFF'
    }}
    onMouseEnter={(e) => {
      e.currentTarget.style.backgroundColor = '#F8FAFF';
      e.currentTarget.style.borderColor = '#4F46E5';
    }}
    onMouseLeave={(e) => {
      e.currentTarget.style.backgroundColor = '#FFFFFF';
      e.currentTarget.style.borderColor = '#E5E7EB';
    }}
    onClick={onClick}
  >
    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
      <div>
        <div
          style={{
            fontSize: '14px',
            fontWeight: '500',
            color: '#111827',
            fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif',
            marginBottom: '2px'
          }}
        >
          {contact}
        </div>
        <div
          style={{
            fontSize: '12px',
            color: '#6B7280',
            fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif'
          }}
        >
          {messages} Êù°Ê∂àÊÅØ ¬∑ {lastActive}
        </div>
      </div>
      <div>{status}</div>
    </div>
  </div>
);

const Item = ({ label, value, style = {} }: ItemProps) => (
  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px', ...style }}>
    <span
      style={{
        fontSize: '14px',
        color: '#6B7280',
        fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif'
      }}
    >
      {label}
    </span>
    <span
      style={{
        fontSize: '14px',
        fontWeight: '500',
        color: '#111827',
        fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif'
      }}
    >
      {value}
    </span>
  </div>
);

// Ê†∑ÂºèÂ≠óÂÖ∏
const S = {
  pageHeader: { 
    display: "flex", alignItems: "center", justifyContent: "space-between",
    margin: "16px 0 12px 0" 
  },
  titleWrap: { display: "flex", flexDirection: "column" as const },
  title: { fontSize: 22, fontWeight: 600, letterSpacing: "-0.01em", color: "#0f172a", margin: 0 },
  sub: { fontSize: 13, color: "#667085", marginTop: 4 },
  actionRow: { display: "flex", alignItems: "center", gap: 8 },
  smallBtn: {
    height: 32, padding: "0 10px", borderRadius: 8,
    background: "#fff", border: "1px solid rgba(0,0,0,0.08)", cursor: "pointer",
    fontSize: 14, color: "#374151", transition: "all 0.2s ease"
  }
};

// Dashboard È°µÂÜÖÊ†áÈ¢ò‰∏éÊìç‰ΩúÊåâÈíÆË°å
function PageHeader({ 
  onRefresh, 
  onAddAccount, 
  onLogout 
}: { 
  onRefresh: () => void;
  onAddAccount: () => void;
  onLogout: () => void;
}) {
  const handleBtnHover = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.currentTarget.style.background = "#f8fafc";
    e.currentTarget.style.borderColor = "#4f46e5";
    e.currentTarget.style.transform = "translateY(-1px)";
  };

  const handleBtnLeave = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.currentTarget.style.background = "#fff";
    e.currentTarget.style.borderColor = "rgba(0,0,0,0.08)";
    e.currentTarget.style.transform = "translateY(0)";
  };

  const handleLogoutHover = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.currentTarget.style.background = "#fef2f2";
    e.currentTarget.style.borderColor = "#dc2626";
    e.currentTarget.style.color = "#dc2626";
    e.currentTarget.style.transform = "translateY(-1px)";
  };

  const handleLogoutLeave = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.currentTarget.style.background = "#fff";
    e.currentTarget.style.borderColor = "rgba(0,0,0,0.08)";
    e.currentTarget.style.color = "#374151";
    e.currentTarget.style.transform = "translateY(0)";
  };

  return (
    <div style={S.pageHeader}>
      <div style={S.titleWrap}>
        <h1 style={S.title}>Êìç‰ΩúÂè∞</h1>
        <span style={S.sub}>ÂÖ≥ÈîÆÊåáÊ†á‰∏éÊúÄÊñ∞Âä®ÊÄÅ</span>
      </div>
      <div style={S.actionRow}>
        <button 
          style={S.smallBtn} 
          onClick={onRefresh}
          onMouseEnter={handleBtnHover}
          onMouseLeave={handleBtnLeave}
        >
          Âà∑Êñ∞
        </button>
        <button 
          style={S.smallBtn} 
          onClick={onAddAccount}
          onMouseEnter={handleBtnHover}
          onMouseLeave={handleBtnLeave}
        >
          ‚ûï Ê∑ªÂä†Ë¥¶Âè∑
        </button>
        <button 
          style={S.smallBtn} 
          onClick={onLogout}
          onMouseEnter={handleLogoutHover}
          onMouseLeave={handleLogoutLeave}
        >
          üö™ ÈÄÄÂá∫ÁôªÂΩï
        </button>
      </div>
    </div>
  );
}

export default function DashboardInline() {
  const [status, setStatus] = useState<any>(null);
  const [threads, setThreads] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [showQRDialog, setShowQRDialog] = useState(false);

  const loginStatus = useMemo(() => {
    const rawStatus = String(status?.status ?? '').toUpperCase();
    const rawState = String(status?.state ?? '').toUpperCase();
    const awaitingQr = rawStatus === 'QR' || rawState.includes('QR');
    if (rawStatus === 'READY') {
      return {
        text: 'Â∑≤ËøûÊé•',
        tone: 'success' as const,
        description: status?.phoneE164 ? `Â∑≤ÁôªÂΩïË¥¶Âè∑Ôºö${status.phoneE164}` : 'WhatsApp ‰ºöËØùÂ∑≤Â∞±Áª™',
        showAction: false,
      };
    }
    if (awaitingQr) {
      return {
        text: 'ÂæÖÊâ´Á†Å',
        tone: 'warn' as const,
        description: 'ËØ∑‰ΩøÁî®ÊâãÊú∫ WhatsApp Êâ´Êèè‰∫åÁª¥Á†ÅÂÆåÊàêÁôªÂΩï',
        showAction: true,
      };
    }
    if (rawStatus === 'AUTHENTICATING' || rawStatus === 'INITIALIZING') {
      return {
        text: rawStatus === 'AUTHENTICATING' ? 'ËÆ§ËØÅ‰∏≠' : 'ÂêØÂä®‰∏≠',
        tone: 'info' as const,
        description: 'ÂÆ¢Êà∑Á´ØÊ≠£Âú®ËøûÊé•ÔºåËØ∑Á®çÂÄô‚Ä¶',
        showAction: false,
      };
    }
    if (rawStatus === 'DISCONNECTED' || rawStatus === 'FAILED') {
      return {
        text: rawStatus === 'FAILED' ? 'ËøûÊé•Â§±Ë¥•' : 'Â∑≤Êñ≠ÂºÄ',
        tone: 'error' as const,
        description: 'ÈúÄË¶ÅÈáçÊñ∞Êâ´Á†ÅÁôªÂΩï‰ª•ÊÅ¢Â§çËøûÊé•',
        showAction: true,
      };
    }
    return {
      text: rawStatus || 'Êú™Áü•Áä∂ÊÄÅ',
      tone: 'info' as const,
      description: 'Ê≠£Âú®Á≠âÂæÖ WhatsApp ÂÆ¢Êà∑Á´ØÂèçÈ¶à‚Ä¶',
      showAction: false,
    };
  }, [status]);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [statusData, { threads: threadsData }] = await Promise.all([
          api.getStatus(), 
          api.getThreads()
        ]);
        setStatus(statusData);
        setThreads(threadsData);
      } catch (error) {
        console.warn('APIÊúçÂä°Âô®ËøûÊé•Â§±Ë¥•Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ:', error);
        // TODO: Êé•Âè£ÂØπÊé•ÁÇπ - ‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
        setStatus({
          online: true,
          sessionReady: true,
          cooldownHours: 24,
          perContactReplyCooldownMinutes: 10,
          contactCount: 5,
          latestMessageAt: new Date().toISOString(),
          qrCode: null
        });
        setThreads([
          {
            id: '1',
            contactId: '1',
            contact: { 
              id: '1', 
              phoneE164: '+1234567890', 
              name: 'Âº†‰∏â',
              cooldownUntil: null,
              cooldownRemainingSeconds: 0
            },
            aiEnabled: true,
            messagesCount: 15,
            latestMessageAt: new Date(Date.now() - 300000).toISOString(),
            lastHumanAt: new Date(Date.now() - 600000).toISOString(),
            lastBotAt: new Date(Date.now() - 120000).toISOString(),
            createdAt: new Date(Date.now() - 86400000).toISOString(),
            updatedAt: new Date(Date.now() - 300000).toISOString()
          },
          {
            id: '2',
            contactId: '2',
            contact: { 
              id: '2', 
              phoneE164: '+0987654321', 
              name: 'ÊùéÂõõ',
              cooldownUntil: null,
              cooldownRemainingSeconds: 0
            },
            aiEnabled: false,
            messagesCount: 8,
            latestMessageAt: new Date(Date.now() - 600000).toISOString(),
            lastHumanAt: new Date(Date.now() - 300000).toISOString(),
            lastBotAt: new Date(Date.now() - 900000).toISOString(),
            createdAt: new Date(Date.now() - 172800000).toISOString(),
            updatedAt: new Date(Date.now() - 600000).toISOString()
          },
          {
            id: '3',
            contactId: '3',
            contact: { 
              id: '3', 
              phoneE164: '+1122334455', 
              name: 'Áéã‰∫î',
              cooldownUntil: null,
              cooldownRemainingSeconds: 0
            },
            aiEnabled: true,
            messagesCount: 23,
            latestMessageAt: new Date(Date.now() - 180000).toISOString(),
            lastHumanAt: new Date(Date.now() - 360000).toISOString(),
            lastBotAt: new Date(Date.now() - 60000).toISOString(),
            createdAt: new Date(Date.now() - 259200000).toISOString(),
            updatedAt: new Date(Date.now() - 180000).toISOString()
          }
        ]);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  if (loading || !status) {
    return (
      <div 
        style={{
          minHeight: '100vh',
          background: 'linear-gradient(to bottom, #EEF2FF, #FFFFFF)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif'
        }}
      >
        <div style={{ textAlign: 'center' }}>
          <div 
            style={{
              width: '32px',
              height: '32px',
              border: '3px solid #E5E7EB',
              borderTop: '3px solid #4F46E5',
              borderRadius: '50%',
              animation: 'spin 1s linear infinite',
              margin: '0 auto 16px'
            }}
          />
          <p style={{ color: '#6B7280', fontSize: '14px' }}>Âä†ËΩΩ‰∏≠...</p>
        </div>
      </div>
    );
  }

  // TODO: Êé•Âè£ÂØπÊé•ÁÇπ - ËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆ
  const totalConversations = threads.length;
  const aiActiveCount = threads.filter(t => t.aiEnabled).length;
  const active24hCount = threads.filter(t => {
    const lastActivity = new Date(t.updatedAt).getTime();
    const now = new Date().getTime();
    return (now - lastActivity) < 24 * 60 * 60 * 1000;
  }).length;
  const avgMessages = threads.length > 0 ? Math.round(threads.reduce((sum: number, t: any) => sum + (t.messagesCount || 0), 0) / threads.length) : 0;

  const handleExport = () => {
    console.log('ÂØºÂá∫Êï∞ÊçÆ'); // TODO: Êé•Âè£ÂØπÊé•ÁÇπ
  };

  const handleRefresh = () => {
    console.log('Âà∑Êñ∞Êï∞ÊçÆ'); // TODO: Êé•Âè£ÂØπÊé•ÁÇπ
    window.location.reload();
  };

  const handleAddAccount = async () => {
    try {
      await api.startLogin();
      console.log('ÂºÄÂßãÁôªÂΩïÊµÅÁ®ã');
      setShowQRDialog(true);
    } catch (error) {
      console.error('ÂêØÂä®ÁôªÂΩïÂ§±Ë¥•:', error);
      alert('ÂêØÂä®ÁôªÂΩïÂ§±Ë¥•: ' + (error as Error).message);
    }
  };

  const handleQRSuccess = () => {

    setShowQRDialog(false);

    console.log('WhatsApp ÁôªÂΩïÊàêÂäü');

    window.location.reload();

  };



  const handleLogout = async () => {
    if (!confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
      return;
    }
    
    try {
      await api.logout();
      console.log('ÈÄÄÂá∫ÁôªÂΩïÊàêÂäü');
      alert('ÈÄÄÂá∫ÁôªÂΩïÊàêÂäüÔºÅ');
      // Âà∑Êñ∞È°µÈù¢‰ª•Êõ¥Êñ∞Áä∂ÊÄÅ
      window.location.reload();
    } catch (error) {
      console.error('ÈÄÄÂá∫ÁôªÂΩïÂ§±Ë¥•:', error);
      alert('ÈÄÄÂá∫ÁôªÂΩïÂ§±Ë¥•: ' + (error as Error).message);
    }
  };

  const handleOpenThread = async (threadId: string) => {
    try {
      const threadData = await api.getThreadMessages(threadId);
      console.log('ÊâìÂºÄ‰ºöËØù:', threadData);
      // TODO: ÂÆûÁé∞ÊâìÂºÄ‰ºöËØùÂØπËØùÊ°ÜÊàñË∑≥ËΩ¨Âà∞‰ºöËØùËØ¶ÊÉÖÈ°µ
    } catch (error) {
      console.error('Ëé∑Âèñ‰ºöËØùËØ¶ÊÉÖÂ§±Ë¥•:', error);
    }
  };

  return (
    <div 
      style={{
        minHeight: '100vh',
        background: 'linear-gradient(to bottom, #EEF2FF, #FFFFFF)',
        fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif'
      }}
    >
      {/* ‰∏ªÂÜÖÂÆπÂå∫Âüü */}
      <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px' }}>
        {/* È°µÈù¢Ê†áÈ¢ò‰∏éÊìç‰ΩúÊåâÈíÆ */}
        <PageHeader 
          onRefresh={handleRefresh} 
          onAddAccount={handleAddAccount}
          onLogout={handleLogout}
        />
        {/* KPIÁªüËÆ°Âç°Áâá */}
        <div
          style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(4, 1fr)',
            gap: '16px',
            marginBottom: '24px'
          }}
        >
          <Card>
            <Stat label="ÊÄªÂØπËØùÊï∞" value={totalConversations} hint="ÊâÄÊúâ‰ºöËØù" color="#4F46E5" />
          </Card>
          <Card>
            <Stat label="AIÊ¥ªË∑É" value={aiActiveCount} hint="Ëá™Âä®ÂõûÂ§ç‰∏≠" color="#059669" />
          </Card>
          <Card>
            <Stat label="24hÊ¥ªË∑É" value={active24hCount} hint="ÊúÄËøëÊ¥ªË∑É" color="#2563EB" />
          </Card>
          <Card>
            <Stat label="Âπ≥ÂùáÊ∂àÊÅØ" value={avgMessages} hint="ÊØè‰ºöËØùÊ∂àÊÅØÊï∞" color="#B45309" />
          </Card>
        </div>

        {/* ‰∏ª‰ΩìÂèåÊ†èÂ∏ÉÂ±Ä */}
        <div
          style={{
            display: 'grid',
            gridTemplateColumns: '2fr 1fr',
            gap: '16px'
          }}
        >
          {/* Â∑¶‰æßÔºöÊúÄËøë‰ºöËØùÂàóË°® */}
          <Card>
            <div
              style={{
                fontSize: '16px',
                fontWeight: '600',
                color: '#111827',
                marginBottom: '16px',
                fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif'
              }}
            >
              ÊúÄËøë‰ºöËØù
            </div>
            
            {/* Ë°®Â§¥ */}
            <div
              style={{
                display: 'grid',
                gridTemplateColumns: '1fr auto',
                padding: '12px',
                backgroundColor: '#F9FAFB',
                borderRadius: '10px',
                marginBottom: '8px',
                fontSize: '12px',
                fontWeight: '600',
                color: '#6B7280',
                fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif'
              }}
            >
              <span>ËÅîÁ≥ª‰∫∫‰∏éÊ∂àÊÅØ</span>
              <span>Áä∂ÊÄÅ</span>
            </div>

            {/* ‰ºöËØùÂàóË°® */}
            <div>
              {threads.slice(0, 8).map((thread) => (
                <Row
                  key={thread.id}
                  contact={thread.contact.name || thread.contact.phoneE164}
                  messages={thread.messagesCount}
                  lastActive={new Date(thread.updatedAt).toLocaleString('zh-CN', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                  })}
                  status={<Tag text={thread.aiEnabled ? 'AIÊ¥ªË∑É' : '‰∫∫Â∑•Êé•ÁÆ°'} tone={thread.aiEnabled ? 'success' : 'info'} />}
                  onClick={() => handleOpenThread(thread.id)}
                />
              ))}
            </div>
          </Card>

          {/* Âè≥‰æßÔºöÁ≥ªÁªüÁä∂ÊÄÅÂíåÊó•Âøó */}
          <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
            {/* Á≥ªÁªüÁä∂ÊÄÅÂç°Áâá */}
            <Card>
              <div
                style={{
                  fontSize: '16px',
                  fontWeight: '600',
                  color: '#111827',
                  marginBottom: '16px',
                  fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif'
                }}
              >
                Á≥ªÁªüÁä∂ÊÄÅ
              </div>
              <div
                style={{
                  display: 'flex',
                  alignItems: 'flex-start',
                  justifyContent: 'space-between',
                  gap: '12px',
                  marginBottom: '16px'
                }}
              >
                <div style={{ textAlign: 'left', flex: 1 }}>
                  <div style={{ fontSize: '14px', color: '#1F2937', fontWeight: 600 }}>WhatsApp ÁôªÂΩïÁä∂ÊÄÅ</div>
                  <div style={{ fontSize: '12px', color: '#6B7280', marginTop: '4px', lineHeight: 1.4 }}>{loginStatus.description}</div>
                  {status.phoneE164 && loginStatus.tone === 'success' && (
                    <div style={{ fontSize: '12px', color: '#2563EB', marginTop: '6px' }}>ÂΩìÂâçË¥¶Âè∑Ôºö{status.phoneE164}</div>
                  )}
                </div>
                <Tag text={loginStatus.text} tone={loginStatus.tone} />
              </div>
              {loginStatus.showAction && (
                <div style={{ marginBottom: '16px' }}>
                  <Button
                    kind="primary"
                    onClick={() => setShowQRDialog(true)}
                    style={{ width: '100%', justifyContent: 'center' }}
                  >
                    Êâ´Á†ÅÁôªÂΩï
                  </Button>
                </div>
              )}
              <Item label="‰ºöËØùÁä∂ÊÄÅ" value={status.sessionReady ? 'Â∞±Áª™' : 'Êú™Â∞±Áª™'} />
              <Item label="ÂÜ∑Âç¥Êó∂Èó¥" value={`${status.cooldownHours} Â∞èÊó∂`} />
              <Item label="ËÅîÁ≥ª‰∫∫Êï∞Èáè" value={status.contactCount} />
              <Item label="Ëá™Âä®ÂõûÂ§çÈó¥Èöî" value={`${status.perContactReplyCooldownMinutes} ÂàÜÈíü`} />
            </Card>
            
            {/* Ê¥ªË∑ÉÊó•ÂøóÂç°Áâá */}
            <Card>
              <div
                style={{
                  fontSize: '16px',
                  fontWeight: '600',
                  color: '#111827',
                  marginBottom: '16px',
                  fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, sans-serif'
                }}
              >
                Ê¥ªË∑ÉÊó•Âøó
              </div>
              <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                {[
                  { text: 'AIËá™Âä®ÂõûÂ§çÂº†‰∏â', time: '2ÂàÜÈíüÂâç', type: 'success' },
                  { text: 'ÊùéÂõõ‰ºöËØùËΩ¨‰∫∫Â∑•', time: '5ÂàÜÈíüÂâç', type: 'info' },
                  { text: 'Áéã‰∫îÂèëÈÄÅÊñ∞Ê∂àÊÅØ', time: '8ÂàÜÈíüÂâç', type: 'success' },
                  { text: 'Á≥ªÁªüÊ£ÄÊü•ÂÆåÊàê', time: '15ÂàÜÈíüÂâç', type: 'info' },
                  { text: 'ÂÜ∑Âç¥Êó∂Èó¥ÈáçÁΩÆ', time: '1Â∞èÊó∂Ââç', type: 'warn' }
                ].map((log, index) => (
                  <div key={index} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px', padding: '8px 0' }}>
                    <span style={{ fontSize: '13px', color: '#374151', flex: 1 }}>{log.text}</span>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Tag text={log.time} tone="info" style={{ fontSize: '11px', padding: '2px 6px' }} />
                    </div>
                  </div>
                ))}
              </div>
            </Card>
          </div>
        </div>
      </div>

      {/* ‰∫åÁª¥Á†ÅÁôªÂΩïÂØπËØùÊ°Ü */}
      <QRCodeDialog 
        isOpen={showQRDialog}
        onClose={() => setShowQRDialog(false)}
        onSuccess={handleQRSuccess}
      />

      {/* CSSÂä®Áîª */}
      <style jsx>{`
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `}</style>
    </div>
  );
}

/* 
=======================
Ëá™Ê£ÄÊ∏ÖÂçïÔºàËØ∑Âú®Êèê‰∫§Â∫ïÈÉ®Ê≥®ÈáäÂãæÈÄâÔºâ
=======================
- [x] ‰∏ªÂÆπÂô® maxWidth Â±Ö‰∏≠ÔºåÂÜÖÂÆπ‰∏çÂÜçÊå§Âú®Â∑¶‰æß
- [x] KPI ÂõõÂç°Á≠âÂÆΩÈì∫Êª°‰∏ÄË°åÔºåÊï∞ÂÄºÊ∏ÖÊô∞
- [x] ‰∏ª‰ΩìÂå∫ÂüüÂ∑¶Âè≥ 2:1ÔºåÂè≥‰æßÂÜçÊó†Â§ßÁâáÁïôÁôΩ
- [x] Âç°Áâá/ÊåâÈíÆ hover ÊúâÈò¥ÂΩ±‰∏éËâ≤ÂΩ©ÂèçÈ¶à
- [x] È¢úËâ≤ÂàÜÊòéÔºö‰∏ªËâ≤/ÁÅ∞Èò∂/ËØ≠‰πâ Tag Ê∏ÖÊô∞ÂèØËæ®
- [x] Á∫ØÂÜÖËÅîÊ†∑ÂºèÔºåÊó†‰ªª‰Ωï CSS/Á±ªÂêç
- [x] È°µÈù¢È¶ñÂ±è‰ø°ÊÅØÂ§ßÂπÖÂ¢ûÂä†ÔºåÊªöÂä®ÊòéÊòæÂáèÂ∞ë
*/