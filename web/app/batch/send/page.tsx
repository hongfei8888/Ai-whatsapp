'use client';

import React, { useState, useEffect } from 'react';
import { api } from '@/lib/api';
import { useAccount } from '@/lib/account-context';
import type { MessageTemplate, BatchSendConfig } from '@/lib/types';

const S = {
  container: {
    maxWidth: 1200,
    margin: '0 auto',
    padding: '24px',
    background: 'linear-gradient(to bottom, #EEF2FF, #FFFFFF)',
    minHeight: '100vh',
  },
  header: {
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'space-between',
    marginBottom: '24px',
  },
  title: {
    fontSize: '24px',
    fontWeight: 600,
    color: '#111827',
    margin: 0,
  },
  backButton: {
    background: '#F3F4F6',
    color: '#374151',
    border: 'none',
    borderRadius: '8px',
    padding: '8px 16px',
    cursor: 'pointer',
    fontSize: '14px',
    display: 'flex',
    alignItems: 'center',
    gap: '8px',
    transition: 'all 0.2s',
  },
  form: {
    background: '#FFFFFF',
    border: '1px solid #E5E7EB',
    borderRadius: '12px',
    padding: '24px',
    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
    marginBottom: '24px',
  },
  formGroup: {
    marginBottom: '20px',
  },
  label: {
    display: 'block',
    fontSize: '14px',
    fontWeight: 500,
    color: '#374151',
    marginBottom: '8px',
  },
  input: {
    width: '100%',
    padding: '12px 16px',
    border: '1px solid #D1D5DB',
    borderRadius: '8px',
    fontSize: '14px',
    background: '#FFFFFF',
    boxSizing: 'border-box' as const,
  },
  textarea: {
    width: '100%',
    padding: '12px 16px',
    border: '1px solid #D1D5DB',
    borderRadius: '8px',
    fontSize: '14px',
    background: '#FFFFFF',
    minHeight: '100px',
    resize: 'vertical' as const,
    fontFamily: 'inherit',
    boxSizing: 'border-box' as const,
  },
  select: {
    width: '100%',
    padding: '12px 16px',
    border: '1px solid #D1D5DB',
    borderRadius: '8px',
    fontSize: '14px',
    background: '#FFFFFF',
    cursor: 'pointer',
    boxSizing: 'border-box' as const,
  },
  checkboxGroup: {
    display: 'flex',
    flexDirection: 'column' as const,
    gap: '12px',
    marginTop: '8px',
  },
  checkboxItem: {
    display: 'flex',
    alignItems: 'center',
    gap: '8px',
  },
  checkbox: {
    width: '16px',
    height: '16px',
    cursor: 'pointer',
  },
  checkboxLabel: {
    fontSize: '14px',
    color: '#374151',
    cursor: 'pointer',
  },
  button: {
    background: '#4F46E5',
    color: '#FFFFFF',
    border: 'none',
    borderRadius: '8px',
    padding: '12px 24px',
    cursor: 'pointer',
    fontSize: '14px',
    fontWeight: 500,
    transition: 'all 0.2s',
    marginRight: '12px',
  },
  buttonSecondary: {
    background: '#F3F4F6',
    color: '#374151',
    border: '1px solid #D1D5DB',
  },
  buttonDanger: {
    background: '#DC2626',
    color: '#FFFFFF',
  },
  buttonDisabled: {
    background: '#9CA3AF',
    cursor: 'not-allowed',
  },
  previewCard: {
    background: '#F8FAFC',
    border: '1px solid #E2E8F0',
    borderRadius: '8px',
    padding: '16px',
    marginTop: '16px',
  },
  previewTitle: {
    fontSize: '14px',
    fontWeight: 500,
    color: '#374151',
    marginBottom: '8px',
  },
  previewContent: {
    fontSize: '14px',
    color: '#6B7280',
    lineHeight: '1.5',
  },
  templateSelector: {
    display: 'flex',
    gap: '12px',
    alignItems: 'center',
  },
  templateButton: {
    background: '#F3F4F6',
    color: '#374151',
    border: '1px solid #D1D5DB',
    borderRadius: '6px',
    padding: '8px 12px',
    cursor: 'pointer',
    fontSize: '12px',
    transition: 'all 0.2s',
  },
  templateButtonActive: {
    background: '#4F46E5',
    color: '#FFFFFF',
    border: '1px solid #4F46E5',
  },
  loadingContainer: {
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
    padding: '40px',
  },
  errorMessage: {
    background: '#FEF2F2',
    border: '1px solid #FECACA',
    borderRadius: '8px',
    padding: '12px',
    marginBottom: '16px',
    color: '#DC2626',
    fontSize: '14px',
  },
  successMessage: {
    background: '#F0FDF4',
    border: '1px solid #BBF7D0',
    borderRadius: '8px',
    padding: '12px',
    marginBottom: '16px',
    color: '#059669',
    fontSize: '14px',
  },
  // ËÅîÁ≥ª‰∫∫ÈÄâÊã©ÂØπËØùÊ°ÜÊ†∑Âºè
  dialogOverlay: {
    position: 'fixed' as const,
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    background: 'rgba(0, 0, 0, 0.5)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: 1000,
  },
  dialogContent: {
    background: '#FFFFFF',
    borderRadius: '12px',
    padding: '24px',
    maxWidth: '600px',
    width: '90%',
    maxHeight: '80vh',
    overflow: 'auto',
    boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1)',
  },
  dialogHeader: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: '20px',
    paddingBottom: '12px',
    borderBottom: '1px solid #E5E7EB',
  },
  dialogTitle: {
    fontSize: '18px',
    fontWeight: 600,
    color: '#111827',
    margin: 0,
  },
  dialogCloseButton: {
    background: 'none',
    border: 'none',
    fontSize: '20px',
    cursor: 'pointer',
    color: '#6B7280',
    padding: '4px',
  },
  contactList: {
    maxHeight: '400px',
    overflow: 'auto',
    border: '1px solid #E5E7EB',
    borderRadius: '8px',
    marginBottom: '20px',
  },
  contactItem: {
    display: 'flex',
    alignItems: 'center',
    padding: '12px 16px',
    borderBottom: '1px solid #F3F4F6',
    cursor: 'pointer',
    transition: 'background-color 0.2s',
  },
  contactItemSelected: {
    backgroundColor: '#EEF2FF',
  },
  contactItemHover: {
    backgroundColor: '#F9FAFB',
  },
  contactCheckbox: {
    marginRight: '12px',
    width: '16px',
    height: '16px',
  },
  contactInfo: {
    flex: 1,
  },
  contactName: {
    fontSize: '14px',
    fontWeight: 500,
    color: '#111827',
    marginBottom: '2px',
  },
  contactPhone: {
    fontSize: '12px',
    color: '#6B7280',
  },
  dialogActions: {
    display: 'flex',
    justifyContent: 'flex-end',
    gap: '12px',
  },
  loadingText: {
    textAlign: 'center' as const,
    padding: '40px',
    color: '#6B7280',
    fontSize: '14px',
  },
};

export default function BatchSendPage() {
  const { currentAccountId } = useAccount();
  const [templates, setTemplates] = useState<MessageTemplate[]>([]);
  const [selectedTemplate, setSelectedTemplate] = useState<string>('');
  const [customContent, setCustomContent] = useState<string>('');
  const [contactIds, setContactIds] = useState<string[]>([]);
  const [contactFilters, setContactFilters] = useState({
    tags: [] as string[],
    source: '',
    createdAfter: '',
  });
  const [scheduleAt, setScheduleAt] = useState<string>('');
  const [ratePerMinute, setRatePerMinute] = useState<number>(8);
  const [jitterMs, setJitterMs] = useState<number>(300);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string>('');
  const [success, setSuccess] = useState<string>('');
  
  // ËÅîÁ≥ª‰∫∫ÈÄâÊã©ÂØπËØùÊ°ÜÁä∂ÊÄÅ
  const [showContactDialog, setShowContactDialog] = useState(false);
  const [contacts, setContacts] = useState<any[]>([]);
  const [contactsLoading, setContactsLoading] = useState(false);
  const [selectedContactIds, setSelectedContactIds] = useState<string[]>([]);
  
  // ÊâπÈáèÂèëÈÄÅÁä∂ÊÄÅÊ£ÄÊü•
  const [currentBatchId, setCurrentBatchId] = useState<string>('');
  const [batchStatus, setBatchStatus] = useState<any>(null);
  const [statusLoading, setStatusLoading] = useState(false);
  const [autoRefreshStatus, setAutoRefreshStatus] = useState(false);
  const [statusRefreshInterval, setStatusRefreshInterval] = useState<NodeJS.Timeout | null>(null);
  const [cancelling, setCancelling] = useState(false);

  useEffect(() => {
    loadTemplates();
  }, []);

  const loadTemplates = async () => {
    try {
      const templateList = await api.templates.list({ isActive: true });
      setTemplates(templateList);
    } catch (error) {
      console.error('Âä†ËΩΩÊ®°ÊùøÂ§±Ë¥•:', error);
      setError('Âä†ËΩΩÊ®°ÊùøÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
  };

  const loadContacts = async () => {
    if (!currentAccountId) {
      console.warn('Êú™ÈÄâÊã©Ë¥¶Âè∑ÔºåÊó†Ê≥ïÂä†ËΩΩËÅîÁ≥ª‰∫∫');
      setError('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ë¥¶Âè∑');
      return;
    }
    
    setContactsLoading(true);
    try {
      // üîÑ ‰ΩøÁî® threads API Ëé∑ÂèñËÅîÁ≥ª‰∫∫Ôºàcontacts APIÂ∑≤Â∫üÂºÉÔºâ
      const threadsData = await api.getThreads();
      const contactsList = (threadsData.threads || [])
        .map((t: any) => t.contact)
        .filter((c: any) => c && c.phoneE164);
      setContacts(contactsList);
    } catch (error) {
      console.error('Âä†ËΩΩËÅîÁ≥ª‰∫∫Â§±Ë¥•:', error);
      setError('Âä†ËΩΩËÅîÁ≥ª‰∫∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
      setContacts([]);
    } finally {
      setContactsLoading(false);
    }
  };

  const handleOpenContactDialog = async () => {
    setSelectedContactIds(contactIds); // ÂàùÂßãÂåñÂ∑≤ÈÄâÊã©ÁöÑËÅîÁ≥ª‰∫∫
    await loadContacts();
    setShowContactDialog(true);
  };

  const handleContactSelect = (contactId: string) => {
    setSelectedContactIds(prev => 
      prev.includes(contactId) 
        ? prev.filter(id => id !== contactId)
        : [...prev, contactId]
    );
  };

  const handleContactDialogConfirm = () => {
    setContactIds(selectedContactIds);
    setShowContactDialog(false);
  };

  const handleContactDialogCancel = () => {
    setSelectedContactIds(contactIds); // ÊÅ¢Â§çÂéüÈÄâÊã©
    setShowContactDialog(false);
  };

  const checkBatchStatus = async (batchId: string) => {
    setStatusLoading(true);
    try {
      const status = await api.batch.getStatus(batchId);
      setBatchStatus(status);
      return status;
    } catch (error) {
      console.error('Ê£ÄÊü•ÊâπÈáèÂèëÈÄÅÁä∂ÊÄÅÂ§±Ë¥•:', error);
      setError('Ê£ÄÊü•ÊâπÈáèÂèëÈÄÅÁä∂ÊÄÅÂ§±Ë¥•');
      return null;
    } finally {
      setStatusLoading(false);
    }
  };

  const handleCheckStatus = async () => {
    if (!currentBatchId.trim()) {
      setError('ËØ∑ËæìÂÖ•ÊâπÈáèÂèëÈÄÅ‰ªªÂä°ID');
      return;
    }
    await checkBatchStatus(currentBatchId);
  };

  const startAutoRefreshStatus = () => {
    if (statusRefreshInterval) {
      clearInterval(statusRefreshInterval);
    }
    
    const interval = setInterval(async () => {
      if (currentBatchId && !statusLoading) {
        await checkBatchStatus(currentBatchId);
      }
    }, 3000); // ÊØè3ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
    
    setStatusRefreshInterval(interval);
    setAutoRefreshStatus(true);
  };

  const stopAutoRefreshStatus = () => {
    if (statusRefreshInterval) {
      clearInterval(statusRefreshInterval);
      setStatusRefreshInterval(null);
    }
    setAutoRefreshStatus(false);
  };

  const toggleAutoRefreshStatus = () => {
    if (autoRefreshStatus) {
      stopAutoRefreshStatus();
    } else {
      startAutoRefreshStatus();
    }
  };

  const handleCancelBatch = async () => {
    if (!currentBatchId.trim()) {
      setError('ËØ∑ËæìÂÖ•ÊâπÈáèÂèëÈÄÅ‰ªªÂä°ID');
      return;
    }

    if (!batchStatus || (batchStatus.status !== 'running' && batchStatus.status !== 'pending' && batchStatus.status !== 'processing')) {
      setError('Âè™ÊúâËøêË°å‰∏≠„ÄÅÂæÖÂ§ÑÁêÜÊàñÂ§ÑÁêÜ‰∏≠ÁöÑÊâπÈáèÊìç‰ΩúÊâçËÉΩÂèñÊ∂à');
      return;
    }

    if (!confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àËøô‰∏™ÊâπÈáèÂèëÈÄÅ‰ªªÂä°ÂêóÔºü')) {
      return;
    }

    setCancelling(true);
    try {
      await api.batch.cancel(currentBatchId);
      setSuccess('ÊâπÈáèÂèëÈÄÅ‰ªªÂä°Â∑≤ÂèñÊ∂à');
      
      // ÈáçÊñ∞Ê£ÄÊü•Áä∂ÊÄÅ‰ª•Ëé∑ÂèñÊúÄÊñ∞‰ø°ÊÅØ
      await checkBatchStatus(currentBatchId);
      
      // ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞
      stopAutoRefreshStatus();
    } catch (error) {
      console.error('ÂèñÊ∂àÊâπÈáèÂèëÈÄÅÂ§±Ë¥•:', error);
      setError('ÂèñÊ∂àÊâπÈáèÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    } finally {
      setCancelling(false);
    }
  };

  // Ê∏ÖÁêÜÂÆöÊó∂Âô®
  useEffect(() => {
    return () => {
      if (statusRefreshInterval) {
        clearInterval(statusRefreshInterval);
      }
    };
  }, [statusRefreshInterval]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!selectedTemplate && !customContent.trim()) {
      setError('ËØ∑ÈÄâÊã©Ê®°ÊùøÊàñËæìÂÖ•Ê∂àÊÅØÂÜÖÂÆπ');
      return;
    }

    setLoading(true);
    setError('');
    setSuccess('');

    try {
      const config: BatchSendConfig = {
        templateId: selectedTemplate || undefined,
        content: customContent || undefined,
        contactIds: contactIds.length > 0 ? contactIds : undefined,
        contactFilters: Object.values(contactFilters).some(v => v) ? contactFilters : undefined,
        scheduleAt: scheduleAt || undefined,
        ratePerMinute,
        jitterMs,
      };

      const result = await api.batch.sendMessages(config);
      
      setCurrentBatchId(result.id);
      setSuccess(`ÊâπÈáèÂèëÈÄÅ‰ªªÂä°Â∑≤ÂàõÂª∫ÔºÅ‰ªªÂä°ID: ${result.id}`);
      
      // ÈáçÁΩÆË°®Âçï
      setSelectedTemplate('');
      setCustomContent('');
      setContactIds([]);
      setContactFilters({ tags: [], source: '', createdAfter: '' });
      setScheduleAt('');
      
    } catch (error) {
      console.error('ÊâπÈáèÂèëÈÄÅÂ§±Ë¥•:', error);
      setError('ÊâπÈáèÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÈÖçÁΩÆÂêéÈáçËØï');
    } finally {
      setLoading(false);
    }
  };

  const handleTemplateSelect = (templateId: string) => {
    if (selectedTemplate === templateId) {
      setSelectedTemplate('');
    } else {
      setSelectedTemplate(templateId);
      setCustomContent(''); // Ê∏ÖÁ©∫Ëá™ÂÆö‰πâÂÜÖÂÆπ
    }
  };

  const handleCustomContentChange = (content: string) => {
    setCustomContent(content);
    if (content.trim()) {
      setSelectedTemplate(''); // Ê∏ÖÁ©∫Ê®°ÊùøÈÄâÊã©
    }
  };

  const selectedTemplateData = templates.find(t => t.id === selectedTemplate);
  const messageContent = selectedTemplateData ? selectedTemplateData.content : customContent;

  return (
    <div style={S.container}>
      <div style={S.header}>
        <div>
          <button 
            style={S.backButton}
            onClick={() => window.history.back()}
          >
            ‚Üê ËøîÂõûÊâπÈáèÊìç‰Ωú
          </button>
          <h1 style={S.title}>ÊâπÈáèÂèëÈÄÅÊ∂àÊÅØ</h1>
        </div>
      </div>

      {error && (
        <div style={S.errorMessage}>
          {error}
        </div>
      )}

      {success && (
        <div style={S.successMessage}>
          {success}
        </div>
      )}

      <form style={S.form} onSubmit={handleSubmit}>
        {/* Ê∂àÊÅØÂÜÖÂÆπÈÄâÊã© */}
        <div style={S.formGroup}>
          <label style={S.label}>Ê∂àÊÅØÂÜÖÂÆπ</label>
          
          {/* Ê®°ÊùøÈÄâÊã© */}
          <div style={S.templateSelector}>
            <span style={{ fontSize: '14px', color: '#6B7280', marginRight: '12px' }}>ÈÄâÊã©Ê®°Êùø:</span>
            {templates.map(template => (
              <button
                key={template.id}
                type="button"
                style={{
                  ...S.templateButton,
                  ...(selectedTemplate === template.id ? S.templateButtonActive : {}),
                }}
                onClick={() => handleTemplateSelect(template.id)}
              >
                {template.name}
              </button>
            ))}
          </div>

          {/* Ëá™ÂÆö‰πâÂÜÖÂÆπ */}
          <div style={{ marginTop: '16px' }}>
            <label style={S.label}>ÊàñËæìÂÖ•Ëá™ÂÆö‰πâÂÜÖÂÆπ:</label>
            <textarea
              style={S.textarea}
              placeholder="ËæìÂÖ•Ë¶ÅÂèëÈÄÅÁöÑÊ∂àÊÅØÂÜÖÂÆπ..."
              value={customContent}
              onChange={(e) => handleCustomContentChange(e.target.value)}
              disabled={!!selectedTemplate}
            />
          </div>

          {/* Ê∂àÊÅØÈ¢ÑËßà */}
          {messageContent && (
            <div style={S.previewCard}>
              <div style={S.previewTitle}>Ê∂àÊÅØÈ¢ÑËßà:</div>
              <div style={S.previewContent}>{messageContent}</div>
            </div>
          )}
        </div>

        {/* Êé•Êî∂‰∫∫ÈÄâÊã© */}
        <div style={S.formGroup}>
          <label style={S.label}>Êé•Êî∂‰∫∫</label>
          <div style={S.checkboxGroup}>
            <div style={S.checkboxItem}>
              <input
                type="checkbox"
                id="allContacts"
                style={S.checkbox}
                checked={contactIds.length === 0 && !contactFilters.tags.length && !contactFilters.source && !contactFilters.createdAfter}
                onChange={() => {
                  setContactIds([]);
                  setContactFilters({ tags: [], source: '', createdAfter: '' });
                }}
              />
              <label htmlFor="allContacts" style={S.checkboxLabel}>
                ÊâÄÊúâËÅîÁ≥ª‰∫∫
              </label>
            </div>
            
            <div style={S.checkboxItem}>
              <input
                type="checkbox"
                id="specificContacts"
                style={S.checkbox}
                checked={contactIds.length > 0}
                onChange={(e) => {
                  if (e.target.checked) {
                    handleOpenContactDialog();
                  } else {
                    setContactIds([]);
                  }
                }}
              />
              <label htmlFor="specificContacts" style={S.checkboxLabel}>
                ÊåáÂÆöËÅîÁ≥ª‰∫∫ (ÂΩìÂâçÈÄâÊã©: {contactIds.length} ‰∏™)
              </label>
            </div>

            <div style={S.checkboxItem}>
              <input
                type="checkbox"
                id="filteredContacts"
                style={S.checkbox}
                checked={Boolean(contactFilters.tags.length > 0 || contactFilters.source || contactFilters.createdAfter)}
                onChange={(e) => {
                  if (!e.target.checked) {
                    setContactFilters({ tags: [], source: '', createdAfter: '' });
                  }
                }}
              />
              <label htmlFor="filteredContacts" style={S.checkboxLabel}>
                ÊåâÊù°‰ª∂Á≠õÈÄâËÅîÁ≥ª‰∫∫
              </label>
            </div>
          </div>

          {/* Á≠õÈÄâÊù°‰ª∂ */}
          {(contactFilters.tags.length > 0 || contactFilters.source || contactFilters.createdAfter) && (
            <div style={{ marginTop: '16px', padding: '16px', background: '#F8FAFC', borderRadius: '8px' }}>
              <div style={S.formGroup}>
                <label style={S.label}>Ê†áÁ≠æÁ≠õÈÄâ (Â§ö‰∏™Ê†áÁ≠æÁî®ÈÄóÂè∑ÂàÜÈöî)</label>
                <input
                  type="text"
                  style={S.input}
                  placeholder="‰æãÂ¶Ç: VIP, Ê¥ªË∑ÉÁî®Êà∑"
                  value={contactFilters.tags.join(', ')}
                  onChange={(e) => setContactFilters(prev => ({
                    ...prev,
                    tags: e.target.value.split(',').map(t => t.trim()).filter(t => t)
                  }))}
                />
              </div>

              <div style={S.formGroup}>
                <label style={S.label}>Êù•Ê∫êÁ≠õÈÄâ</label>
                <input
                  type="text"
                  style={S.input}
                  placeholder="‰æãÂ¶Ç: ÊâãÂä®Ê∑ªÂä†, ÊâπÈáèÂØºÂÖ•"
                  value={contactFilters.source}
                  onChange={(e) => setContactFilters(prev => ({
                    ...prev,
                    source: e.target.value
                  }))}
                />
              </div>

              <div style={S.formGroup}>
                <label style={S.label}>ÂàõÂª∫Êó∂Èó¥ (Âú®Ê≠§Êó•Êúü‰πãÂêé)</label>
                <input
                  type="date"
                  style={S.input}
                  value={contactFilters.createdAfter}
                  onChange={(e) => setContactFilters(prev => ({
                    ...prev,
                    createdAfter: e.target.value
                  }))}
                />
              </div>
            </div>
          )}
        </div>

        {/* ÂèëÈÄÅËÆæÁΩÆ */}
        <div style={S.formGroup}>
          <label style={S.label}>ÂèëÈÄÅËÆæÁΩÆ</label>
          
          <div style={{ marginBottom: '16px' }}>
            <label style={S.label}>ËÆ°ÂàíÂèëÈÄÅÊó∂Èó¥ (ÂèØÈÄâ)</label>
            <input
              type="datetime-local"
              style={S.input}
              value={scheduleAt}
              onChange={(e) => setScheduleAt(e.target.value)}
            />
            <div style={{ fontSize: '12px', color: '#6B7280', marginTop: '4px' }}>
              ÁïôÁ©∫Ë°®Á§∫Á´ãÂç≥ÂèëÈÄÅ
            </div>
          </div>

          <div style={{ display: 'flex', gap: '16px' }}>
            <div style={{ flex: 1 }}>
              <label style={S.label}>ÂèëÈÄÅÈÄüÁéá (Êù°/ÂàÜÈíü)</label>
              <input
                type="number"
                style={S.input}
                min="1"
                max="60"
                value={ratePerMinute}
                onChange={(e) => setRatePerMinute(Number(e.target.value))}
              />
            </div>

            <div style={{ flex: 1 }}>
              <label style={S.label}>ÈöèÊú∫Âª∂Ëøü (ÊØ´Áßí)</label>
              <input
                type="number"
                style={S.input}
                min="0"
                max="5000"
                value={jitterMs}
                onChange={(e) => setJitterMs(Number(e.target.value))}
              />
            </div>
          </div>
        </div>

        {/* Êèê‰∫§ÊåâÈíÆ */}
        <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
          <button
            type="submit"
            style={{
              ...S.button,
              ...(loading ? S.buttonDisabled : {}),
            }}
            disabled={loading}
          >
            {loading ? 'ÂèëÈÄÅ‰∏≠...' : 'ÂºÄÂßãÊâπÈáèÂèëÈÄÅ'}
          </button>
          
          <button
            type="button"
            style={S.buttonSecondary}
            onClick={() => window.history.back()}
          >
            ÂèñÊ∂à
          </button>
        </div>
      </form>

      {/* ÊâπÈáèÂèëÈÄÅÁä∂ÊÄÅÊ£ÄÊü• */}
      {currentBatchId && (
        <div style={S.form}>
          <h3 style={{ marginBottom: '16px', fontSize: '16px', fontWeight: 600 }}>üìä ÊâπÈáèÂèëÈÄÅÁä∂ÊÄÅ</h3>
          
          <div style={{ display: 'flex', gap: '12px', marginBottom: '16px' }}>
            <input
              type="text"
              style={{ ...S.input, flex: 1 }}
              placeholder="ÊâπÈáèÂèëÈÄÅ‰ªªÂä°ID"
              value={currentBatchId}
              onChange={(e) => setCurrentBatchId(e.target.value)}
            />
            <button
              type="button"
              style={S.button}
              onClick={handleCheckStatus}
              disabled={statusLoading}
            >
              {statusLoading ? 'Ê£ÄÊü•‰∏≠...' : 'Ê£ÄÊü•Áä∂ÊÄÅ'}
            </button>
            <button
              type="button"
              style={{
                ...S.button,
                ...(autoRefreshStatus ? S.buttonSecondary : {}),
              }}
              onClick={toggleAutoRefreshStatus}
            >
              {autoRefreshStatus ? '‚è∏Ô∏è ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞' : '‚ñ∂Ô∏è Ëá™Âä®Âà∑Êñ∞'}
            </button>
            {batchStatus && (batchStatus.status === 'running' || batchStatus.status === 'pending' || batchStatus.status === 'processing') && (
              <button
                type="button"
                style={{
                  ...S.button,
                  ...S.buttonDanger,
                  ...(cancelling ? S.buttonDisabled : {}),
                }}
                onClick={handleCancelBatch}
                disabled={cancelling}
              >
                {cancelling ? 'ÂèñÊ∂à‰∏≠...' : 'üõë ÂÅúÊ≠¢ÂèëÈÄÅ'}
              </button>
            )}
          </div>

          {batchStatus && (
            <div style={S.previewCard}>
              <div style={S.previewTitle}>‰ªªÂä°Áä∂ÊÄÅËØ¶ÊÉÖ</div>
              <div style={S.previewContent}>
                <div><strong>Áä∂ÊÄÅ:</strong> 
                  <span style={{ 
                    color: batchStatus.status === 'running' ? '#059669' : 
                           batchStatus.status === 'processing' ? '#059669' :
                           batchStatus.status === 'completed' ? '#059669' : 
                           batchStatus.status === 'cancelled' ? '#DC2626' : 
                           batchStatus.status === 'failed' ? '#DC2626' : '#6B7280',
                    fontWeight: 600
                  }}>
                    {batchStatus.status === 'running' ? 'üîÑ ËøêË°å‰∏≠' :
                     batchStatus.status === 'processing' ? 'üîÑ Â§ÑÁêÜ‰∏≠' :
                     batchStatus.status === 'completed' ? '‚úÖ Â∑≤ÂÆåÊàê' :
                     batchStatus.status === 'cancelled' ? '‚ùå Â∑≤ÂèñÊ∂à' :
                     batchStatus.status === 'failed' ? '‚ùå Â§±Ë¥•' :
                     batchStatus.status === 'pending' ? '‚è≥ Á≠âÂæÖ‰∏≠' : batchStatus.status}
                  </span>
                </div>
                <div><strong>ËøõÂ∫¶:</strong> {batchStatus.progress || 0}%</div>
                <div><strong>ÊÄªÊï∞:</strong> {batchStatus.totalCount || 0}</div>
                <div><strong>Â∑≤Â§ÑÁêÜ:</strong> {batchStatus.processedCount || 0}</div>
                <div><strong>ÊàêÂäü:</strong> {batchStatus.successCount || 0}</div>
                <div><strong>Â§±Ë¥•:</strong> {batchStatus.failedCount || 0}</div>
                {batchStatus.errorMessage && (
                  <div style={{ color: '#DC2626', marginTop: '8px' }}>
                    <strong>ÈîôËØØ‰ø°ÊÅØ:</strong> {batchStatus.errorMessage}
                  </div>
                )}
                {batchStatus.status === 'cancelled' && (
                  <div style={{ color: '#DC2626', marginTop: '8px', fontWeight: 600 }}>
                    ‚ö†Ô∏è ‰ªªÂä°Â∑≤Ë¢´Áî®Êà∑ÂèñÊ∂à
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      )}

      {/* ËÅîÁ≥ª‰∫∫ÈÄâÊã©ÂØπËØùÊ°Ü */}
      {showContactDialog && (
        <div style={S.dialogOverlay} onClick={handleContactDialogCancel}>
          <div style={S.dialogContent} onClick={(e) => e.stopPropagation()}>
            <div style={S.dialogHeader}>
              <h3 style={S.dialogTitle}>ÈÄâÊã©ËÅîÁ≥ª‰∫∫</h3>
              <button 
                style={S.dialogCloseButton}
                onClick={handleContactDialogCancel}
              >
                √ó
              </button>
            </div>
            
            {contactsLoading ? (
              <div style={S.loadingText}>Âä†ËΩΩËÅîÁ≥ª‰∫∫‰∏≠...</div>
            ) : (
              <>
                <div style={S.contactList}>
                  {contacts.map((contact) => (
                    <div
                      key={contact.id}
                      style={{
                        ...S.contactItem,
                        ...(selectedContactIds.includes(contact.id) ? S.contactItemSelected : {}),
                      }}
                      onClick={() => handleContactSelect(contact.id)}
                    >
                      <input
                        type="checkbox"
                        style={S.contactCheckbox}
                        checked={selectedContactIds.includes(contact.id)}
                        onChange={() => handleContactSelect(contact.id)}
                      />
                      <div style={S.contactInfo}>
                        <div style={S.contactName}>
                          {contact.name || contact.phoneE164 || 'Êú™Áü•ËÅîÁ≥ª‰∫∫'}
                        </div>
                        <div style={S.contactPhone}>
                          {contact.phoneE164}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
                
                <div style={S.dialogActions}>
                  <button
                    type="button"
                    style={S.buttonSecondary}
                    onClick={handleContactDialogCancel}
                  >
                    ÂèñÊ∂à
                  </button>
                  <button
                    type="button"
                    style={S.button}
                    onClick={handleContactDialogConfirm}
                  >
                    Á°ÆÂÆö ({selectedContactIds.length} ‰∏™ËÅîÁ≥ª‰∫∫)
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
