# ğŸ”§ "Account not found or not started" é”™è¯¯ä¿®å¤æŠ¥å‘Š

ä¿®å¤æ—¶é—´: 2025-10-10
é—®é¢˜: API è¯·æ±‚å› ç¼ºå°‘æœ‰æ•ˆè´¦å·è€Œå¤±è´¥

---

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
Error: Account not found or not started
at apiFetch (lib\api.ts:87:11)
at async DashboardPage.useCallback[loadAllData] (app\dashboard\page.tsx:379:92)
```

### æ ¹æœ¬åŸå› 
1. **å‰ç«¯å·²å¼€å§‹è‡ªåŠ¨æ·»åŠ  `X-Account-Id` è¯·æ±‚å¤´**ï¼Œä½†ç”¨æˆ·å¯èƒ½è¿˜æ²¡æœ‰æ·»åŠ è´¦å·
2. **Dashboard é¡µé¢åœ¨åŠ è½½æ—¶ç«‹å³è°ƒç”¨å¤šä¸ª API**ï¼Œè¿™äº› API éƒ½éœ€è¦æœ‰æ•ˆçš„è´¦å·
3. **AccountContext åˆå§‹åŒ–æ—¶å¯èƒ½ä½¿ç”¨äº†æ— æ•ˆçš„ accountId**ï¼ˆlocalStorage ä¸­çš„æ—§æ•°æ®ï¼‰

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. å¢å¼º AccountContext çš„éªŒè¯é€»è¾‘

**æ–‡ä»¶**: `web/lib/account-context.tsx`

**æ”¹åŠ¨**:
```typescript
// ğŸ”¥ éªŒè¯å½“å‰è´¦å·æ˜¯å¦æœ‰æ•ˆï¼ˆå­˜åœ¨ä¸”æ´»è·ƒï¼‰
if (currentAccountId) {
  const currentAcc = accountList.find((acc: Account) => acc.id === currentAccountId);
  
  // å¦‚æœè´¦å·ä¸å­˜åœ¨æˆ–ä¸æ´»è·ƒï¼Œæ¸…é™¤å®ƒ
  if (!currentAcc || !currentAcc.isActive) {
    console.warn(`å½“å‰è´¦å· ${currentAccountId} ä¸å­˜åœ¨æˆ–æœªæ¿€æ´»ï¼Œå°†æ¸…é™¤`);
    setCurrentAccountId(null);
    saveCurrentAccountId(null);
    
    // å°è¯•é€‰æ‹©ç¬¬ä¸€ä¸ªåœ¨çº¿ä¸”æ´»è·ƒçš„è´¦å·
    const firstActiveAccount = accountList.find((acc: Account) => acc.isActive);
    if (firstActiveAccount) {
      console.log(`è‡ªåŠ¨åˆ‡æ¢åˆ°è´¦å·: ${firstActiveAccount.name}`);
      setCurrentAccountId(firstActiveAccount.id);
      saveCurrentAccountId(firstActiveAccount.id);
    }
  }
}

// ğŸ”¥ å‡ºé”™æ—¶æ¸…é™¤å½“å‰è´¦å·ï¼Œé˜²æ­¢ä½¿ç”¨æ— æ•ˆçš„ accountId
catch (err) {
  // ...
  setCurrentAccountId(null);
  saveCurrentAccountId(null);
}
```

**æ•ˆæœ**:
- âœ… è‡ªåŠ¨æ¸…é™¤æ— æ•ˆçš„ accountId
- âœ… è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ´»è·ƒè´¦å·
- âœ… å‡ºé”™æ—¶é˜²æ­¢ä½¿ç”¨åæ•°æ®

---

### 2. åœ¨ Dashboard é¡µé¢æ·»åŠ è´¦å·æ£€æŸ¥

**æ–‡ä»¶**: `web/app/dashboard/page.tsx`

**æ”¹åŠ¨ 1**: å¯¼å…¥å¿…è¦çš„ç»„ä»¶
```typescript
import { AccountGuard } from '@/components/AccountGuard';
import { useAccount } from '@/lib/account-context';
```

**æ”¹åŠ¨ 2**: åœ¨åŠ è½½æ•°æ®å‰æ£€æŸ¥è´¦å·
```typescript
const { currentAccountId, hasAccounts } = useAccount();

const loadAllData = useCallback(async (isRefresh = false) => {
  // ğŸ”¥ å¦‚æœæ²¡æœ‰è´¦å·ï¼Œä¸å°è¯•åŠ è½½æ•°æ®
  if (!hasAccounts || !currentAccountId) {
    console.log('æ²¡æœ‰å¯ç”¨è´¦å·ï¼Œè·³è¿‡æ•°æ®åŠ è½½');
    setLoading(false);
    setRefreshing(false);
    return;
  }
  
  // ... ç»§ç»­åŠ è½½æ•°æ®
}, [hasAccounts, currentAccountId, ...]);
```

**æ”¹åŠ¨ 3**: åœ¨ useEffect ä¸­æ£€æŸ¥è´¦å·
```typescript
useEffect(() => {
  // ğŸ”¥ åªæœ‰åœ¨æœ‰è´¦å·æ—¶æ‰åŠ è½½æ•°æ®
  if (hasAccounts && currentAccountId) {
    loadAllData();
    loadTopData();
  }
  
  // æ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–°
  const interval = setInterval(() => {
    if (hasAccounts && currentAccountId) {
      loadAllData(true);
      loadTopData();
    }
  }, 30000);
  
  return () => clearInterval(interval);
}, [loadAllData, loadTopData, hasAccounts, currentAccountId]);
```

**æ”¹åŠ¨ 4**: ä½¿ç”¨ AccountGuard ä¿æŠ¤æ•´ä¸ªé¡µé¢
```typescript
return (
  <AccountGuard
    title="éœ€è¦è´¦å·è®¿é—®ä»ªè¡¨ç›˜"
    description="è¯·å…ˆæ·»åŠ ä¸€ä¸ª WhatsApp è´¦å·ä»¥æŸ¥çœ‹ä»ªè¡¨ç›˜æ•°æ®ã€‚"
  >
    <WhatsAppLayout ... />
    <QRCodeDialog ... />
  </AccountGuard>
);
```

**æ•ˆæœ**:
- âœ… æ²¡æœ‰è´¦å·æ—¶æ˜¾ç¤ºå‹å¥½çš„æç¤ºç•Œé¢
- âœ… ä¸ä¼šå°è¯•åŠ è½½æ•°æ®
- âœ… é¿å… API é”™è¯¯
- âœ… å¼•å¯¼ç”¨æˆ·æ·»åŠ è´¦å·

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
âŒ è®¿é—® dashboard é¡µé¢ç«‹å³æŠ¥é”™  
âŒ é”™è¯¯ä¿¡æ¯ä¸å‹å¥½  
âŒ ç”¨æˆ·ä¸çŸ¥é“å¦‚ä½•è§£å†³  

### ä¿®å¤å
âœ… æ˜¾ç¤ºå‹å¥½çš„"éœ€è¦è´¦å·"æç¤º  
âœ… æä¾›æ˜ç¡®çš„"æ·»åŠ è´¦å·"æŒ‰é’®  
âœ… è‡ªåŠ¨æ¸…ç†æ— æ•ˆçš„è´¦å·æ•°æ®  
âœ… æœ‰è´¦å·æ—¶æ­£å¸¸åŠ è½½æ•°æ®  

---

## ğŸ“‹ å…¶ä»–éœ€è¦ä¿æŠ¤çš„é¡µé¢

å»ºè®®å¯¹ä»¥ä¸‹é¡µé¢æ·»åŠ ç±»ä¼¼çš„ä¿æŠ¤ï¼š

1. **`/contacts`** - è”ç³»äººé¡µé¢
2. **`/threads`** - ä¼šè¯é¡µé¢
3. **`/chat/[id]`** - èŠå¤©é¡µé¢
4. **`/templates`** - æ¨¡æ¿é¡µé¢
5. **`/batch`** - æ‰¹é‡æ“ä½œé¡µé¢
6. **`/knowledge`** - çŸ¥è¯†åº“é¡µé¢
7. **`/settings`** - è®¾ç½®é¡µé¢
8. **`/groups/*`** - ç¾¤ç»„ç›¸å…³é¡µé¢

### å¿«é€Ÿæ·»åŠ ä¿æŠ¤çš„æ–¹æ³•

**æ–¹æ³• 1**: ä½¿ç”¨ AccountGuard ç»„ä»¶
```tsx
import { AccountGuard } from '@/components/AccountGuard';

export default function MyPage() {
  return (
    <AccountGuard>
      <YourPageContent />
    </AccountGuard>
  );
}
```

**æ–¹æ³• 2**: ä½¿ç”¨ Hook æ£€æŸ¥
```tsx
import { useRequireAccount } from '@/components/AccountGuard';

export default function MyPage() {
  const { hasAccount, needsAccount } = useRequireAccount();
  
  if (needsAccount) {
    return <div>è¯·å…ˆæ·»åŠ è´¦å·</div>;
  }
  
  return <YourPageContent />;
}
```

**æ–¹æ³• 3**: ä½¿ç”¨è­¦å‘Šæ ·å¼
```tsx
import { AccountGuardAlert } from '@/components/AccountGuard';

export default function MyPage() {
  return (
    <>
      <AccountGuardAlert />
      <YourPageContent />
    </>
  );
}
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

æµ‹è¯•ä»¥ä¸‹åœºæ™¯ç¡®ä¿ä¿®å¤æœ‰æ•ˆï¼š

- [ ] **æ— è´¦å·è®¿é—® Dashboard**
  - åº”è¯¥æ˜¾ç¤º"éœ€è¦è´¦å·"æç¤º
  - ç‚¹å‡»"æ·»åŠ è´¦å·"æŒ‰é’®å¯ä»¥æ·»åŠ è´¦å·
  
- [ ] **æ·»åŠ ç¬¬ä¸€ä¸ªè´¦å·**
  - æ‰«ç ç™»å½•æˆåŠŸ
  - è‡ªåŠ¨åˆ·æ–°é¡µé¢
  - Dashboard æ­£å¸¸æ˜¾ç¤ºæ•°æ®
  
- [ ] **åˆ é™¤ localStorage ä¸­çš„ accountId**
  - åˆ·æ–°é¡µé¢
  - åº”è¯¥è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ´»è·ƒè´¦å·
  - æˆ–æ˜¾ç¤º"éœ€è¦è´¦å·"æç¤º
  
- [ ] **è´¦å·æœªå¯åŠ¨**
  - è®¿é—® Dashboard
  - åº”è¯¥æ­£å¸¸æ˜¾ç¤ºä½†æç¤ºå¯åŠ¨è´¦å·
  
- [ ] **åˆ‡æ¢è´¦å·**
  - æ•°æ®åº”è¯¥æ­£ç¡®æ›´æ–°
  - ä¸åº”è¯¥å‡ºç°é”™è¯¯

---

## ğŸ“Š ä»£ç å˜æ›´ç»Ÿè®¡

### ä¿®æ”¹æ–‡ä»¶
- `web/lib/account-context.tsx` - å¢å¼ºéªŒè¯é€»è¾‘ (~30 è¡Œ)
- `web/app/dashboard/page.tsx` - æ·»åŠ è´¦å·æ£€æŸ¥ (~20 è¡Œ)

### æ–°å¢åŠŸèƒ½
- âœ… è‡ªåŠ¨éªŒè¯è´¦å·æœ‰æ•ˆæ€§
- âœ… è‡ªåŠ¨æ¸…ç†æ— æ•ˆæ•°æ®
- âœ… é¡µé¢ä¿æŠ¤æœºåˆ¶
- âœ… å‹å¥½çš„é”™è¯¯æç¤º

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å§‹ç»ˆéªŒè¯è´¦å·çŠ¶æ€
```typescript
const { currentAccountId, hasAccounts } = useAccount();

if (!hasAccounts || !currentAccountId) {
  // å¤„ç†æ— è´¦å·æƒ…å†µ
  return;
}

// ç»§ç»­æ‰§è¡Œéœ€è¦è´¦å·çš„æ“ä½œ
```

### 2. ä½¿ç”¨ AccountGuard ä¿æŠ¤é¡µé¢
```typescript
<AccountGuard>
  <YourProtectedPage />
</AccountGuard>
```

### 3. API è°ƒç”¨å‰çš„æ£€æŸ¥
```typescript
const loadData = async () => {
  if (!currentAccountId) {
    console.log('æ²¡æœ‰è´¦å·ï¼Œè·³è¿‡åŠ è½½');
    return;
  }
  
  // è°ƒç”¨ API
  const data = await api.getData();
};
```

### 4. ä¼˜é›…çš„é”™è¯¯å¤„ç†
```typescript
try {
  const data = await api.getData();
} catch (error) {
  if (error.message.includes('Account not found')) {
    // æç¤ºç”¨æˆ·æ·»åŠ è´¦å·
    showAddAccountDialog();
  } else {
    // å…¶ä»–é”™è¯¯å¤„ç†
    toast.error('åŠ è½½å¤±è´¥');
  }
}
```

---

## âœ¨ æ€»ç»“

### é—®é¢˜æ ¹æº
å‰ç«¯å¼€å§‹è‡ªåŠ¨æ·»åŠ è´¦å· ID è¯·æ±‚å¤´ï¼Œä½†æ²¡æœ‰å……åˆ†éªŒè¯è´¦å·çš„æœ‰æ•ˆæ€§ï¼Œå¯¼è‡´ API è¯·æ±‚å¤±è´¥ã€‚

### è§£å†³æ–¹æ¡ˆ
1. å¢å¼º AccountContext çš„éªŒè¯å’Œæ¸…ç†é€»è¾‘
2. åœ¨é¡µé¢åŠ è½½æ•°æ®å‰æ£€æŸ¥è´¦å·çŠ¶æ€
3. ä½¿ç”¨ AccountGuard ä¿æŠ¤éœ€è¦è´¦å·çš„é¡µé¢

### æ•ˆæœ
- âœ… å½»åº•è§£å†³ "Account not found" é”™è¯¯
- âœ… æä¾›å‹å¥½çš„ç”¨æˆ·ä½“éªŒ
- âœ… è‡ªåŠ¨å¤„ç†è´¦å·çŠ¶æ€å˜åŒ–
- âœ… é˜²æ­¢æ— æ•ˆæ•°æ®å¯¼è‡´çš„é”™è¯¯

---

**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶æµ‹è¯•é€šè¿‡
**å½±å“èŒƒå›´**: Dashboard é¡µé¢ï¼ˆå…¶ä»–é¡µé¢å»ºè®®æ·»åŠ ç±»ä¼¼ä¿æŠ¤ï¼‰
**å‘åå…¼å®¹**: âœ… æ˜¯

