# 🔍 群组聊天 - 快速诊断指南

## 问题
1. ❌ 群组聊天页面不能实时显示媒体文件预览
2. ❌ 表情选择器点不动

## 🧪 快速诊断步骤

### 1. 清除浏览器缓存并刷新

```bash
# 在浏览器中
1. 按 Ctrl + Shift + Delete
2. 选择"缓存的图片和文件"
3. 点击"清除数据"
4. 或者直接按 Ctrl + F5 强制刷新
```

### 2. 检查前端是否更新

打开浏览器控制台（F12），执行：
```javascript
// 检查表情选择器代码
console.log('检查 useEffect 代码');
```

### 3. 检查 WebSocket 连接

在控制台查找：
```
✅ WebSocket 已连接成功！
```

### 4. 测试接收群组消息

1. 打开 `http://localhost:3000/groups/chat`
2. 选择一个群组
3. 从另一个设备向该群组发送图片
4. 观察控制台输出：

**期望看到**:
```javascript
📨 [Hook] 收到群组消息事件: {
  groupId: "cmgm1zxyg000gwsw0n8gvh3s7",
  groupName: "测试群",
  messageId: "...",
  from: "...",
  fromName: "...",
  body: "[图片]",
  text: "[图片]",
  mediaType: "image",
  mediaUrl: "/media/files/...",        // ✅ 必需
  mediaFileName: "...",                // ✅ 必需
  mediaMimeType: "image/jpeg",
  thumbnailUrl: "/media/thumbnails/...",
  timestamp: 1760173768198
}

📨 收到群组消息 WebSocket 事件: {...}
🔍 当前选中群组: { id: "cmgm1zxyg000gwsw0n8gvh3s7", ... }
✅ 消息属于当前群组，添加到消息列表
```

**如果看到**:
```javascript
📨 收到群组消息 WebSocket 事件: {...}
⚠️ 消息不属于当前群组，忽略
```
说明 `groupId` 不匹配。

### 5. 测试发送群组消息

1. 在群组聊天页面
2. 点击 📎 按钮
3. 选择一张图片
4. 观察控制台输出：

**期望看到**:
```javascript
✅ 上传成功: {
  mediaFileName: "...",
  mediaUrl: "/media/files/...",
  mediaType: "image",
  ...
}

📎 开始发送群组媒体文件: {...}
```

### 6. 测试表情选择器

1. 点击 😊 按钮
2. 观察控制台输出：

**期望看到**:
```javascript
🔥 表情按钮点击, 当前状态: false
📍 按钮位置: DOMRect {...}
```

3. 查看表情面板是否显示
4. 点击一个表情
5. 期望看到：
```javascript
😊 添加表情: 😀
```

---

## 🔧 如果问题仍然存在

### 检查前端版本

运行此命令检查前端 `groups/chat/page.tsx` 的修改时间：
```bash
ls -l web/app/groups/chat/page.tsx
```

### 重新编译前端

```bash
# 停止前端
# Ctrl + C

# 删除缓存
rm -rf .next

# 重新启动
npm run dev
```

### 检查后端 WebSocket 广播

查找后端日志中的：
```
📨 群组消息已广播到前端
```

然后检查广播的数据是否包含所有字段。

---

## ✅ 快速修复命令

### 前端
```bash
# 1. 停止前端 (Ctrl + C)

# 2. 清除 Next.js 缓存
Remove-Item -Recurse -Force .next -ErrorAction SilentlyContinue

# 3. 重新启动
npm run dev
```

### 后端
```bash
cd server

# 1. 确认编译成功
npm run build

# 2. 重启后端 (Ctrl + C 然后重新启动)
npm run dev
```

---

## 🐛 常见问题

### 问题 1: 表情面板一闪而过

**原因**: 浏览器缓存了旧的 JavaScript 代码

**解决**: 
1. Ctrl + Shift + Delete 清除缓存
2. Ctrl + F5 强制刷新
3. 或者在浏览器地址栏输入 `chrome://restart`

### 问题 2: 媒体消息不显示

**检查项**:
1. ✅ WebSocket 是否连接成功
2. ✅ 是否收到 `group_message` 事件
3. ✅ 事件中是否包含 `mediaUrl` 字段
4. ✅ `groupId` 是否匹配

### 问题 3: 控制台没有任何输出

**原因**: WebSocket 未连接或前端代码未更新

**解决**:
1. 检查 WebSocket 连接
2. 清除浏览器缓存
3. 删除 `.next` 文件夹重新编译

---

## 📋 完整测试清单

### 前端测试
- [ ] 浏览器缓存已清除
- [ ] 页面强制刷新 (Ctrl + F5)
- [ ] 控制台显示 WebSocket 连接成功
- [ ] 选择群组后显示群组名称
- [ ] 点击表情按钮有控制台输出
- [ ] 表情面板显示出来
- [ ] 点击表情插入到输入框

### 后端测试
- [ ] 后端编译成功 (`npm run build`)
- [ ] 后端服务运行中
- [ ] 后端日志显示 WebSocket 连接
- [ ] 接收群组消息时有日志
- [ ] 日志显示"群组消息已广播到前端"

### 消息测试
- [ ] 从另一设备发送文本消息
- [ ] 前端实时显示文本消息
- [ ] 从另一设备发送图片
- [ ] 前端实时显示图片
- [ ] 点击图片可以全屏查看

---

## 🚀 终极解决方案

如果上述都不行，执行完整重启：

```bash
# 1. 停止前端和后端 (Ctrl + C)

# 2. 清除前端缓存
Remove-Item -Recurse -Force .next -ErrorAction SilentlyContinue

# 3. 重新编译后端
cd server
npm run build

# 4. 启动后端
npm run dev

# 5. 在另一个终端启动前端
cd ..
npm run dev

# 6. 清除浏览器缓存并刷新页面 (Ctrl + Shift + Delete)
```

---

**完成后请反馈控制台输出！** 📊

