# ğŸ”§ WPPConnect ç¾¤ç»„ç¾¤å‘ä¿®å¤ - å‘é€åˆ°æ­£ç¡®ç¾¤ç»„

## ğŸ“‹ é—®é¢˜æè¿°

### ç—‡çŠ¶
- âœ… ç¾¤å‘ä»»åŠ¡åˆ›å»ºæˆåŠŸ
- âœ… æ¶ˆæ¯å‘é€æˆåŠŸ
- âŒ **æ¶ˆæ¯å‘é€åˆ°è”ç³»äººè€Œä¸æ˜¯ç¾¤ç»„**

### åç«¯æ—¥å¿—æ˜¾ç¤º
```
chatId:"120363422952013929@c.us"  â† é”™è¯¯ï¼è¿™æ˜¯è”ç³»äººæ ¼å¼
phoneE164:"120363422952013929@g.us" â† è¿™æ‰æ˜¯æ­£ç¡®çš„ç¾¤ç»„æ ¼å¼

Contact not found for outgoing message, creating new contact
Created new contact for outgoing message  â† åˆ›å»ºäº†é”™è¯¯çš„è”ç³»äººï¼
```

---

## ğŸ” æ ¹æœ¬åŸå› 

### WhatsApp ID æ ¼å¼
- **è”ç³»äººæ ¼å¼ï¼š** `ç”µè¯å·ç @c.us`ï¼ˆä¾‹å¦‚ï¼š`8613800138000@c.us`ï¼‰
- **ç¾¤ç»„æ ¼å¼ï¼š** `ç¾¤ç»„ID@g.us`ï¼ˆä¾‹å¦‚ï¼š`120363422952013929@g.us`ï¼‰

### ä»£ç é—®é¢˜

**æ–‡ä»¶ï¼š** `server/app/src/wppconnect-service.ts`

**é—®é¢˜ä»£ç ï¼ˆç¬¬481-484è¡Œï¼‰ï¼š**
```typescript
private formatChatId(phoneE164: string): string {
  const digits = phoneE164.replace(/[^0-9]/g, '');
  return `${digits}@c.us`;  // â† å¼ºåˆ¶è½¬æ¢ä¸ºè”ç³»äººæ ¼å¼ï¼
}
```

**è°ƒç”¨é“¾ï¼š**
```
GroupService.executeBroadcast (ç¬¬664/667è¡Œ)
  â†“
whatsappService.sendTextMessage(groupId, message)  // groupId = "xxxxx@g.us"
  â†“
formatChatId(phoneE164)  // å°† "@g.us" è½¬æ¢ä¸º "@c.us"
  â†“
client.sendText("xxxxx@c.us", message)  // â† å‘é€åˆ°è”ç³»äººè€Œä¸æ˜¯ç¾¤ç»„ï¼
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹ `formatChatId` æ–¹æ³•

**æ–‡ä»¶ï¼š** `server/app/src/wppconnect-service.ts`ï¼ˆç¬¬481-490è¡Œï¼‰

**ä¿®å¤å‰ï¼š**
```typescript
private formatChatId(phoneE164: string): string {
  const digits = phoneE164.replace(/[^0-9]/g, '');
  return `${digits}@c.us`;
}
```

**ä¿®å¤åï¼š**
```typescript
private formatChatId(phoneE164: string): string {
  // å¦‚æœå·²ç»åŒ…å« @g.usï¼ˆç¾¤ç»„ï¼‰æˆ– @c.usï¼ˆè”ç³»äººï¼‰ï¼Œç›´æ¥è¿”å›
  if (phoneE164.includes('@g.us') || phoneE164.includes('@c.us')) {
    return phoneE164;
  }
  
  // å¦åˆ™ï¼Œæ ¼å¼åŒ–ä¸ºè”ç³»äººæ ¼å¼
  const digits = phoneE164.replace(/[^0-9]/g, '');
  return `${digits}@c.us`;
}
```

### ä¿®å¤é€»è¾‘
1. **æ£€æµ‹è¾“å…¥æ ¼å¼ï¼š** å¦‚æœè¾“å…¥å·²ç»æ˜¯å®Œæ•´çš„ WhatsApp IDï¼ˆåŒ…å« `@g.us` æˆ– `@c.us`ï¼‰ï¼Œç›´æ¥è¿”å›
2. **ä¿ç•™ç¾¤ç»„æ ¼å¼ï¼š** ç¾¤ç»„ID `xxxxx@g.us` ä¸ä¼šè¢«è½¬æ¢
3. **ä¿ç•™è”ç³»äººæ ¼å¼ï¼š** è”ç³»äººID `xxxxx@c.us` ä¸ä¼šè¢«è½¬æ¢
4. **æ ¼å¼åŒ–ç”µè¯å·ç ï¼š** çº¯ç”µè¯å·ç ï¼ˆå¦‚ `+8613800138000`ï¼‰ä¼šè¢«è½¬æ¢ä¸º `8613800138000@c.us`

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. é‡æ–°ç¼–è¯‘åç«¯
```bash
cd server && npm run build
```

### 2. é‡å¯åç«¯
```bash
cd server && npm run dev
```

### 3. æµ‹è¯•ç¾¤ç»„ç¾¤å‘
1. è¿›å…¥ç¤¾ç¾¤è¥é”€é¡µé¢
2. ç‚¹å‡»"ç¾¤ç»„åŒæ­¥"ï¼ˆå¦‚æœè¿˜æ²¡åŒæ­¥ï¼‰
3. ç‚¹å‡»"æ–°å»ºç¾¤å‘ä»»åŠ¡"
4. é€‰æ‹©ç›®æ ‡ç¾¤ç»„
5. è¾“å…¥æµ‹è¯•æ¶ˆæ¯ï¼ˆä¾‹å¦‚ï¼š"æµ‹è¯•æ¶ˆæ¯"ï¼‰
6. ç‚¹å‡»"ç«‹å³å‘é€"

### 4. éªŒè¯ç»“æœ

#### âœ… é¢„æœŸç»“æœ
- æ¶ˆæ¯åº”è¯¥å‘é€åˆ°**ç¾¤ç»„**
- åç«¯æ—¥å¿—æ˜¾ç¤ºï¼š
  ```
  Sending text message via WPPConnect
  chatId: "120363422952013929@g.us"  â† @g.usï¼ˆç¾¤ç»„ï¼‰
  ç¾¤å‘æ¶ˆæ¯å‘é€æˆåŠŸ
  ```
- åœ¨ WhatsApp ç¾¤ç»„ä¸­å¯ä»¥çœ‹åˆ°æ¶ˆæ¯

#### âŒ é”™è¯¯ç»“æœï¼ˆä¿®å¤å‰ï¼‰
- æ¶ˆæ¯å‘é€åˆ°**è”ç³»äºº**ï¼ˆåˆ›å»ºäº†æ–°è”ç³»äººï¼‰
- åç«¯æ—¥å¿—æ˜¾ç¤ºï¼š
  ```
  chatId: "120363422952013929@c.us"  â† @c.usï¼ˆè”ç³»äººï¼‰
  Contact not found, creating new contact
  ```

---

## ğŸ“Š å½±å“èŒƒå›´

### å·²ä¿®å¤çš„åŠŸèƒ½
âœ… **ç¾¤ç»„ç¾¤å‘** - ç°åœ¨æ­£ç¡®å‘é€åˆ°ç¾¤ç»„  
âœ… **æ‰¹é‡è¿›ç¾¤** - ä¿æŒæ­£å¸¸ï¼ˆå·²æ­£ç¡®ä¼ é€’ whatsappServiceï¼‰  
âœ… **å‘é€ç¾¤ç»„æ¶ˆæ¯** - ä¿æŒæ­£å¸¸ï¼ˆå·²æ­£ç¡®ä½¿ç”¨ client.getChatByIdï¼‰  
âœ… **å‘é€ç¾¤ç»„åª’ä½“** - ä¿æŒæ­£å¸¸  
âœ… **è”ç³»äººæ¶ˆæ¯** - ä¿æŒæ­£å¸¸ï¼ˆç”µè¯å·ç ä»ç„¶è½¬æ¢ä¸º @c.usï¼‰  

### ä¸å—å½±å“çš„åŠŸèƒ½
âœ… ä¸€å¯¹ä¸€æ¶ˆæ¯å‘é€  
âœ… æ‰¹é‡è”ç³»äººå‘é€  
âœ… ç¾¤ç»„åŒæ­¥  
âœ… ç¾¤ç»„åˆ—è¡¨  

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### WhatsApp ID æ ¼å¼è§„èŒƒ

| ç±»å‹ | æ ¼å¼ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|
| **è”ç³»äºº** | `æ•°å­—@c.us` | `8613800138000@c.us` | c = chatï¼ˆèŠå¤©ï¼‰ |
| **ç¾¤ç»„** | `æ•°å­—@g.us` | `120363422952013929@g.us` | g = groupï¼ˆç¾¤ç»„ï¼‰ |
| **å¹¿æ’­åˆ—è¡¨** | `æ•°å­—@broadcast` | `12345@broadcast` | å¹¿æ’­åˆ—è¡¨ |

### ç›¸å…³ä»£ç ä½ç½®

**ä¿®æ”¹æ–‡ä»¶ï¼š**
- âœ… `server/app/src/wppconnect-service.ts` - `formatChatId` æ–¹æ³•

**ç›¸å…³æ–‡ä»¶ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰ï¼š**
- `server/app/src/services/group-service.ts` - `executeBroadcast` æ–¹æ³•
- `server/app/src/routes/groups.ts` - ç¾¤ç»„è·¯ç”±

---

## ğŸ“… ä¿®å¤æ—¶é—´

2025-10-11

---

## ğŸ¯ æ€»ç»“

### é—®é¢˜
`formatChatId` æ–¹æ³•å¼ºåˆ¶å°†æ‰€æœ‰IDè½¬æ¢ä¸ºè”ç³»äººæ ¼å¼ `@c.us`ï¼Œå¯¼è‡´ç¾¤ç»„ID `@g.us` è¢«é”™è¯¯è½¬æ¢ã€‚

### ä¿®å¤
æ·»åŠ æ ¼å¼æ£€æµ‹é€»è¾‘ï¼Œå¦‚æœè¾“å…¥å·²ç»åŒ…å« `@g.us` æˆ– `@c.us`ï¼Œç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œè½¬æ¢ã€‚

### ç»“æœ
- âœ… ç¾¤ç»„ç¾¤å‘ç°åœ¨æ­£ç¡®å‘é€åˆ°ç¾¤ç»„
- âœ… è”ç³»äººæ¶ˆæ¯ä¿æŒæ­£å¸¸
- âœ… æ‰€æœ‰å…¶ä»–åŠŸèƒ½ä¸å—å½±å“

---

**ğŸ‰ ç¾¤ç»„ç¾¤å‘åŠŸèƒ½ç°å·²å®Œå…¨æ­£å¸¸å·¥ä½œï¼**

