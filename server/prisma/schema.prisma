generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== å¤šè´¦å·æ”¯æŒ ====================

model Account {
  id          String    @id @default(cuid())
  name        String                          // è´¦å·åç§°ï¼Œå¦‚"å®¢æœè´¦å·"
  phoneNumber String?                         // WhatsAppå·ç 
  status      String    @default("offline")   // online, offline, connecting
  sessionPath String    @unique               // ä¼šè¯æ•°æ®å­˜å‚¨è·¯å¾„
  isActive    Boolean   @default(true)        // æ˜¯å¦å¯ç”¨
  lastOnline  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // å…³è”æ•°æ®
  contacts          Contact[]
  threads           Thread[]
  messages          Message[]
  templates         MessageTemplate[]
  knowledgeBases    KnowledgeBase[]
  campaigns         Campaign[]
  groups            WhatsAppGroup[]
  batchOperations   BatchOperation[]
  translations      Translation[]
  joinGroupTasks    JoinGroupTask[]
  groupBroadcasts   GroupBroadcast[]
  
  @@index([status, isActive])
}

enum MessageDirection {
  IN
  OUT
}

enum MessageStatus {
  SENT
  FAILED
  QUEUED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  DONE
  CANCELLED
}

enum CampaignRecipientStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  SKIPPED
}

model Contact {
  consent        Boolean   @default(true)
  optedOutAt     DateTime?
  tags           Json?     // è”ç³»äººæ ‡ç­¾
  source         String?   // å¯¼å…¥æ¥æº
  importBatchId  String?   // æ‰¹é‡å¯¼å…¥æ‰¹æ¬¡ID
  notes          String?   // å¤‡æ³¨ä¿¡æ¯
  avatarUrl      String?   // å¤´åƒURL

  id             String    @id @default(cuid())
  phoneE164      String
  name           String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  accountId      String
  account        Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  threads        Thread[]
  campaignRecipients CampaignRecipient[]
  
  @@unique([accountId, phoneE164])
  @@index([accountId])
}

model Thread {
  id           String    @id @default(cuid())
  contactId    String    @unique
  aiEnabled    Boolean   @default(false)
  autoTranslate Boolean  @default(false) // æ˜¯å¦å¯ç”¨è‡ªåŠ¨ç¿»è¯‘
  takenOver    Boolean   @default(false)
  takenOverAt  DateTime?
  lastHumanAt  DateTime?
  lastBotAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  accountId    String
  account      Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  contact      Contact   @relation(fields: [contactId], references: [id])
  messages     Message[]

  // ä¼šè¯ç½®é¡¶
  isPinned     Boolean   @default(false)
  pinnedAt     DateTime?

  // ä¼šè¯å½’æ¡£
  isArchived   Boolean   @default(false)
  archivedAt   DateTime?

  // ä¼šè¯æ ‡ç­¾
  labels       Json?     // ["é”€å”®", "å®¢æœ", "VIP"]

  // æœªè¯»æ¶ˆæ¯
  unreadCount  Int       @default(0)
  lastReadAt   DateTime?

  // è‰ç¨¿
  draft        String?   // æœªå‘é€çš„è‰ç¨¿å†…å®¹
  draftUpdatedAt DateTime?

  // ä¼šè¯å¤‡æ³¨
  notes        String?

  @@index([accountId])
  @@index([isPinned, updatedAt])
  @@index([isArchived])
}

model Message {
  id          String           @id @default(cuid())
  threadId    String
  externalId  String?
  direction   MessageDirection
  text        String?
  translatedText String?       // ç¿»è¯‘åçš„æ–‡æœ¬
  status      MessageStatus    @default(SENT)
  createdAt   DateTime         @default(now())
  
  accountId   String
  account     Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  thread      Thread           @relation(fields: [threadId], references: [id])

  // åª’ä½“æ–‡ä»¶æ”¯æŒ
  mediaUrl         String?        // åª’ä½“æ–‡ä»¶URL
  mediaType        String?        // ç±»å‹: image, document, audio, video
  mediaMimeType    String?        // MIMEç±»å‹
  mediaSize        Int?           // æ–‡ä»¶å¤§å°(å­—èŠ‚)
  mediaFileName    String?        // æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶å(å”¯ä¸€)
  originalFileName String?        // å®¢æˆ·ç«¯åŸå§‹æ–‡ä»¶å(ç”¨äºæ˜¾ç¤º)
  thumbnailUrl     String?        // ç¼©ç•¥å›¾URL(ç”¨äºå›¾ç‰‡/è§†é¢‘)
  duration         Int?           // éŸ³è§†é¢‘æ—¶é•¿(ç§’)

  // æ¶ˆæ¯å¼•ç”¨
  replyToId     String?        // å¼•ç”¨çš„æ¶ˆæ¯ID
  replyTo       Message?       @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies       Message[]      @relation("MessageReplies")

  // æ¶ˆæ¯ç¼–è¾‘
  isEdited      Boolean        @default(false)
  editedAt      DateTime?
  originalText  String?        // ç¼–è¾‘å‰çš„åŸæ–‡

  // æ¶ˆæ¯åˆ é™¤
  isDeleted     Boolean        @default(false)
  deletedAt     DateTime?
  deletedBy     String?        // åˆ é™¤è€…(å¯¹æ–¹/è‡ªå·±)

  // æ¶ˆæ¯è½¬å‘
  isForwarded   Boolean        @default(false)
  forwardedFrom String?        // åŸå§‹å‘é€è€…ä¿¡æ¯

  // æ¶ˆæ¯æ ‡è®°
  isStarred     Boolean        @default(false)
  starredAt     DateTime?

  // æ¶ˆæ¯çŠ¶æ€æ‰©å±•
  deliveredAt   DateTime?      // é€è¾¾æ—¶é—´
  readAt        DateTime?      // å·²è¯»æ—¶é—´

  @@unique([accountId, externalId])
  @@index([accountId])
  @@index([threadId, createdAt])
  @@index([replyToId])
}

model AiConfig {
  id           String   @id @default("global")
  systemPrompt String
  maxTokens    Int      @default(384)
  temperature  Float    @default(0.4)
  minChars     Int      @default(80)
  stylePreset  String   @default("concise-cn")
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())
}

// æ‰©å±•çš„MessageTemplateæ¨¡å‹
model MessageTemplate {
  id          String   @id @default(cuid())
  name        String
  content     String
  description String?  // æ¨¡æ¿æè¿°
  category    String   @default("general") // æ¨¡æ¿åˆ†ç±»
  tags        Json?    // æ ‡ç­¾æ•°ç»„
  variables   Json?    // å˜é‡æ•°ç»„
  isActive    Boolean  @default(true) // æ˜¯å¦æ¿€æ´»
  usageCount  Int      @default(0) // ä½¿ç”¨æ¬¡æ•°
  lastUsedAt  DateTime? // æœ€åä½¿ç”¨æ—¶é—´
  sortOrder   Int      @default(0) // æ’åºé¡ºåº
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  accountId   String
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  campaigns   Campaign[]

  @@index([accountId])
  @@index([category, isActive])
  @@index([usageCount, lastUsedAt])
}

// æ¨¡æ¿åˆ†ç±»æ¨¡å‹
model TemplateCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  icon        String?  // å›¾æ ‡
  color       String?  // é¢œè‰²
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Campaign {
  id             String          @id @default(cuid())
  name           String
  templateId     String?
  content        String?
  scheduleAt     DateTime?
  ratePerMinute  Int             @default(8)
  jitterMs       Int             @default(300)
  status         CampaignStatus  @default(DRAFT)
  total          Int             @default(0)
  sent           Int             @default(0)
  failed         Int             @default(0)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  accountId      String
  account        Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  template       MessageTemplate? @relation(fields: [templateId], references: [id])
  recipients     CampaignRecipient[]
  
  @@index([accountId])
}

model CampaignRecipient {
  id         String                    @id @default(cuid())
  campaignId String
  contactId  String?
  phoneE164  String
  status     CampaignRecipientStatus   @default(PENDING)
  lastError  String?
  sentAt     DateTime?
  tries      Int                       @default(0)
  maxTries   Int                       @default(3)
  createdAt  DateTime                  @default(now())
  updatedAt  DateTime                  @updatedAt
  campaign   Campaign                  @relation(fields: [campaignId], references: [id])
  contact    Contact?                  @relation(fields: [contactId], references: [id])

  @@index([campaignId, status])
}

// æ‰¹é‡æ“ä½œè®°å½•è¡¨
model BatchOperation {
  id            String    @id @default(cuid())
  type          String    // 'import', 'send', 'tag', 'delete', 'archive'
  status        String    @default("pending") // 'pending', 'processing', 'completed', 'failed', 'cancelled'
  title         String
  description   String?
  totalCount    Int       @default(0)
  processedCount Int      @default(0)
  successCount  Int       @default(0)
  failedCount   Int       @default(0)
  config        Json?     // é…ç½®ä¿¡æ¯
  result        Json?     // ç»“æœä¿¡æ¯
  errorMessage  String?
  progress      Int       @default(0) // 0-100
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  startedAt     DateTime?
  completedAt   DateTime?
  createdBy     String    @default("system")
  
  accountId     String
  account       Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  items         BatchOperationItem[]

  @@index([accountId])
  @@index([type, status])
}

// æ‰¹é‡æ“ä½œæ˜ç»†è¡¨
model BatchOperationItem {
  id           String    @id @default(cuid())
  batchId      String
  itemIndex    Int
  itemData     Json?     // é¡¹ç›®æ•°æ®
  status       String    @default("pending") // 'pending', 'processing', 'completed', 'failed', 'skipped'
  errorMessage String?
  result       Json?     // å¤„ç†ç»“æœ
  processedAt  DateTime?
  createdAt    DateTime  @default(now())
  batch        BatchOperation @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId, status])
}

// çŸ¥è¯†åº“è¡¨
model KnowledgeBase {
  id          String    @id @default(cuid())
  title       String
  content     String
  category    String    @default("general")
  tags        Json?     // æ ‡ç­¾æ•°ç»„
  keywords    Json?     // å…³é”®è¯æ•°ç»„
  priority    Int       @default(0) // ä¼˜å…ˆçº§
  usageCount  Int       @default(0) // ä½¿ç”¨æ¬¡æ•°
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String    @default("system")
  
  accountId   String
  account     Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([category, isActive])
  @@index([priority, usageCount])
}

// FAQåˆ†ç±»è¡¨
model FAQCategory {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  icon        String?
  color       String?
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
}

// ç¿»è¯‘ç¼“å­˜è¡¨
model Translation {
  id             String   @id @default(cuid())
  originalText   String   // åŸæ–‡
  translatedText String   // è¯‘æ–‡
  sourceLang     String   // æºè¯­è¨€ï¼ˆauto-detectï¼‰
  targetLang     String   // ç›®æ ‡è¯­è¨€ï¼ˆzhï¼‰
  textHash       String   // MD5 hash for caching
  provider       String   @default("baidu") // ç¿»è¯‘æœåŠ¡æä¾›å•†
  usageCount     Int      @default(1) // ä½¿ç”¨æ¬¡æ•°
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  accountId      String
  account        Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, textHash])
  @@index([accountId])
  @@index([textHash])
  @@map("translations")
}

// ==================== ç¤¾ç¾¤è¥é”€ç³»ç»Ÿ ====================

// æ‰¹é‡è¿›ç¾¤ä»»åŠ¡è¡¨
model JoinGroupTask {
  id              String    @id @default(cuid())
  title           String
  inviteLinks     Json      // é‚€è¯·é“¾æ¥æ•°ç»„
  totalLinks      Int       @default(0)
  status          String    @default("pending")  // pending, running, completed, failed, cancelled
  progress        Int       @default(0)
  joinedCount     Int       @default(0)
  failedCount     Int       @default(0)
  config          Json?     // é…ç½®ï¼ˆå»¶è¿Ÿç­‰ï¼‰
  result          Json?     // æ‰§è¡Œç»“æœè¯¦æƒ…
  errorMessage    String?
  createdAt       DateTime  @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  
  accountId       String
  account         Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([accountId])
  @@index([status, createdAt])
}

// WhatsAppç¾¤ç»„è¡¨
model WhatsAppGroup {
  id              String    @id @default(cuid())
  groupId         String              // WhatsAppç¾¤ç»„ID
  name            String
  description     String?
  avatarUrl       String?
  memberCount     Int       @default(0)
  tags            Json?                          // ç¾¤ç»„æ ‡ç­¾
  isActive        Boolean   @default(true)
  isMonitoring    Boolean   @default(false)      // æ˜¯å¦å¼€å¯ç›‘æ§
  keywords        Json?                          // ç›‘æ§å…³é”®è¯
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  accountId       String
  account         Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  members         GroupMember[]
  messages        GroupMessage[]
  activities      GroupActivity[]
  broadcasts      GroupBroadcast[]
  
  @@unique([accountId, groupId])
  @@index([accountId])
  @@index([groupId])
  @@index([isActive, isMonitoring])
}

// ç¾¤å‘è®°å½•è¡¨
model GroupBroadcast {
  id              String    @id @default(cuid())
  title           String
  message         String
  mediaUrl        String?
  targetGroupIds  Json                           // ç›®æ ‡ç¾¤ç»„IDæ•°ç»„
  totalGroups     Int       @default(0)
  status          String    @default("pending")  // pending, running, paused, completed, failed, cancelled
  progress        Int       @default(0)
  sentCount       Int       @default(0)
  failedCount     Int       @default(0)
  scheduledAt     DateTime?                      // å®šæ—¶å‘é€æ—¶é—´
  result          Json?                          // å‘é€ç»“æœè¯¦æƒ…
  errorMessage    String?
  createdAt       DateTime  @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  
  accountId       String
  account         Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  groups          WhatsAppGroup[]
  
  @@index([accountId])
  @@index([status, scheduledAt])
  @@index([createdAt])
}

// ç¾¤æˆå‘˜è¡¨
model GroupMember {
  id              String    @id @default(cuid())
  groupId         String
  phoneE164       String
  displayName     String?
  profilePicUrl   String?                          // ğŸ–¼ï¸ WhatsApp å¤´åƒ URL
  role            String    @default("member")   // member, admin, superadmin
  messageCount    Int       @default(0)
  lastMessageAt   DateTime?
  joinedAt        DateTime  @default(now())
  isActive        Boolean   @default(true)
  leftAt          DateTime?
  
  group           WhatsAppGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@unique([groupId, phoneE164])
  @@index([groupId, isActive])
  @@index([phoneE164])
}

// ç¾¤æ¶ˆæ¯è¡¨
model GroupMessage {
  id              String    @id @default(cuid())
  groupId         String
  messageId       String    @unique
  fromPhone       String
  fromName        String?
  text            String?
  mediaType       String?
  mediaUrl        String?
  mediaMimeType   String?    // ğŸ–¼ï¸ MIME ç±»å‹
  mediaFileName   String?    // ğŸ–¼ï¸ æœåŠ¡å™¨æ–‡ä»¶å
  originalFileName String?   // ğŸ–¼ï¸ åŸå§‹æ–‡ä»¶å
  thumbnailUrl    String?    // ğŸ–¼ï¸ ç¼©ç•¥å›¾è·¯å¾„
  keywords        Json?                          // å‘½ä¸­çš„å…³é”®è¯
  isViolation     Boolean   @default(false)
  createdAt       DateTime  @default(now())
  
  group           WhatsAppGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@index([groupId, createdAt])
  @@index([fromPhone])
  @@index([isViolation])
}

// ç¾¤ç»„æ´»åŠ¨è®°å½•è¡¨
model GroupActivity {
  id              String    @id @default(cuid())
  groupId         String
  type            String                         // join, leave, add, remove, promote, message
  actorPhone      String?
  targetPhone     String?
  data            Json?
  createdAt       DateTime  @default(now())
  
  group           WhatsAppGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@index([groupId, type, createdAt])
}