# å¤šè´¦å·åŠŸèƒ½ç¼–è¯‘é”™è¯¯åˆ†ææŠ¥å‘Š

## ğŸ“Š é”™è¯¯æ€»è§ˆ

**æ€»è®¡**: 77ä¸ªé”™è¯¯ï¼Œåˆ†å¸ƒåœ¨14ä¸ªæ–‡ä»¶ä¸­

## ğŸ” é”™è¯¯åˆ†ç±»

### ç¬¬ä¸€ç±»ï¼šserver.ts ä¸»è·¯ç”±æ–‡ä»¶ï¼ˆ30ä¸ªé”™è¯¯ï¼‰â­ ä¼˜å…ˆçº§æœ€é«˜

**æ–‡ä»¶**: `app/src/server.ts`

**é”™è¯¯ç±»å‹**:
1. ä½¿ç”¨äº†ä¸å­˜åœ¨çš„ `whatsappService` å•ä¾‹ï¼ˆçº¦8å¤„ï¼‰
2. è°ƒç”¨æœåŠ¡å‡½æ•°ç¼ºå°‘ `accountId` å‚æ•°ï¼ˆçº¦15å¤„ï¼‰
3. Prisma æ“ä½œç¼ºå°‘ `accountId`ï¼ˆçº¦7å¤„ï¼‰

**ä¸»è¦é”™è¯¯ä½ç½®**:
- è¡Œ358-812: æ—§ç‰ˆè·¯ç”±ç«¯ç‚¹
- æ¶‰åŠåŠŸèƒ½ï¼šå‘é€æ¶ˆæ¯ã€è”ç³»äººæŸ¥è¯¢ã€ä¼šè¯æ“ä½œã€ç™»å½•/ç™»å‡º

---

### ç¬¬äºŒç±»ï¼šæ‰¹é‡æ“ä½œå’Œæ´»åŠ¨ç›¸å…³ï¼ˆ15ä¸ªé”™è¯¯ï¼‰

#### batch-service.tsï¼ˆ9ä¸ªé”™è¯¯ï¼‰
- å¯¼å…¥ `whatsappService` å•ä¾‹
- `BatchOperation` åˆ›å»ºç¼ºå°‘ `accountId`ï¼ˆ4å¤„ï¼‰
- `Contact` æŸ¥è¯¢/åˆ›å»ºä½¿ç”¨æ—§çš„ unique çº¦æŸï¼ˆ2å¤„ï¼‰
- `getOrCreateThread` ç¼ºå°‘ `accountId` å‚æ•°
- `recordMessageIfMissing` ç¼ºå°‘ `accountId`

#### campaign-runner.tsï¼ˆ5ä¸ªé”™è¯¯ï¼‰
- å¯¼å…¥ `whatsappService` å•ä¾‹
- `getOrCreateThread` ç¼ºå°‘ `accountId`
- `recordMessage` ç¼ºå°‘ `accountId`
- `Contact` æŸ¥è¯¢ä½¿ç”¨æ—§çº¦æŸ
- `createContact` ç¼ºå°‘ `accountId`

#### campaign-service.tsï¼ˆ1ä¸ªé”™è¯¯ï¼‰
- `Campaign` åˆ›å»ºç¼ºå°‘ `accountId`

---

### ç¬¬ä¸‰ç±»ï¼šç¾¤ç»„ç›¸å…³ï¼ˆ10ä¸ªé”™è¯¯ï¼‰

#### group-service.tsï¼ˆ10ä¸ªé”™è¯¯ï¼‰
- å¯¼å…¥ `whatsappService` å•ä¾‹
- `JoinGroupTask` åˆ›å»ºç¼ºå°‘ `accountId`
- `WhatsAppGroup` æŸ¥è¯¢ä½¿ç”¨æ—§çš„ `groupId` unique çº¦æŸï¼ˆ4å¤„ï¼‰
- `WhatsAppGroup` åˆ›å»ºç¼ºå°‘ `accountId`ï¼ˆ2å¤„ï¼‰
- `GroupBroadcast` åˆ›å»ºç¼ºå°‘ `accountId`

#### routes/groups.tsï¼ˆ2ä¸ªé”™è¯¯ï¼‰
- å¯èƒ½ä¹Ÿæœ‰ç±»ä¼¼çš„ accountId é—®é¢˜

---

### ç¬¬å››ç±»ï¼šæ¨¡æ¿å’ŒçŸ¥è¯†åº“ï¼ˆ5ä¸ªé”™è¯¯ï¼‰

#### enhanced-template-service.tsï¼ˆ2ä¸ªé”™è¯¯ï¼‰
- `MessageTemplate` åˆ›å»ºç¼ºå°‘ `accountId`ï¼ˆ2å¤„ï¼‰

#### template-service.tsï¼ˆ1ä¸ªé”™è¯¯ï¼‰
- `MessageTemplate` åˆ›å»ºç¼ºå°‘ `accountId`

#### knowledge-service.tsï¼ˆ1ä¸ªé”™è¯¯ï¼‰
- `KnowledgeBase` åˆ›å»ºç¼ºå°‘ `accountId`

---

### ç¬¬äº”ç±»ï¼šå…¶ä»–æœåŠ¡ï¼ˆ7ä¸ªé”™è¯¯ï¼‰

#### outreach-service.tsï¼ˆ4ä¸ªé”™è¯¯ï¼‰
- `getContactById` ç¼ºå°‘ `accountId`
- `getOrCreateThread` ç¼ºå°‘ `accountId`
- `recordMessageIfMissing` ç¼ºå°‘ `accountId`ï¼ˆ2å¤„ï¼‰

#### translation-service.tsï¼ˆ2ä¸ªé”™è¯¯ï¼‰
- `Translation` æŸ¥è¯¢ä½¿ç”¨æ—§çš„ `textHash` unique çº¦æŸ
- `Translation` åˆ›å»ºç¼ºå°‘ `accountId`

#### stats-service.tsï¼ˆ4ä¸ªé”™è¯¯ï¼‰
- å­—æ®µåé”™è¯¯ï¼š`whatsappId` â†’ `groupId`
- å­—æ®µåé”™è¯¯ï¼š`title` â†’ `name`
- æšä¸¾å€¼é”™è¯¯ï¼š`'incoming'` â†’ `MessageDirection.IN`

---

### ç¬¬å…­ç±»ï¼šWebSocket å’Œä¸»å…¥å£ï¼ˆ6ä¸ªé”™è¯¯ï¼‰

#### websocket-service.tsï¼ˆ5ä¸ªé”™è¯¯ï¼‰
- å¯¼å…¥ `whatsappService` å•ä¾‹
- äº‹ä»¶ç›‘å¬å™¨å‚æ•°ç¼ºå°‘ç±»å‹æ ‡æ³¨ï¼ˆ4å¤„ï¼‰

#### main.tsï¼ˆ1ä¸ªé”™è¯¯ï¼‰
- å¯èƒ½ä¸ whatsappService ç›¸å…³

---

## ğŸ¯ ä¿®å¤ç­–ç•¥

### æ–¹æ¡ˆï¼šç»§ç»­åˆ†æ‰¹ä¿®å¤ï¼ˆæ¨èï¼‰

#### ç¬¬äºŒæ‰¹ï¼šserver.ts ä¸»è·¯ç”±æ–‡ä»¶ï¼ˆæœ€é‡è¦ï¼‰
**ä¼˜å…ˆçº§**: â­â­â­â­â­
**é”™è¯¯æ•°**: 30ä¸ª
**é¢„è®¡æ—¶é—´**: 1-1.5å°æ—¶

**åŸå› **:
- è¿™æ˜¯æœ€æ ¸å¿ƒçš„è·¯ç”±æ–‡ä»¶
- é”™è¯¯æ•°æœ€å¤š
- å½±å“ä¸»è¦åŠŸèƒ½

#### ç¬¬ä¸‰æ‰¹ï¼šæ‰¹é‡æ“ä½œå’Œæ´»åŠ¨
**ä¼˜å…ˆçº§**: â­â­â­â­
**é”™è¯¯æ•°**: 15ä¸ª
**é¢„è®¡æ—¶é—´**: 45åˆ†é’Ÿ

**åŒ…å«**:
- batch-service.ts
- campaign-runner.ts
- campaign-service.ts

#### ç¬¬å››æ‰¹ï¼šç¾¤ç»„åŠŸèƒ½
**ä¼˜å…ˆçº§**: â­â­â­
**é”™è¯¯æ•°**: 12ä¸ª
**é¢„è®¡æ—¶é—´**: 45åˆ†é’Ÿ

**åŒ…å«**:
- group-service.ts
- routes/groups.ts

#### ç¬¬äº”æ‰¹ï¼šæ¨¡æ¿ã€çŸ¥è¯†åº“ã€å…¶ä»–
**ä¼˜å…ˆçº§**: â­â­
**é”™è¯¯æ•°**: 12ä¸ª
**é¢„è®¡æ—¶é—´**: 30-45åˆ†é’Ÿ

**åŒ…å«**:
- enhanced-template-service.ts
- template-service.ts
- knowledge-service.ts
- outreach-service.ts
- translation-service.ts
- stats-service.ts

#### ç¬¬å…­æ‰¹ï¼šWebSocket å’Œç³»ç»Ÿ
**ä¼˜å…ˆçº§**: â­â­â­â­
**é”™è¯¯æ•°**: 6ä¸ª
**é¢„è®¡æ—¶é—´**: 30åˆ†é’Ÿ

**åŒ…å«**:
- websocket-service.ts
- main.ts

---

## ğŸ“ˆ ä¿®å¤è¿›åº¦è¿½è¸ª

### âœ… å·²å®Œæˆ
- [x] ç¬¬ä¸€æ‰¹ï¼šè”ç³»äººå’Œæ¶ˆæ¯æ ¸å¿ƒ
  - contact-service.ts
  - message-service.ts
  - thread-service.ts
  - message-workflow.ts
  - routes/messages.ts
  - routes/threads.ts

### â¸ï¸ è¿›è¡Œä¸­
- [ ] ç¬¬äºŒæ‰¹ï¼šserver.ts ä¸»è·¯ç”±æ–‡ä»¶ï¼ˆ30ä¸ªé”™è¯¯ï¼‰

### ğŸ“‹ å¾…å¤„ç†
- [ ] ç¬¬ä¸‰æ‰¹ï¼šæ‰¹é‡æ“ä½œå’Œæ´»åŠ¨ï¼ˆ15ä¸ªé”™è¯¯ï¼‰
- [ ] ç¬¬å››æ‰¹ï¼šç¾¤ç»„åŠŸèƒ½ï¼ˆ12ä¸ªé”™è¯¯ï¼‰
- [ ] ç¬¬äº”æ‰¹ï¼šæ¨¡æ¿ã€çŸ¥è¯†åº“ã€å…¶ä»–ï¼ˆ12ä¸ªé”™è¯¯ï¼‰
- [ ] ç¬¬å…­æ‰¹ï¼šWebSocket å’Œç³»ç»Ÿï¼ˆ6ä¸ªé”™è¯¯ï¼‰

---

## ğŸ”§ å¸¸è§ä¿®å¤æ¨¡å¼

### æ¨¡å¼1ï¼šç§»é™¤ whatsappService å•ä¾‹å¯¼å…¥
```typescript
// âŒ é”™è¯¯
import { whatsappService } from '../whatsapp-service';

// âœ… æ­£ç¡®
import type { WhatsAppService } from '../whatsapp-service';
// ç„¶åä» accountManager è·å–å®ä¾‹
```

### æ¨¡å¼2ï¼šæ·»åŠ  accountId åˆ°æœåŠ¡è°ƒç”¨
```typescript
// âŒ é”™è¯¯
const contact = await getContactById(id);

// âœ… æ­£ç¡®
const contact = await getContactById(accountId, id);
```

### æ¨¡å¼3ï¼šæ·»åŠ  accountId åˆ° Prisma åˆ›å»º
```typescript
// âŒ é”™è¯¯
await prisma.contact.create({
  data: { phoneE164, name }
});

// âœ… æ­£ç¡®
await prisma.contact.create({
  data: { accountId, phoneE164, name }
});
```

### æ¨¡å¼4ï¼šä¿®å¤å¤åˆå”¯ä¸€çº¦æŸæŸ¥è¯¢
```typescript
// âŒ é”™è¯¯
await prisma.contact.findUnique({
  where: { phoneE164 }
});

// âœ… æ­£ç¡®
await prisma.contact.findFirst({
  where: { accountId, phoneE164 }
});
```

---

## ğŸ’¡ å»ºè®®

### ç«‹å³è¡ŒåŠ¨
1. **å¼€å§‹ä¿®å¤ç¬¬äºŒæ‰¹ï¼ˆserver.tsï¼‰** - è¿™æ˜¯æ ¸å¿ƒæ–‡ä»¶ï¼Œå½±å“æœ€å¤§
2. é¢„è®¡1-1.5å°æ—¶å¯å®Œæˆ
3. å®Œæˆåé”™è¯¯æ•°å°†ä»77ä¸ªé™è‡³47ä¸ª

### åç»­è®¡åˆ’
- æ¯æ‰¹ä¿®å¤åç¼–è¯‘æµ‹è¯•
- é€æ­¥å‡å°‘é”™è¯¯æ•°
- é¢„è®¡æ€»æ—¶é—´ï¼š3-4å°æ—¶å®Œæˆæ‰€æœ‰ä¿®å¤

---

## ğŸ“Š é¢„è®¡å®Œæˆæ—¶é—´

| æ‰¹æ¬¡ | é”™è¯¯æ•° | é¢„è®¡æ—¶é—´ | ç´¯è®¡æ—¶é—´ |
|------|--------|----------|----------|
| ~~ç¬¬ä¸€æ‰¹~~ | ~~å·²å®Œæˆ~~ | ~~1.5h~~ | ~~1.5h~~ |
| ç¬¬äºŒæ‰¹ | 30 | 1-1.5h | 2.5-3h |
| ç¬¬ä¸‰æ‰¹ | 15 | 45min | 3.25-3.75h |
| ç¬¬å››æ‰¹ | 12 | 45min | 4-4.5h |
| ç¬¬äº”æ‰¹ | 12 | 45min | 4.75-5.25h |
| ç¬¬å…­æ‰¹ | 6 | 30min | 5.25-5.75h |

**æ€»è®¡**: çº¦5-6å°æ—¶å®Œæˆæ‰€æœ‰ä¿®å¤

---

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**æˆ‘å»ºè®®ç«‹å³å¼€å§‹ç¬¬äºŒæ‰¹ä¿®å¤ï¼ˆserver.tsï¼‰**ï¼Œå› ä¸ºï¼š
1. è¿™æ˜¯é”™è¯¯æœ€å¤šçš„æ–‡ä»¶ï¼ˆ30ä¸ªï¼‰
2. åŒ…å«æ ¸å¿ƒè·¯ç”±åŠŸèƒ½
3. ä¿®å¤åå¯ä»¥å¤§å¹…å‡å°‘é”™è¯¯æ•°
4. ä¸ºåç»­æ‰¹æ¬¡æä¾›æ¸…æ™°çš„ä¿®å¤æ¨¡å¼

**æ‚¨å¸Œæœ›æˆ‘å¼€å§‹ä¿®å¤ server.ts å—ï¼Ÿ**

