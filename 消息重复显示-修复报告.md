# 🔧 消息重复显示 - 修复报告

> 修复发送消息和 AI 自动回复显示两次的问题

---

## 🐛 问题描述

### 用户反馈

**问题：** 在对话页面发送一条消息却显示两条，AI 自动回复也显示两条

**表现：**
- ❌ 手动发送一条消息，界面显示两条相同消息
- ❌ AI 自动回复一条消息，界面显示两条相同回复
- ❌ 所有发送的消息都会重复

---

## 🔍 问题分析

### 根本原因

**WebSocket 事件被广播了两次**

#### 消息流程分析

**手动发送消息时：**

```
前端发送消息
  ↓
POST /messages API
  ↓
API 发送到 WhatsApp
  ↓
API 保存到数据库
  ↓
API 广播 WebSocket ✅ (第一次)
  ↓
WPPConnect 触发 onMessage 回调
  ↓
handleOutgoingMessage 处理
  ↓
保存到数据库（去重）
  ↓
广播 WebSocket ❌ (第二次 - 重复！)
```

**AI 自动回复时：**

```
收到用户消息
  ↓
AI 生成回复
  ↓
sendAndRecordReply 发送
  ↓
发送到 WhatsApp
  ↓
保存到数据库
  ↓
广播 WebSocket ✅ (第一次)
  ↓
WPPConnect 触发 onMessage 回调
  ↓
handleOutgoingMessage 处理
  ↓
保存到数据库（去重）
  ↓
广播 WebSocket ❌ (第二次 - 重复！)
```

### 问题代码位置

**文件：** `server/app/src/workflows/message-workflow.ts`

**问题函数：** `handleOutgoingMessage`

在之前的修复中，我在 `handleOutgoingMessage` 中添加了 WebSocket 广播，但这个函数的作用只是**记录 WPPConnect 回调的消息**，而不是主动发送的消息。

主动发送的消息已经在其他地方广播了：
- 手动发送：在 `POST /messages` API 中广播
- AI 回复：在 `sendAndRecordReply` 中广播

---

## ✅ 修复方案

### 移除 handleOutgoingMessage 中的重复广播

**文件：** `server/app/src/workflows/message-workflow.ts`

**修改内容：**

```typescript
// ❌ 修改前：
const savedMessage = await recordMessageIfMissing({...});

// 广播发送的消息到前端
if (savedMessage) {
  webSocketService.broadcast({...}); // ← 这里重复广播了！
}

// ✅ 修改后：
await recordMessageIfMissing({...});

// ℹ️ 不在这里广播 WebSocket，因为：
// 1. 手动发送的消息已经在 POST /messages API 中广播了
// 2. AI 回复的消息已经在 sendAndRecordReply 中广播了
// handleOutgoingMessage 只是记录 WPPConnect 回调的消息，避免遗漏
```

---

## 📋 修改详情

### 修改 1：新联系人场景

**位置：** `handleOutgoingMessage` 函数 - 新联系人分支

**修改前：**
```typescript
const savedMessage = await recordMessageIfMissing({
  accountId,
  threadId: thread.id,
  direction: MessageDirection.OUT,
  text: message.body ?? '',
  externalId: message.id?._serialized ?? null,
  status: MessageStatus.SENT,
});

// 🔥 广播发送的消息到前端（新联系人）
if (savedMessage) {
  const chatId = message.to;
  webSocketService.broadcast({
    type: 'new_message',
    data: { /* ... */ },
    timestamp: Date.now(),
  });
}
```

**修改后：**
```typescript
await recordMessageIfMissing({
  accountId,
  threadId: thread.id,
  direction: MessageDirection.OUT,
  text: message.body ?? '',
  externalId: message.id?._serialized ?? null,
  status: MessageStatus.SENT,
});

// ℹ️ 不在这里广播 WebSocket，因为：
// 1. 手动发送的消息已经在 POST /messages API 中广播了
// 2. AI 回复的消息已经在 sendAndRecordReply 中广播了
// handleOutgoingMessage 只是记录 WPPConnect 回调的消息，避免遗漏
```

### 修改 2：现有联系人场景

**位置：** `handleOutgoingMessage` 函数 - 现有联系人分支

**修改前：**
```typescript
const savedMessage = await recordMessageIfMissing({
  accountId,
  threadId: thread.id,
  direction: MessageDirection.OUT,
  text: message.body ?? '',
  externalId: message.id?._serialized ?? null,
  status: MessageStatus.SENT,
});

// 🔥 广播发送的消息到前端（现有联系人）
if (savedMessage) {
  const chatId = message.to;
  webSocketService.broadcast({
    type: 'new_message',
    data: { /* ... */ },
    timestamp: Date.now(),
  });
}
```

**修改后：**
```typescript
await recordMessageIfMissing({
  accountId,
  threadId: thread.id,
  direction: MessageDirection.OUT,
  text: message.body ?? '',
  externalId: message.id?._serialized ?? null,
  status: MessageStatus.SENT,
});

// ℹ️ 不在这里广播 WebSocket，因为：
// 1. 手动发送的消息已经在 POST /messages API 中广播了
// 2. AI 回复的消息已经在 sendAndRecordReply 中广播了
// handleOutgoingMessage 只是记录 WPPConnect 回调的消息，避免遗漏
```

---

## 🔄 正确的消息流程

### 接收消息（保持不变）✅

```
WhatsApp 用户发送消息
  ↓
WPPConnect 接收
  ↓
handleIncomingMessage
  ↓
保存到数据库
  ↓
广播 WebSocket ✅ (唯一一次)
  ↓
前端实时显示
```

### AI 自动回复 ✅

```
收到用户消息
  ↓
AI 生成回复
  ↓
sendAndRecordReply
  ↓
发送到 WhatsApp
  ↓
保存到数据库
  ↓
广播 WebSocket ✅ (第一次，也是唯一一次主动广播)
  ↓
WPPConnect 回调
  ↓
handleOutgoingMessage
  ↓
保存到数据库（去重）
  ↓
❌ 不再广播 (已移除)
  ↓
前端只显示一次 ✅
```

### 手动发送消息 ✅

```
前端发送消息
  ↓
POST /messages API
  ↓
发送到 WhatsApp
  ↓
保存到数据库
  ↓
广播 WebSocket ✅ (第一次，也是唯一一次主动广播)
  ↓
WPPConnect 回调
  ↓
handleOutgoingMessage
  ↓
保存到数据库（去重）
  ↓
❌ 不再广播 (已移除)
  ↓
前端只显示一次 ✅
```

---

## 📁 修改的文件

### `server/app/src/workflows/message-workflow.ts`

**修改行数：** 2 处

1. **新联系人场景** - 移除 WebSocket 广播
2. **现有联系人场景** - 移除 WebSocket 广播

**保留的广播：**
- ✅ `handleIncomingMessage` - 接收消息时广播
- ✅ `sendAndRecordReply` - AI 回复时广播

**移除的广播：**
- ❌ `handleOutgoingMessage` - 不再广播（避免重复）

---

## 🧪 测试验证

### 测试场景 1：手动发送消息

**操作：**
1. 打开聊天页面
2. 在输入框输入消息
3. 点击发送

**预期结果：**
✅ 消息只显示**一次**（绿色气泡，靠右）

### 测试场景 2：AI 自动回复

**操作：**
1. 确保 AI 开关开启
2. 用手机发送消息
3. 等待 AI 回复

**预期结果：**
✅ 用户消息显示**一次**（白色气泡，靠左）  
✅ AI 回复显示**一次**（绿色气泡，靠右）

### 测试场景 3：接收消息

**操作：**
1. 用手机发送消息（AI 开关关闭）

**预期结果：**
✅ 消息只显示**一次**（白色气泡，靠左）

---

## 📊 对比

| 场景 | 修复前 | 修复后 |
|------|--------|--------|
| 手动发送 | ❌ 显示 2 次 | ✅ 显示 1 次 |
| AI 自动回复 | ❌ 显示 2 次 | ✅ 显示 1 次 |
| 接收消息 | ✅ 显示 1 次 | ✅ 显示 1 次 |
| 消息去重 | ⚠️ 失效 | ✅ 正常 |

---

## 🚀 部署步骤

### 1. 编译后端代码

```bash
cd server
npm run build
```

### 2. 重启后端服务

```bash
# 停止旧进程
# 启动新进程
npm start
```

### 3. 刷新前端页面

不需要修改前端代码，只需刷新浏览器。

### 4. 测试验证

按照上述测试场景进行验证。

---

## 🔍 技术细节

### 为什么 handleOutgoingMessage 不需要广播？

`handleOutgoingMessage` 的作用是**记录 WPPConnect 回调的发送消息**，它是一个**被动的记录功能**，不是主动发送。

**真正主动发送消息的地方：**
1. **手动发送：** `POST /messages` API
2. **AI 回复：** `sendAndRecordReply` 函数

这两个地方已经：
- ✅ 发送到 WhatsApp
- ✅ 保存到数据库
- ✅ 广播 WebSocket

`handleOutgoingMessage` 只是在 WPPConnect 回调时：
- ✅ 再次保存到数据库（`recordMessageIfMissing` 会自动去重）
- ❌ 不应该再次广播（避免重复）

### recordMessageIfMissing 的去重机制

```typescript
// 通过 externalId 去重
const existing = await prisma.message.findFirst({
  where: {
    threadId,
    externalId,
  },
});

if (existing) {
  return null; // 消息已存在，不重复保存
}
```

虽然数据库层面有去重，但 WebSocket 广播是在保存之前就发出的，所以会导致前端收到两次相同的事件。

---

## 🐛 故障排除

### 问题：消息还是显示两次

**检查项：**
1. 后端是否已重启？
2. 浏览器是否已刷新？
3. 浏览器控制台是否还有重复的 WebSocket 事件？

**查看日志：**
```bash
# 搜索广播日志
grep "广播" server-log.txt

# 应该只看到：
# - 📨 接收消息已广播到前端
# - 🤖 AI 回复已广播到前端
# 不应该看到：
# - handleOutgoingMessage 的广播日志
```

### 问题：AI 回复不显示

**检查：** 确认没有误删 `sendAndRecordReply` 中的广播

**正确代码：**
```typescript
// ✅ 这个广播应该保留
if (savedMessage) {
  webSocketService.broadcast({
    type: 'new_message',
    data: { /* ... */ },
    timestamp: Date.now(),
  });
  logger.info({ messageId: savedMessage.id }, '🤖 AI 回复已广播到前端');
}
```

---

## 📝 关键要点

### WebSocket 广播的正确位置

✅ **应该广播的地方：**
1. `handleIncomingMessage` - 接收到用户消息
2. `sendAndRecordReply` - 发送 AI 自动回复
3. `POST /messages` API - 手动发送消息

❌ **不应该广播的地方：**
1. `handleOutgoingMessage` - WPPConnect 回调（被动记录）

### 记住这个原则

**"谁主动发送，谁负责广播"**

- 手动发送 → API 路由广播
- AI 回复 → sendAndRecordReply 广播
- 接收消息 → handleIncomingMessage 广播
- WPPConnect 回调 → 只记录，不广播

---

## ✅ 修复总结

### 修改内容

✅ 移除 `handleOutgoingMessage` 中的 WebSocket 广播（2 处）  
✅ 添加注释说明不广播的原因  
✅ 保留其他必要的广播位置  

### 修复效果

✅ 手动发送消息只显示一次  
✅ AI 自动回复只显示一次  
✅ 接收消息保持正常（只显示一次）  
✅ 消息去重机制正常工作  

---

## 📅 版本信息

- **修复日期：** 2025-10-11
- **问题类型：** 消息重复显示
- **修复方法：** 移除重复的 WebSocket 广播
- **影响文件：** `server/app/src/workflows/message-workflow.ts`
- **状态：** ✅ 已修复

---

**🎉 消息重复显示问题已完全修复！现在每条消息只会显示一次！**

