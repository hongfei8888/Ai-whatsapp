# 🤖 WhatsApp AI 自动回复 - 自动化配置指南

## 📋 配置概览

本系统提供完整的 WhatsApp 自动化解决方案，包括：
- 自动扫码登录
- 智能AI回复（DeepSeek集成）
- 人工接管机制
- 冷却防骚扰系统
- 违禁词过滤

## 🔧 1. 基础环境配置

### 环境变量配置 (`.env` 文件)

```env
# === 核心服务配置 ===
NODE_ENV=development
DATABASE_URL=file:./dev.db
SESSION_PATH=./.session
PORT=4000

# === AI 配置 ===
DEEPSEEK_API_KEY=sk-your-actual-api-key-here
DEEPSEEK_MODEL=deepseek-chat

# === 安全配置 ===
AUTH_TOKEN=your-secure-token-here

# === 自动化控制参数 ===
COOLDOWN_HOURS=24                    # 联系人冷却时间（小时）
PER_CONTACT_REPLY_COOLDOWN=10        # 单联系人回复间隔（分钟）
BANNED_KEYWORDS=保证,永久,群发,官方     # 违禁词列表

# === 前端配置 ===
NEXT_PUBLIC_API_BASE_URL=http://localhost:4000
NEXT_PUBLIC_API_TOKEN=your-secure-token-here
```

### 🚨 重要配置说明

1. **DEEPSEEK_API_KEY**: 
   - 必须配置有效的 DeepSeek API 密钥
   - 获取地址：https://platform.deepseek.com/

2. **AUTH_TOKEN**: 
   - 建议使用强密码，确保前后端一致
   - 用于 API 身份验证

3. **COOLDOWN_HOURS**: 
   - 防止骚扰的关键参数
   - 24小时内每个联系人只能发送一次首发消息

4. **PER_CONTACT_REPLY_COOLDOWN**: 
   - 防止AI回复过于频繁
   - 10分钟内不会对同一联系人重复回复

## 🚀 2. 启动自动化系统

### 步骤 1: 启动后端服务
```bash
# 确保在项目根目录
npm install
npx prisma generate
npx prisma db push
npm run dev
```

### 步骤 2: 启动前端管理台
```bash
# 新终端窗口
cd web
npm install
npm run dev
```

### 步骤 3: WhatsApp 登录
1. 访问管理台：`http://localhost:3000`
2. 进入 Dashboard 页面
3. 扫描二维码完成 WhatsApp Web 登录
4. 登录成功后状态显示为 "Online"

## 🤖 3. AI 自动回复配置

### 3.1 DeepSeek API 配置

```bash
# 在 .env 文件中配置
DEEPSEEK_API_KEY=sk-your-actual-key
DEEPSEEK_MODEL=deepseek-chat
```

### 3.2 AI 回复逻辑层级

系统采用三层回复机制：

#### 第一层：关键词规则匹配
```typescript
// 位置：app/src/ai/rules.ts
const keywordRules = [
  {
    keywords: ['退款', '退货', '退费'],
    reply: '已收到您的退款申请，我们会在24小时内为您处理，请保持电话畅通。',
  },
  {
    keywords: ['投诉', '不满', '问题'],
    reply: '非常抱歉给您带来不便，我会立即将您的反馈提交给人工客服跟进。',
  },
  {
    keywords: ['价格', '报价', '费用'],
    reply: '关于价格问题，我们会尽快为您提供详细方案，请您稍后留意消息。',
  },
  {
    keywords: ['你好', '您好', 'hello', 'hi'],
    reply: '您好，这里是您的智能助手，请告诉我您需要的帮助。',
  },
];
```

#### 第二层：DeepSeek AI 智能回复
```typescript
// AI Prompt 配置
const SYSTEM_PROMPT = `你是一名中文客服助理，需要在120个字以内友好、简洁地回答用户问题。如需更多信息，可礼貌说明稍后有人工跟进。`;
```

#### 第三层：兜底话术
```typescript
const FALLBACK_REPLY = '我记录下来了，会尽快回复你。';
```

## 📞 4. 联系人管理与自动化流程

### 4.1 添加联系人
1. 进入 **Contacts** 页面
2. 点击 "Add Contact" 按钮
3. 输入 E.164 格式手机号（如：+8613800138000）
4. 输入联系人姓名（可选）

### 4.2 首发消息（人工触发）
1. 在联系人列表中找到目标联系人
2. 点击 "Outreach" 按钮
3. 输入首发消息内容
4. 发送后联系人进入 24 小时冷却期

### 4.3 自动回复激活
- 对方回复后，系统自动创建对话线程
- AI 自动回复被激活（`aiEnabled = true`）
- 首次回复会发送欢迎消息
- 后续回复按照三层逻辑处理

### 4.4 人工接管机制
1. 进入 **Threads** 页面查看所有对话
2. 点击 "Takeover" 按钮人工接管
3. 接管后 AI 自动回复暂停
4. 点击 "Release" 按钮释放给 AI

## ⚙️ 5. 高级自动化配置

### 5.1 违禁词过滤
```env
# 在 .env 中配置，用逗号分隔
BANNED_KEYWORDS=保证,永久,群发,官方,投诉,退款
```

### 5.2 冷却时间调整
```env
# 联系人冷却（避免骚扰）
COOLDOWN_HOURS=24

# 回复冷却（避免过度回复）
PER_CONTACT_REPLY_COOLDOWN=10
```

### 5.3 自定义回复规则
编辑 `app/src/ai/rules.ts` 文件：

```typescript
const keywordRules: KeywordRule[] = [
  {
    keywords: ['自定义关键词1', '关键词2'],
    reply: '自定义回复内容',
  },
  // 添加更多规则...
];
```

## 📊 6. 监控与管理

### 6.1 Dashboard 监控
- **运营状态**: 实时显示 WhatsApp 连接状态
- **对话统计**: 总对话数、AI激活数、人工接管数
- **最新活动**: 最近消息时间

### 6.2 对话管理
- 查看所有对话线程
- 实时消息流显示
- 一键切换 AI/人工模式
- 冷却状态可视化

### 6.3 联系人管理
- 批量导入联系人
- 冷却状态实时显示
- 首发消息历史记录

## 🛡️ 7. 安全与合规

### 7.1 防骚扰机制
- **24小时冷却**: 每个联系人24小时内只能收到一次主动消息
- **回复间隔**: 10分钟内不会重复自动回复
- **违禁词过滤**: 自动过滤敏感内容

### 7.2 数据安全
- **本地存储**: 所有数据存储在本地 SQLite 数据库
- **会话加密**: WhatsApp 会话数据加密存储
- **API 认证**: 所有接口都需要 Bearer Token 认证

## 🚀 8. 实际使用场景

### 场景一：客服自动回复
1. 添加客户联系人
2. 发送开场白（如：产品介绍）
3. 客户回复后 AI 自动处理常见问题
4. 复杂问题人工接管处理

### 场景二：营销推广
1. 批量添加潜在客户
2. 发送营销信息（注意冷却时间）
3. AI 处理询价、介绍等标准回复
4. 高意向客户转人工跟进

### 场景三：售后服务
1. 现有客户咨询自动分类
2. 常见问题 AI 自动解答
3. 投诉问题自动转人工
4. 跟踪处理进度

## 🔧 9. 故障排除

### 常见问题解决

1. **AI 不回复**
   - 检查 DEEPSEEK_API_KEY 是否有效
   - 确认对话线程 aiEnabled = true
   - 查看冷却时间是否已过

2. **WhatsApp 连接断开**
   - 删除 .session 目录重新扫码
   - 检查网络连接
   - 重启后端服务

3. **前端无法访问后端**
   - 确认端口配置一致
   - 检查 AUTH_TOKEN 是否匹配
   - 查看 CORS 设置

## 📝 10. 最佳实践

1. **渐进式部署**: 先测试少量联系人，确认效果后扩大范围
2. **监控回复质量**: 定期检查 AI 回复内容，优化关键词规则
3. **合理设置冷却**: 平衡用户体验和防骚扰需求
4. **及时人工介入**: 遇到复杂问题及时切换人工处理
5. **数据备份**: 定期备份数据库和会话文件

## 🎯 快速启动清单

- [ ] 配置 DeepSeek API 密钥
- [ ] 设置安全的 AUTH_TOKEN
- [ ] 调整冷却时间参数
- [ ] 启动后端服务
- [ ] 启动前端管理台
- [ ] 扫码登录 WhatsApp
- [ ] 添加测试联系人
- [ ] 发送首发消息测试
- [ ] 验证 AI 自动回复
- [ ] 测试人工接管功能

配置完成后，您的 WhatsApp AI 自动回复系统就可以7x24小时为您工作了！
