# 账号启动和二维码登录 - 完整实施文档

## 🎯 功能概述

实现了智能账号启动系统，支持：
1. **已登录账号**：点击启动按钮刷新状态
2. **未登录账号**：自动弹出二维码扫码登录
3. **前后端完整对接**：使用标准API接口

---

## 🔄 完整流程

### 流程图

```
用户点击启动按钮
        ↓
调用 POST /accounts/{id}/start
        ↓
等待 2 秒钟
        ↓
调用 GET /accounts/{id}/status
        ↓
    ┌─────┴─────┐
    │           │
 status?      status?
 online    qr/connecting/offline
    │           │
    ↓           ↓
显示成功    弹出二维码
刷新列表    开始轮询
```

### 详细步骤

#### 1. **用户点击启动按钮**
```tsx
onClick={(e) => handleToggleAccount(account.id, account.status, e)}
```

#### 2. **判断当前状态**
```tsx
if (status === 'online') {
  // 已在线 → 停止账号
  await stopAccount(accountId);
} else {
  // 离线 → 启动账号
  await startAccount(accountId);
}
```

#### 3. **调用启动API**
```tsx
// POST /accounts/{accountId}/start
await api.accounts.start(accountId);
```

#### 4. **等待初始化**
```tsx
// 等待 2 秒让 WhatsApp 客户端初始化
await new Promise(resolve => setTimeout(resolve, 2000));
```

#### 5. **检查账号状态**
```tsx
// GET /accounts/{accountId}/status
const statusResult = await api.accounts.getStatus(accountId);
```

#### 6. **根据状态做出响应**

##### 场景A：账号已登录
```tsx
if (statusResult.status === 'online') {
  toast.success('账号已上线！');
  refreshAccounts();  // 刷新账号列表
}
```

##### 场景B：需要扫码登录
```tsx
else if (statusResult.status === 'qr' || statusResult.status === 'connecting') {
  toast.info('请扫描二维码登录');
  setQrAccountId(accountId);
  setShowQRDialog(true);  // 显示二维码对话框
}
```

##### 场景C：其他状态
```tsx
else {
  // 默认显示二维码
  setQrAccountId(accountId);
  setShowQRDialog(true);
}
```

---

## 📱 二维码登录系统

### 组件更新

#### QRCodeDialog 组件改进

**新增 accountId 参数**
```tsx
interface QRCodeDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess?: () => void;
  accountId: string | null;  // 新增：支持多账号
}
```

**API调用更新**
```tsx
// 旧版（单账号）
const result = await api.getQRCode();

// 新版（多账号）
const result = await api.accounts.getQRCode(accountId);
```

### 二维码轮询机制

#### 轮询流程
```
打开对话框
    ↓
立即获取二维码
    ↓
等待 4 秒
    ↓
再次获取二维码
    ↓
检查状态
    ↓
  ┌───┴───┐
  │       │
online   其他
  │       │
  ↓       ↓
登录成功  继续轮询
关闭窗口
```

#### 代码实现
```tsx
useEffect(() => {
  if (!isOpen) return;

  let interval: NodeJS.Timeout | null = null;
  let isActive = true;

  const pollQRCode = async () => {
    if (!isActive) return;
    
    try {
      await fetchQRCode();
      // 继续轮询
      if (isActive && isOpen) {
        interval = setTimeout(pollQRCode, 4000);  // 4秒间隔
      }
    } catch (error) {
      // 出错后延长间隔
      if (isActive && isOpen) {
        interval = setTimeout(pollQRCode, 8000);  // 8秒间隔
      }
    }
  };

  void pollQRCode();

  return () => {
    isActive = false;
    if (interval) clearTimeout(interval);
  };
}, [fetchQRCode, isOpen]);
```

### 获取二维码逻辑

```tsx
const fetchQRCode = useCallback(async () => {
  if (!accountId) {
    setStatus('账号ID不存在');
    return;
  }
  
  setIsLoading(true);
  try {
    // 1. 获取二维码
    const result = await api.accounts.getQRCode(accountId);
    
    // 2. 如果有二维码，生成图片
    if (result.qr) {
      const dataUrl = await QRCode.toDataURL(result.qr, { 
        margin: 1, 
        width: 240 
      });
      setQrImage(dataUrl);
      setStatus('请使用手机 WhatsApp 扫描二维码');
    } 
    // 3. 没有二维码，检查状态
    else {
      setQrImage(null);
      const statusResult = await api.accounts.getStatus(accountId);
      
      if (statusResult.status === 'online') {
        // 登录成功
        setStatus('✅ 账号已登录！');
        setTimeout(() => {
          onSuccess?.();
          onClose();
        }, 1500);
      } else {
        setStatus('正在初始化 WhatsApp 客户端...');
      }
    }
  } catch (error) {
    console.error('Failed to fetch QR code', error);
    setStatus(`获取二维码失败: ${error.message}`);
  } finally {
    setIsLoading(false);
  }
}, [accountId, onClose, onSuccess]);
```

---

## 🔌 API接口对接

### 后端API接口

#### 1. 启动账号
```http
POST /accounts/:accountId/start
Authorization: Bearer {token}

Response:
{
  "ok": true,
  "data": {
    "message": "Account start initiated"
  }
}
```

#### 2. 停止账号
```http
POST /accounts/:accountId/stop
Authorization: Bearer {token}

Response:
{
  "ok": true,
  "data": {
    "message": "Account stopped"
  }
}
```

#### 3. 获取账号状态
```http
GET /accounts/:accountId/status
Authorization: Bearer {token}

Response:
{
  "ok": true,
  "data": {
    "accountId": "123",
    "status": "online",     // online | offline | connecting | qr
    "phoneNumber": "+86130...",
    "platform": "linux"
  }
}
```

#### 4. 获取二维码
```http
GET /accounts/:accountId/qr
Authorization: Bearer {token}

Response:
{
  "ok": true,
  "data": {
    "qr": "2@xxx...",       // 二维码字符串
    "accountId": "123"
  }
}
```

### 前端API封装

```tsx
// web/lib/api.ts

export const api = {
  accounts: {
    // 启动账号
    start: (accountId: string) =>
      apiFetch<{ message: string }>(`/accounts/${accountId}/start`, {
        method: 'POST',
      }),
    
    // 停止账号
    stop: (accountId: string) =>
      apiFetch<{ message: string }>(`/accounts/${accountId}/stop`, {
        method: 'POST',
      }),
    
    // 获取账号状态
    getStatus: (accountId: string) =>
      apiFetch<any>(`/accounts/${accountId}/status`),
    
    // 获取账号二维码
    getQRCode: (accountId: string) =>
      apiFetch<{ qr: string | null }>(`/accounts/${accountId}/qr`),
  }
};
```

---

## 💻 组件集成

### AccountSwitcher 组件

#### 状态管理
```tsx
const [loadingAccountId, setLoadingAccountId] = useState<string | null>(null);
const [showQRDialog, setShowQRDialog] = useState(false);
const [qrAccountId, setQrAccountId] = useState<string | null>(null);
```

#### 启动/停止处理
```tsx
const handleToggleAccount = async (accountId: string, status: string, e: React.MouseEvent) => {
  e.stopPropagation();
  setLoadingAccountId(accountId);
  
  try {
    if (status === 'online') {
      // 停止账号
      await stopAccount(accountId);
      toast.success('账号已停止');
    } else {
      // 启动账号
      toast.info('正在启动账号...');
      await startAccount(accountId);
      
      // 等待初始化
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // 检查状态
      const statusResult = await api.accounts.getStatus(accountId);
      
      if (statusResult.status === 'online') {
        // 已登录
        toast.success('账号已上线！');
        refreshAccounts();
      } else if (statusResult.status === 'qr' || statusResult.status === 'connecting') {
        // 需要扫码
        toast.info('请扫描二维码登录');
        setQrAccountId(accountId);
        setShowQRDialog(true);
      } else {
        // 其他状态
        toast.info('正在获取登录二维码...');
        setQrAccountId(accountId);
        setShowQRDialog(true);
      }
    }
  } catch (error) {
    toast.error('操作失败');
  } finally {
    setLoadingAccountId(null);
  }
};
```

#### JSX集成
```tsx
return (
  <>
    {/* 账号列表 */}
    <div>
      {filteredAccounts.map((account) => (
        <div key={account.id}>
          {/* 启动/停止按钮 */}
          <Button
            onClick={(e) => handleToggleAccount(account.id, account.status, e)}
            disabled={loadingAccountId === account.id}
          >
            {account.status === 'online' ? (
              <PowerOff className="h-3.5 w-3.5" />
            ) : (
              <Power className="h-3.5 w-3.5" />
            )}
          </Button>
        </div>
      ))}
    </div>
    
    {/* 二维码对话框 */}
    <QRCodeDialog
      isOpen={showQRDialog}
      onClose={() => {
        setShowQRDialog(false);
        setQrAccountId(null);
      }}
      accountId={qrAccountId}
      onSuccess={() => {
        setShowQRDialog(false);
        setQrAccountId(null);
        refreshAccounts();
        toast.success('账号登录成功！');
      }}
    />
  </>
);
```

---

## 🎨 用户界面

### 启动按钮显示

#### 在线账号
```tsx
{account.status === 'online' ? (
  <Button variant="outline">
    <PowerOff className="h-3.5 w-3.5" />  // 橙色停止图标
  </Button>
) : (
  <Button variant="outline">
    <Power className="h-3.5 w-3.5" />     // 绿色启动图标
  </Button>
)}
```

#### 加载状态
```tsx
<Button
  variant="outline"
  disabled={loadingAccountId === account.id}
>
  {loadingAccountId === account.id ? (
    <Loader2 className="h-3.5 w-3.5 animate-spin" />
  ) : (
    <Power className="h-3.5 w-3.5" />
  )}
</Button>
```

### 二维码对话框UI

```
┌─────────────────────────────────┐
│    WhatsApp 登录                │
│                                 │
│  请使用手机 WhatsApp 扫描二维码  │
│                                 │
│  ┌───────────────────────────┐  │
│  │                           │  │
│  │                           │  │
│  │       [QR CODE]           │  │
│  │                           │  │
│  │                           │  │
│  └───────────────────────────┘  │
│                                 │
│  请使用 WhatsApp 扫描二维码      │
│       完成登录                  │
│                                 │
│  [刷新二维码]      [关闭]       │
└─────────────────────────────────┘
```

---

## 📊 状态说明

### 账号状态枚举

| 状态 | 说明 | 显示 | 操作 |
|-----|------|------|------|
| `online` | 已登录 | 绿色"在线" | 显示停止按钮 |
| `offline` | 离线 | 灰色"离线" | 显示启动按钮 |
| `connecting` | 连接中 | 橙色"连接中" | 禁用按钮 |
| `qr` | 待扫码 | 红色"待扫码" | 显示二维码 |

### 状态转换

```
offline
  ↓ 点击启动
connecting
  ↓ 2秒后
  ├─→ online (已登录)
  └─→ qr (需扫码)
         ↓ 扫码成功
       online
```

---

## 🎯 Toast通知

### 通知时机

| 操作 | 通知内容 | 类型 |
|-----|---------|------|
| 点击启动 | "正在启动账号..." | info |
| 启动成功（已登录） | "账号已上线！" | success |
| 需要扫码 | "请扫描二维码登录" | info |
| 获取二维码 | "正在获取登录二维码..." | info |
| 扫码成功 | "账号登录成功！" | success |
| 停止账号 | "账号已停止" | success |
| 操作失败 | "操作失败" | error |

### Toast实现
```tsx
import { toast } from 'sonner';

// 信息提示
toast.info('正在启动账号...');

// 成功提示
toast.success('账号已上线！');

// 错误提示
toast.error('操作失败');
```

---

## 🔧 错误处理

### 网络错误
```tsx
try {
  await startAccount(accountId);
} catch (error) {
  const message = error instanceof Error ? error.message : '操作失败';
  toast.error(message);
  console.error('Toggle account error:', error);
}
```

### 状态检查失败
```tsx
try {
  const statusResult = await api.accounts.getStatus(accountId);
  // 处理状态...
} catch (statusError) {
  // 状态检查失败，尝试显示二维码
  console.warn('Status check failed:', statusError);
  setQrAccountId(accountId);
  setShowQRDialog(true);
}
```

### 二维码获取失败
```tsx
try {
  const result = await api.accounts.getQRCode(accountId);
  // 处理二维码...
} catch (error) {
  console.error('Failed to fetch QR code', error);
  const message = error instanceof Error ? error.message : String(error);
  setStatus(`获取二维码失败: ${message}`);
  setQrImage(null);
}
```

---

## ⚡ 性能优化

### 1. 防抖处理
```tsx
// 按钮禁用防止重复点击
<Button
  disabled={loadingAccountId === account.id}
  onClick={handleToggleAccount}
>
```

### 2. 轮询优化
```tsx
// 正常轮询：4秒
interval = setTimeout(pollQRCode, 4000);

// 错误后轮询：8秒
interval = setTimeout(pollQRCode, 8000);
```

### 3. 组件卸载清理
```tsx
useEffect(() => {
  let isActive = true;
  
  // 轮询逻辑...
  
  return () => {
    isActive = false;  // 防止内存泄漏
    if (interval) clearTimeout(interval);
  };
}, []);
```

---

## 🧪 测试场景

### 场景1：首次登录账号
1. 点击离线账号的启动按钮
2. 显示 "正在启动账号..."
3. 2秒后弹出二维码对话框
4. 用手机WhatsApp扫描二维码
5. 扫码成功后显示 "账号登录成功！"
6. 对话框关闭，账号列表刷新
7. 账号状态变为 "在线"

### 场景2：已登录账号重启
1. 点击已登录账号的启动按钮
2. 显示 "正在启动账号..."
3. 2秒后显示 "账号已上线！"
4. 账号列表刷新
5. 无需扫码

### 场景3：停止账号
1. 点击在线账号的停止按钮（橙色图标）
2. 显示 "账号已停止"
3. 账号状态变为 "离线"

### 场景4：网络错误
1. 断开网络
2. 点击启动按钮
3. 显示 "操作失败"
4. 按钮恢复可用状态

---

## 📝 注意事项

### 1. **等待时间**
- 启动后等待2秒是必要的
- 给WhatsApp客户端足够的初始化时间
- 不要减少这个等待时间

### 2. **轮询频率**
- 正常情况：4秒
- 出错情况：8秒
- 不要设置太短，避免服务器压力

### 3. **状态同步**
- 扫码成功后必须调用 `refreshAccounts()`
- 确保所有地方的状态一致
- 关闭对话框前清理状态

### 4. **错误处理**
- 所有API调用都要try-catch
- 提供清晰的错误信息
- 失败后恢复按钮状态

### 5. **用户体验**
- 显示加载状态
- 提供即时反馈
- Toast通知要清晰

---

## 🚀 未来扩展

### 可能的改进

1. **智能重试**
   - 网络失败自动重试
   - 指数退避策略

2. **状态缓存**
   - 缓存账号状态
   - 减少API调用

3. **批量操作**
   - 批量启动账号
   - 批量停止账号

4. **通知增强**
   - 声音提醒
   - 桌面通知
   - 邮件通知

5. **日志记录**
   - 操作日志
   - 错误日志
   - 登录历史

---

## ✅ 完成检查清单

- [x] QRCodeDialog支持accountId参数
- [x] AccountSwitcher集成二维码登录
- [x] 启动按钮智能判断状态
- [x] 已登录账号刷新状态
- [x] 未登录账号弹出二维码
- [x] 二维码轮询机制
- [x] 扫码成功自动关闭
- [x] Toast通知完整
- [x] 错误处理完善
- [x] 加载状态显示
- [x] API完整对接
- [x] 多账号支持
- [x] 无Lint错误

---

## 📚 相关文件

### 修改的文件
1. `web/components/QRCodeDialog.tsx` - 支持多账号
2. `web/components/account/AccountSwitcher.tsx` - 智能启动逻辑
3. `web/lib/api.ts` - API接口封装（无需修改，已完善）

### 使用的组件
- `QRCodeDialog` - 二维码显示和轮询
- `AccountSwitcher` - 账号切换和管理
- `Button` - 操作按钮
- `toast` - 通知提示

### API接口
- `POST /accounts/:id/start` - 启动账号
- `POST /accounts/:id/stop` - 停止账号
- `GET /accounts/:id/status` - 获取状态
- `GET /accounts/:id/qr` - 获取二维码

---

## 🎉 总结

现在的账号启动系统：

✅ **智能判断** - 自动识别是否需要登录  
✅ **无缝体验** - 已登录账号直接刷新  
✅ **扫码登录** - 未登录自动弹出二维码  
✅ **实时轮询** - 自动检测登录状态  
✅ **完整反馈** - Toast通知清晰明确  
✅ **错误处理** - 所有异常都有处理  
✅ **多账号支持** - 完美支持多个账号  

用户体验极佳，开发维护方便！🚀

