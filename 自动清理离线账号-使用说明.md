# 自动清理离线账号 - 使用说明

## 📋 功能说明

自动调用清理API删除所有离线账号，支持单次执行和定时自动执行两种模式。

## 🎯 清理规则

系统会自动删除以下状态的账号：
- `DISCONNECTED` - 已断开连接的账号
- `FAILED` - 认证失败的账号
- 其他非在线状态（不包括 `READY` 和 `ONLINE`）

## 📦 使用方法

### 方式一：单次执行清理（推荐新手）

直接双击运行批处理文件：
```
run-cleanup-once.bat
```

这会：
1. 连接到后端API
2. 显示当前所有账号状态
3. 自动删除所有离线账号
4. 显示清理结果
5. 执行完成后退出

### 方式二：启动定时自动清理服务

双击运行批处理文件：
```
run-auto-cleanup.bat
```

这会：
1. 启动一个持续运行的服务
2. 立即执行一次清理
3. 每隔60分钟自动执行一次清理
4. 持续运行直到手动停止（Ctrl+C）

### 方式三：使用Node.js直接运行

```bash
# 单次执行
set RUN_ONCE=true
node auto-cleanup-offline-accounts.js

# 定时执行（每30分钟）
set CLEANUP_INTERVAL_MINUTES=30
node auto-cleanup-offline-accounts.js
```

## ⚙️ 配置选项

可以通过环境变量配置脚本行为：

### API_BASE_URL
- **说明**: 后端API的基础URL
- **默认值**: `http://localhost:3001`
- **示例**: `set API_BASE_URL=http://192.168.1.100:3001`

### CLEANUP_INTERVAL_MINUTES
- **说明**: 自动清理的时间间隔（分钟）
- **默认值**: `60`（每小时执行一次）
- **示例**: `set CLEANUP_INTERVAL_MINUTES=30`（每30分钟执行一次）

### RUN_ONCE
- **说明**: 是否只运行一次后退出
- **默认值**: `false`
- **可选值**: `true` 或 `false`
- **示例**: `set RUN_ONCE=true`

## 📊 输出示例

### 有离线账号时：

```
═════════════════════════════════════════
🚀 开始执行清理任务
═════════════════════════════════════════

📊 当前账号状态:
  ✅ 在线账号: 2
  ❌ 离线账号: 3

离线账号列表:
  - 测试账号1 (无手机号) - DISCONNECTED
  - 测试账号2 (+86123456789) - FAILED
  - 测试账号3 (无手机号) - offline

🔍 开始清理离线账号...
✅ Successfully deleted 3 offline accounts
📊 删除的账号详情:
  - 测试账号1 (无手机号) - DISCONNECTED
  - 测试账号2 (+86123456789) - FAILED
  - 测试账号3 (无手机号) - offline

🔄 清理后的账号状态:
📊 当前账号状态:
  ✅ 在线账号: 2
  ❌ 离线账号: 0

═════════════════════════════════════════
✨ 清理任务完成
═════════════════════════════════════════
```

### 无离线账号时：

```
═════════════════════════════════════════
🚀 开始执行清理任务
═════════════════════════════════════════

📊 当前账号状态:
  ✅ 在线账号: 2
  ❌ 离线账号: 0

🔍 开始清理离线账号...
✨ No offline accounts to clean

═════════════════════════════════════════
✨ 清理任务完成
═════════════════════════════════════════
```

## 🚨 注意事项

1. **确保后端服务运行**: 在运行清理脚本前，确保后端API服务（端口3001）正在运行

2. **数据不可恢复**: 删除的账号及其所有关联数据（联系人、消息、群组等）将永久删除，无法恢复

3. **在线账号不受影响**: 只有离线状态的账号会被删除，在线账号（READY/ONLINE）会被保留

4. **网络连接**: 确保能够访问后端API，如果使用远程服务器，请修改 `API_BASE_URL`

5. **权限要求**: 删除操作需要数据库写入权限

## 🔧 故障排除

### 问题1: 无法连接到服务器

```
❌ 无法连接到服务器 http://localhost:3001，请确保服务器正在运行
```

**解决方案**:
1. 检查后端服务是否启动（运行 `start-dev.bat` 或相应的启动脚本）
2. 确认端口号是否正确（默认3001）
3. 如果后端在不同端口，修改 `API_BASE_URL` 环境变量

### 问题2: API错误

```
❌ API错误 (500): Failed to cleanup accounts
```

**解决方案**:
1. 查看后端日志了解详细错误
2. 检查数据库连接是否正常
3. 确认Prisma数据库配置正确

### 问题3: 脚本找不到axios模块

```
Error: Cannot find module 'axios'
```

**解决方案**:
```bash
npm install axios
```

## 🎯 推荐使用场景

1. **定期维护**: 使用定时任务模式，每天自动清理失败的账号
2. **测试环境**: 测试完成后快速清理所有测试账号
3. **批量管理**: 在添加新账号前清理旧的离线账号
4. **系统优化**: 定期清理减少数据库负载

## 📝 API端点

脚本调用的API端点：
- **URL**: `DELETE /api/accounts/cleanup`
- **描述**: 删除所有离线账号及其关联数据
- **返回**: 删除的账号数量和详细信息

## 🔗 相关文件

- `auto-cleanup-offline-accounts.js` - 自动清理脚本
- `run-auto-cleanup.bat` - 启动定时清理服务
- `run-cleanup-once.bat` - 单次执行清理
- `cleanup-accounts.js` - 直接数据库清理脚本（不推荐，仅供紧急情况）
- `server/app/src/routes/accounts.ts` - 清理API实现

## 💡 最佳实践

1. **首次使用**: 建议先使用单次执行模式，确认清理逻辑符合预期
2. **生产环境**: 设置合理的清理间隔（建议6-24小时）
3. **备份**: 重要数据建议定期备份
4. **监控**: 查看清理日志，了解账号状态变化
5. **测试**: 在开发环境充分测试后再部署到生产环境

## 📞 技术支持

如有问题，请查看：
1. 后端日志文件
2. 数据库状态
3. API响应信息
4. 本文档的故障排除部分

