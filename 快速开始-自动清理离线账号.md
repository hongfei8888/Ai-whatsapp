# 🚀 快速开始 - 自动清理离线账号

## 📝 快速概览

这个功能可以自动删除所有离线的WhatsApp账号，支持：
- ✅ 单次手动清理
- ✅ 定时自动清理（后台运行）
- ✅ API调用清理
- ✅ 完整的日志输出

## ⚡ 最快开始方式

### 第1步：确保后端运行

双击运行任一启动脚本：
- `start-dev.bat` 
- `start-servers.ps1`

等待看到服务器启动成功的提示。

### 第2步：测试API连接（可选但推荐）

双击运行：
```
test-cleanup-api.ps1
```

这会：
- ✅ 检查服务器是否在线
- ✅ 显示所有账号状态
- ✅ 询问是否执行测试清理

### 第3步：执行清理

#### 方式A：单次清理（推荐新手）

双击运行：
```
run-cleanup-once.bat
```

#### 方式B：自动定时清理（推荐生产环境）

双击运行：
```
run-auto-cleanup.bat
```

这会每60分钟自动清理一次，持续运行。

## 🎯 三个清理脚本对比

| 脚本 | 功能 | 推荐场景 |
|------|------|----------|
| `test-cleanup-api.ps1` | 测试连接 + 可选清理 | 首次使用、测试环境 |
| `run-cleanup-once.bat` | 单次执行清理 | 手动维护、临时清理 |
| `run-auto-cleanup.bat` | 定时自动清理 | 生产环境、自动化运维 |

## 📊 清理规则

系统会删除以下状态的账号：
- ❌ `DISCONNECTED` - 已断开
- ❌ `FAILED` - 认证失败
- ❌ `offline` - 离线
- ❌ 其他非活动状态

保留以下状态的账号：
- ✅ `READY` - 已就绪
- ✅ `ONLINE` - 在线
- ✅ `QR` - 等待扫码
- ✅ `AUTHENTICATING` - 认证中
- ✅ `CONNECTING` - 连接中

## 🔧 自定义配置

### 修改清理间隔

编辑 `run-auto-cleanup.bat`：
```batch
set CLEANUP_INTERVAL_MINUTES=30  REM 改为30分钟
```

或使用PowerShell：
```powershell
.\auto-cleanup-offline-accounts.ps1 -IntervalMinutes 30
```

### 修改API地址

如果后端不在本机或使用不同端口：

编辑 `.bat` 文件：
```batch
set API_BASE_URL=http://192.168.1.100:3001
```

或使用PowerShell：
```powershell
.\auto-cleanup-offline-accounts.ps1 -ApiBaseUrl "http://192.168.1.100:3001"
```

## 💡 使用场景示例

### 场景1：开发测试后清理

测试完成后，快速清理所有测试账号：
```
双击: run-cleanup-once.bat
```

### 场景2：生产环境自动维护

设置每天凌晨3点自动清理（使用Windows任务计划程序）：
1. 打开任务计划程序
2. 创建基本任务
3. 触发器：每天凌晨3:00
4. 操作：启动程序 `run-cleanup-once.bat`

### 场景3：持续监控和清理

在服务器上运行自动清理服务：
```
双击: run-auto-cleanup.bat
```

让它在后台持续运行，每小时自动清理。

## 📱 命令行高级用法

### PowerShell版本（更灵活）

```powershell
# 单次执行
.\auto-cleanup-offline-accounts.ps1 -RunOnce

# 每30分钟执行一次
.\auto-cleanup-offline-accounts.ps1 -IntervalMinutes 30

# 使用自定义API地址
.\auto-cleanup-offline-accounts.ps1 -ApiBaseUrl "http://192.168.1.100:3001"

# 组合使用
.\auto-cleanup-offline-accounts.ps1 -ApiBaseUrl "http://localhost:3001" -IntervalMinutes 15
```

### Node.js版本（跨平台）

```bash
# Windows
set API_BASE_URL=http://localhost:3001
set CLEANUP_INTERVAL_MINUTES=60
node auto-cleanup-offline-accounts.js

# Linux/Mac
API_BASE_URL=http://localhost:3001 CLEANUP_INTERVAL_MINUTES=60 node auto-cleanup-offline-accounts.js
```

## 🚨 常见问题

### Q: 脚本提示"无法连接到服务器"

**A:** 确保后端服务正在运行：
1. 运行 `start-dev.bat` 启动后端
2. 检查端口3001是否被占用
3. 确认防火墙没有阻止连接

### Q: 清理后能恢复吗？

**A:** 不能！删除是永久的，包括：
- 账号本身
- 所有联系人
- 所有消息记录
- 所有群组信息
- 所有活动记录

建议先用 `test-cleanup-api.ps1` 查看要删除哪些账号。

### Q: 会删除在线账号吗？

**A:** 不会！只删除离线状态的账号。在线账号（READY/ONLINE）和正在连接的账号（QR/AUTHENTICATING/CONNECTING）都会保留。

### Q: 如何停止自动清理服务？

**A:** 在运行窗口按 `Ctrl+C`，或直接关闭命令行窗口。

### Q: 可以只删除某些特定状态的账号吗？

**A:** 当前版本删除所有非活动状态的账号。如需自定义，可修改 `server/app/src/routes/accounts.ts` 中的清理逻辑。

## 📈 最佳实践

1. **首次使用前**
   - 先运行 `test-cleanup-api.ps1` 查看状态
   - 确认要删除的账号
   - 备份重要数据

2. **开发环境**
   - 使用单次清理模式
   - 按需手动执行

3. **生产环境**
   - 使用定时清理模式
   - 设置合理的间隔（建议6-24小时）
   - 记录清理日志

4. **监控维护**
   - 定期查看清理日志
   - 监控账号状态变化
   - 及时处理异常

## 📂 相关文件

- `auto-cleanup-offline-accounts.js` - Node.js清理脚本
- `auto-cleanup-offline-accounts.ps1` - PowerShell清理脚本
- `test-cleanup-api.ps1` - API连接测试工具
- `run-cleanup-once.bat` - 单次清理批处理
- `run-auto-cleanup.bat` - 定时清理批处理
- `自动清理离线账号-使用说明.md` - 完整使用文档

## 🔗 技术细节

如需了解API实现、数据库操作等技术细节，请参考：
- `自动清理离线账号-使用说明.md` - 详细文档
- `server/app/src/routes/accounts.ts` - API实现代码
- `cleanup-accounts.js` - 直接数据库操作（仅供参考）

## 💪 下一步

1. ✅ 测试API连接：`test-cleanup-api.ps1`
2. ✅ 执行单次清理：`run-cleanup-once.bat`
3. ✅ 启动自动清理：`run-auto-cleanup.bat`
4. 📖 阅读完整文档：`自动清理离线账号-使用说明.md`

---

需要帮助？查看完整文档或后端日志文件获取更多信息。

