# èŠå¤©é¡µé¢å…¨é¢ä¼˜åŒ–é›†æˆæŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•å°†æ‰€æœ‰æ–°åˆ›å»ºçš„ç»„ä»¶å’ŒåŠŸèƒ½é›†æˆåˆ°ç°æœ‰çš„èŠå¤©é¡µé¢ `web/app/chat/[id]/page.tsx` ä¸­ã€‚

---

## ä¸€ã€å¯¼å…¥æ–°ç»„ä»¶

åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ æ‰€æœ‰æ–°ç»„ä»¶çš„å¯¼å…¥ï¼š

```typescript
// åŸæœ‰å¯¼å…¥ä¿æŒä¸å˜
import { useState, useEffect, useRef, useCallback } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { api } from '@/lib/api';
import WhatsAppLayout, { WhatsAppColors } from '@/components/layout/WhatsAppLayout';
import Sidebar from '@/components/layout/Sidebar';
import { useWebSocket } from '@/lib/useWebSocket';
import KnowledgeSelector from '@/components/KnowledgeSelector';

// æ–°å¢ï¼šåª’ä½“ç»„ä»¶
import MediaPreview from '@/components/media/MediaPreview';
import MediaUploader from '@/components/media/MediaUploader';

// æ–°å¢ï¼šæ¶ˆæ¯æ“ä½œç»„ä»¶
import QuotedMessage from '@/components/chat/QuotedMessage';
import MessageContextMenu, { getMessageMenuItems } from '@/components/chat/MessageContextMenu';
import MessageEditor from '@/components/chat/MessageEditor';
import ForwardDialog from '@/components/chat/ForwardDialog';

// æ–°å¢ï¼šèŠå¤©è¾…åŠ©ç»„ä»¶
import MessageSearch from '@/components/chat/MessageSearch';
import ThreadLabels from '@/components/chat/ThreadLabels';
```

---

## äºŒã€æ‰©å±•çŠ¶æ€ç®¡ç†

åœ¨ç°æœ‰çš„çŠ¶æ€åŸºç¡€ä¸Šï¼Œæ·»åŠ æ–°çš„çŠ¶æ€å˜é‡ï¼š

```typescript
export default function ChatPage() {
  // ... ç°æœ‰çŠ¶æ€ä¿æŒä¸å˜
  
  // æ–°å¢ï¼šæ¶ˆæ¯æ“ä½œç›¸å…³çŠ¶æ€
  const [replyToMessage, setReplyToMessage] = useState<any | null>(null);
  const [editingMessageId, setEditingMessageId] = useState<string | null>(null);
  const [selectedMessages, setSelectedMessages] = useState<Set<string>>(new Set());
  
  // æ–°å¢ï¼šå¯¹è¯æ¡†çŠ¶æ€
  const [showForwardDialog, setShowForwardDialog] = useState(false);
  const [forwardMessage, setForwardMessage] = useState<any | null>(null);
  const [showMediaUploader, setShowMediaUploader] = useState(false);
  
  // æ–°å¢ï¼šUI çŠ¶æ€
  const [showSearch, setShowSearch] = useState(false);
  const [showKnowledgeSelector, setShowKnowledgeSelector] = useState(false); // å·²å­˜åœ¨
  
  // æ–°å¢ï¼šå³é”®èœå•çŠ¶æ€
  const [contextMenu, setContextMenu] = useState<{
    show: boolean;
    x: number;
    y: number;
    message: any;
  } | null>(null);
  
  // æ–°å¢ï¼šåˆ†é¡µåŠ è½½çŠ¶æ€
  const [hasMoreMessages, setHasMoreMessages] = useState(true);
  const [loadingMoreMessages, setLoadingMoreMessages] = useState(false);
  
  // æ–°å¢ï¼šè‰ç¨¿è‡ªåŠ¨ä¿å­˜
  const draftSaveTimerRef = useRef<NodeJS.Timeout>();
  
  // ... å…¶ä»–çŠ¶æ€ä¿æŒä¸å˜
}
```

---

## ä¸‰ã€æ–°å¢æ ¸å¿ƒåŠŸèƒ½

### 3.1 è‰ç¨¿è‡ªåŠ¨ä¿å­˜

æ·»åŠ è‰ç¨¿è‡ªåŠ¨ä¿å­˜çš„ useEffectï¼š

```typescript
// è‰ç¨¿è‡ªåŠ¨ä¿å­˜
useEffect(() => {
  if (!threadId || !inputMessage) return;
  
  // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
  if (draftSaveTimerRef.current) {
    clearTimeout(draftSaveTimerRef.current);
  }
  
  // å»¶è¿Ÿä¿å­˜è‰ç¨¿ï¼ˆé˜²æŠ–ï¼‰
  draftSaveTimerRef.current = setTimeout(async () => {
    try {
      await api.threads.saveDraft(threadId, inputMessage);
      console.log('ğŸ’¾ è‰ç¨¿å·²ä¿å­˜');
    } catch (error) {
      console.error('ä¿å­˜è‰ç¨¿å¤±è´¥:', error);
    }
  }, 1000); // 1ç§’å»¶è¿Ÿ
  
  return () => {
    if (draftSaveTimerRef.current) {
      clearTimeout(draftSaveTimerRef.current);
    }
  };
}, [inputMessage, threadId]);
```

### 3.2 åŠ è½½è‰ç¨¿

åœ¨ `loadThread` å‡½æ•°ä¸­æ·»åŠ åŠ è½½è‰ç¨¿çš„é€»è¾‘ï¼š

```typescript
const loadThread = async () => {
  // ... ç°æœ‰ä»£ç ä¿æŒä¸å˜
  
  // æ–°å¢ï¼šåŠ è½½è‰ç¨¿
  try {
    const draft = await api.threads.getDraft(threadId);
    if (draft?.draft) {
      setInputMessage(draft.draft);
    }
  } catch (error) {
    console.error('åŠ è½½è‰ç¨¿å¤±è´¥:', error);
  }
  
  // ... å…¶ä»–ä»£ç ä¿æŒä¸å˜
};
```

### 3.3 åˆ†é¡µåŠ è½½å†å²æ¶ˆæ¯

æ·»åŠ åŠ è½½æ›´å¤šæ¶ˆæ¯çš„å‡½æ•°ï¼š

```typescript
const loadMoreMessages = async () => {
  if (!threadId || loadingMoreMessages || !hasMoreMessages) return;
  
  try {
    setLoadingMoreMessages(true);
    
    // è·å–æœ€æ—©çš„æ¶ˆæ¯æ—¶é—´
    const oldestMessage = messages[0];
    const before = oldestMessage?.createdAt;
    
    const data = await api.threads.getMessages(threadId, 50, before);
    
    if (data.messages && data.messages.length > 0) {
      // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
      const container = messageContainerRef.current;
      const oldScrollHeight = container?.scrollHeight || 0;
      
      // æ·»åŠ å†å²æ¶ˆæ¯åˆ°åˆ—è¡¨é¡¶éƒ¨
      setMessages((prev) => [...data.messages, ...prev]);
      setHasMoreMessages(data.hasMore || false);
      
      // æ¢å¤æ»šåŠ¨ä½ç½®
      setTimeout(() => {
        if (container) {
          const newScrollHeight = container.scrollHeight;
          container.scrollTop = newScrollHeight - oldScrollHeight;
        }
      }, 0);
    } else {
      setHasMoreMessages(false);
    }
  } catch (error) {
    console.error('åŠ è½½å†å²æ¶ˆæ¯å¤±è´¥:', error);
  } finally {
    setLoadingMoreMessages(false);
  }
};

// ç›‘å¬æ»šåŠ¨äº‹ä»¶
const handleScroll = useCallback(() => {
  const container = messageContainerRef.current;
  if (!container) return;
  
  // æ»šåŠ¨åˆ°é¡¶éƒ¨æ—¶åŠ è½½æ›´å¤š
  if (container.scrollTop < 100) {
    loadMoreMessages();
  }
}, [loadingMoreMessages, hasMoreMessages]);

// æ·»åŠ æ»šåŠ¨ç›‘å¬
useEffect(() => {
  const container = messageContainerRef.current;
  if (!container) return;
  
  container.addEventListener('scroll', handleScroll);
  return () => container.removeEventListener('scroll', handleScroll);
}, [handleScroll]);
```

### 3.4 æ¶ˆæ¯æ“ä½œ

æ·»åŠ æ¶ˆæ¯æ“ä½œçš„å¤„ç†å‡½æ•°ï¼š

```typescript
// å¼•ç”¨æ¶ˆæ¯
const handleReplyMessage = (message: any) => {
  setReplyToMessage(message);
  setContextMenu(null);
  inputRef.current?.focus();
};

// ç¼–è¾‘æ¶ˆæ¯
const handleEditMessage = async (messageId: string, newText: string) => {
  try {
    await api.messages.edit(messageId, newText);
    setEditingMessageId(null);
    console.log('âœ… æ¶ˆæ¯å·²ç¼–è¾‘');
  } catch (error) {
    console.error('ç¼–è¾‘æ¶ˆæ¯å¤±è´¥:', error);
    throw error;
  }
};

// åˆ é™¤æ¶ˆæ¯
const handleDeleteMessage = async (message: any) => {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) return;
  
  try {
    await api.messages.delete(message.id);
    setContextMenu(null);
    console.log('âœ… æ¶ˆæ¯å·²åˆ é™¤');
  } catch (error) {
    console.error('åˆ é™¤æ¶ˆæ¯å¤±è´¥:', error);
    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
};

// è½¬å‘æ¶ˆæ¯
const handleForwardMessage = async (threadIds: string[]) => {
  if (!forwardMessage) return;
  
  try {
    await api.messages.forward(forwardMessage.id, threadIds);
    setShowForwardDialog(false);
    setForwardMessage(null);
    setContextMenu(null);
    console.log(`âœ… æ¶ˆæ¯å·²è½¬å‘åˆ° ${threadIds.length} ä¸ªä¼šè¯`);
    alert(`æ¶ˆæ¯å·²è½¬å‘åˆ° ${threadIds.length} ä¸ªä¼šè¯`);
  } catch (error) {
    console.error('è½¬å‘æ¶ˆæ¯å¤±è´¥:', error);
    throw error;
  }
};

// æ ‡è®°æ˜Ÿæ ‡
const handleStarMessage = async (message: any) => {
  try {
    await api.messages.star(message.id, !message.isStarred);
    setContextMenu(null);
    
    // æ›´æ–°æœ¬åœ°çŠ¶æ€
    setMessages((prev) =>
      prev.map((msg) =>
        msg.id === message.id
          ? { ...msg, isStarred: !msg.isStarred }
          : msg
      )
    );
  } catch (error) {
    console.error('æ ‡è®°æ¶ˆæ¯å¤±è´¥:', error);
    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
  }
};

// å¤åˆ¶æ¶ˆæ¯
const handleCopyMessage = (message: any) => {
  if (message.text) {
    navigator.clipboard.writeText(message.text);
    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    setContextMenu(null);
  }
};

// å³é”®èœå•
const handleMessageContextMenu = (e: React.MouseEvent, message: any) => {
  e.preventDefault();
  
  setContextMenu({
    show: true,
    x: e.clientX,
    y: e.clientY,
    message,
  });
};
```

### 3.5 åª’ä½“æ–‡ä»¶ä¸Šä¼ 

æ·»åŠ åª’ä½“ä¸Šä¼ å¤„ç†ï¼š

```typescript
const handleMediaUpload = async (result: any) => {
  if (!threadId) return;
  
  try {
    // åˆ›å»ºåŒ…å«åª’ä½“çš„æ¶ˆæ¯
    const messageData = {
      threadId,
      text: result.fileName || '',
      mediaUrl: result.url,
      mediaType: result.type,
      mediaMimeType: result.mimeType,
      mediaSize: result.size,
      mediaFileName: result.fileName,
      thumbnailUrl: result.thumbnailUrl,
    };
    
    await api.sendMessage(threadId, '', messageData);
    setShowMediaUploader(false);
    console.log('âœ… åª’ä½“æ–‡ä»¶å·²å‘é€');
  } catch (error) {
    console.error('å‘é€åª’ä½“æ¶ˆæ¯å¤±è´¥:', error);
    alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
};
```

### 3.6 æ›´æ–°å‘é€æ¶ˆæ¯å‡½æ•°

ä¿®æ”¹ç°æœ‰çš„ `handleSendMessage` å‡½æ•°ä»¥æ”¯æŒå¼•ç”¨å›å¤ï¼š

```typescript
const handleSendMessage = async () => {
  if (!inputMessage.trim() || sending || !threadId) return;
  
  try {
    setSending(true);
    
    // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œä½¿ç”¨å¼•ç”¨API
    if (replyToMessage) {
      await api.messages.reply(threadId, inputMessage.trim(), replyToMessage.id);
    } else {
      await api.sendMessage(threadId, inputMessage.trim());
    }
    
    // æ¸…ç©ºè¾“å…¥å’Œå¼•ç”¨
    setInputMessage('');
    setReplyToMessage(null);
    setSending(false);
    
    // æ¸…é™¤è‰ç¨¿
    api.threads.saveDraft(threadId, '').catch(console.error);
    
    // èšç„¦è¾“å…¥æ¡†
    inputRef.current?.focus();
  } catch (error: any) {
    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
    alert('å‘é€å¤±è´¥: ' + error.message);
    setSending(false);
  }
};
```

---

## å››ã€æ›´æ–°UIæ¸²æŸ“

### 4.1 èŠå¤©å¤´éƒ¨æ·»åŠ æ“ä½œæŒ‰é’®

åœ¨èŠå¤©å¤´éƒ¨æ·»åŠ æœç´¢ã€æ›´å¤šæ“ä½œæŒ‰é’®ï¼š

```typescript
// åœ¨èŠå¤©å¤´éƒ¨ï¼ˆchatHeaderï¼‰ä¸­æ·»åŠ 
<div style={styles.chatHeader}>
  {/* ç°æœ‰çš„è”ç³»äººä¿¡æ¯ */}
  <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flex: 1 }}>
    {/* ... å¤´åƒå’Œåç§° */}
  </div>
  
  {/* æ–°å¢ï¼šæ“ä½œæŒ‰é’® */}
  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
    {/* æœç´¢æŒ‰é’® */}
    <button
      onClick={() => setShowSearch(!showSearch)}
      style={{
        width: '40px',
        height: '40px',
        borderRadius: '50%',
        border: 'none',
        backgroundColor: showSearch ? WhatsAppColors.selected : 'transparent',
        cursor: 'pointer',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontSize: '20px',
      }}
      title="æœç´¢æ¶ˆæ¯"
    >
      ğŸ”
    </button>
    
    {/* æ›´å¤šæ“ä½œæŒ‰é’® */}
    <button
      onClick={() => {/* æ˜¾ç¤ºæ›´å¤šèœå• */}}
      style={{
        width: '40px',
        height: '40px',
        borderRadius: '50%',
        border: 'none',
        backgroundColor: 'transparent',
        cursor: 'pointer',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontSize: '20px',
      }}
      title="æ›´å¤š"
    >
      â‹®
    </button>
  </div>
</div>

{/* æœç´¢ç»„ä»¶ */}
{showSearch && (
  <MessageSearch
    threadId={threadId}
    onMessageClick={(messageId) => {
      // TODO: è·³è½¬åˆ°æŒ‡å®šæ¶ˆæ¯
      console.log('è·³è½¬åˆ°æ¶ˆæ¯:', messageId);
    }}
    onClose={() => setShowSearch(false)}
  />
)}
```

### 4.2 æ›´æ–°æ¶ˆæ¯æ¸²æŸ“

ä¿®æ”¹æ¶ˆæ¯æ¸²æŸ“å‡½æ•°ä»¥æ”¯æŒæ‰€æœ‰æ–°åŠŸèƒ½ï¼š

```typescript
const renderMessage = (message: any, index: number) => {
  const isOwn = message.direction === 'OUT' || message.fromMe;
  const isEditing = editingMessageId === message.id;
  
  return (
    <div
      key={message.id}
      ref={index === messages.length - 1 ? lastMessageRef : null}
      onContextMenu={(e) => handleMessageContextMenu(e, message)}
      style={{
        display: 'flex',
        justifyContent: isOwn ? 'flex-end' : 'flex-start',
        marginBottom: '8px',
        padding: '0 12px',
      }}
    >
      <div
        style={{
          maxWidth: '65%',
          backgroundColor: isOwn ? WhatsAppColors.ownMessage : WhatsAppColors.otherMessage,
          borderRadius: '8px',
          padding: '8px 12px',
          position: 'relative',
        }}
      >
        {/* å¼•ç”¨çš„æ¶ˆæ¯ */}
        {message.replyTo && (
          <div style={{ marginBottom: '8px' }}>
            <QuotedMessage
              message={message.replyTo}
              onJumpTo={(id) => {
                // TODO: è·³è½¬åˆ°æ¶ˆæ¯
                console.log('è·³è½¬åˆ°:', id);
              }}
              compact
            />
          </div>
        )}
        
        {/* åª’ä½“å†…å®¹ */}
        {message.mediaUrl && (
          <div style={{ marginBottom: message.text ? '8px' : 0 }}>
            <MediaPreview
              mediaUrl={message.mediaUrl}
              mediaType={message.mediaType}
              mediaMimeType={message.mediaMimeType}
              mediaFileName={message.mediaFileName}
              mediaSize={message.mediaSize}
              thumbnailUrl={message.thumbnailUrl}
              duration={message.duration}
            />
          </div>
        )}
        
        {/* ç¼–è¾‘æ¨¡å¼ */}
        {isEditing ? (
          <MessageEditor
            initialText={message.text || ''}
            onSave={(newText) => handleEditMessage(message.id, newText)}
            onCancel={() => setEditingMessageId(null)}
          />
        ) : (
          <>
            {/* æ¶ˆæ¯æ–‡æœ¬ */}
            {message.isDeleted ? (
              <div style={{ fontStyle: 'italic', color: '#8696a0' }}>
                æ­¤æ¶ˆæ¯å·²åˆ é™¤
              </div>
            ) : message.text && (
              <div style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-word' }}>
                {message.text}
              </div>
            )}
            
            {/* ç¿»è¯‘æ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰ */}
            {message.translatedText && !message.isDeleted && (
              <div
                style={{
                  marginTop: '8px',
                  paddingTop: '8px',
                  borderTop: '1px solid rgba(0,0,0,0.1)',
                  color: '#667781',
                  fontSize: '13px',
                }}
              >
                <div style={{ fontSize: '11px', marginBottom: '4px' }}>ğŸŒ ç¿»è¯‘:</div>
                {message.translatedText}
              </div>
            )}
            
            {/* æ¶ˆæ¯å…ƒæ•°æ® */}
            <div
              style={{
                display: 'flex',
                justifyContent: 'flex-end',
                alignItems: 'center',
                gap: '4px',
                marginTop: '4px',
                fontSize: '11px',
                color: 'rgba(0,0,0,0.45)',
              }}
            >
              {message.isEdited && <span>å·²ç¼–è¾‘</span>}
              {message.isStarred && <span>â­</span>}
              <span>
                {new Date(message.createdAt).toLocaleTimeString('zh-CN', {
                  hour: '2-digit',
                  minute: '2-digit',
                })}
              </span>
              {isOwn && (
                <span>
                  {message.readAt ? 'âœ“âœ“' : message.deliveredAt ? 'âœ“âœ“' : 'âœ“'}
                </span>
              )}
            </div>
          </>
        )}
      </div>
    </div>
  );
};
```

### 4.3 è¾“å…¥åŒºåŸŸæ›´æ–°

åœ¨è¾“å…¥åŒºåŸŸæ·»åŠ å¼•ç”¨é¢„è§ˆå’Œåª’ä½“æŒ‰é’®ï¼š

```typescript
<div style={styles.inputContainer}>
  {/* å¼•ç”¨æ¶ˆæ¯é¢„è§ˆ */}
  {replyToMessage && (
    <div style={{ padding: '8px 12px', backgroundColor: WhatsAppColors.background }}>
      <QuotedMessage
        message={replyToMessage}
        onCancel={() => setReplyToMessage(null)}
        compact
      />
    </div>
  )}
  
  <div style={styles.inputRow}>
    {/* é™„ä»¶æŒ‰é’® */}
    <button
      onClick={() => setShowMediaUploader(true)}
      style={{
        width: '40px',
        height: '40px',
        borderRadius: '50%',
        border: 'none',
        backgroundColor: 'transparent',
        cursor: 'pointer',
        fontSize: '24px',
      }}
      title="é™„ä»¶"
    >
      ğŸ“
    </button>
    
    {/* ç°æœ‰çš„è¾“å…¥æ¡†å’Œå…¶ä»–æŒ‰é’® */}
    {/* ... */}
  </div>
</div>
```

### 4.4 æ·»åŠ å¯¹è¯æ¡†ç»„ä»¶

åœ¨é¡µé¢åº•éƒ¨æ·»åŠ æ‰€æœ‰å¯¹è¯æ¡†ï¼š

```typescript
{/* å³é”®èœå• */}
{contextMenu?.show && (
  <MessageContextMenu
    x={contextMenu.x}
    y={contextMenu.y}
    items={getMessageMenuItems(contextMenu.message, {
      onReply: () => handleReplyMessage(contextMenu.message),
      onEdit: () => setEditingMessageId(contextMenu.message.id),
      onDelete: () => handleDeleteMessage(contextMenu.message),
      onForward: () => {
        setForwardMessage(contextMenu.message);
        setShowForwardDialog(true);
      },
      onStar: () => handleStarMessage(contextMenu.message),
      onCopy: () => handleCopyMessage(contextMenu.message),
    })}
    onClose={() => setContextMenu(null)}
  />
)}

{/* è½¬å‘å¯¹è¯æ¡† */}
{showForwardDialog && forwardMessage && (
  <ForwardDialog
    message={forwardMessage}
    onForward={handleForwardMessage}
    onClose={() => {
      setShowForwardDialog(false);
      setForwardMessage(null);
    }}
  />
)}

{/* åª’ä½“ä¸Šä¼ å™¨ */}
{showMediaUploader && (
  <div
    style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(0, 0, 0, 0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 9999,
    }}
    onClick={() => setShowMediaUploader(false)}
  >
    <div
      onClick={(e) => e.stopPropagation()}
      style={{
        backgroundColor: WhatsAppColors.panelBackground,
        borderRadius: '12px',
        padding: '24px',
        maxWidth: '500px',
        width: '90%',
      }}
    >
      <h3 style={{ marginBottom: '16px' }}>ä¸Šä¼ æ–‡ä»¶</h3>
      <MediaUploader
        onUploadComplete={handleMediaUpload}
        onUploadError={(error) => {
          console.error('ä¸Šä¼ å¤±è´¥:', error);
          alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
        }}
      />
      <button
        onClick={() => setShowMediaUploader(false)}
        style={{
          marginTop: '16px',
          padding: '8px 16px',
          width: '100%',
        }}
      >
        å–æ¶ˆ
      </button>
    </div>
  </div>
)}
```

---

## äº”ã€WebSocket äº‹ä»¶å¤„ç†å¢å¼º

åœ¨ç°æœ‰çš„ WebSocket ç›‘å¬ä¸­æ·»åŠ æ–°äº‹ä»¶ï¼š

```typescript
useEffect(() => {
  if (!lastMessage) return;
  
  const { type, data } = lastMessage;
  
  switch (type) {
    case 'new_message':
      handleNewMessage(data);
      break;
      
    case 'message_edited':
      setMessages((prev) =>
        prev.map((msg) =>
          msg.id === data.messageId
            ? { ...msg, text: data.text, isEdited: true, editedAt: data.editedAt }
            : msg
        )
      );
      break;
      
    case 'message_deleted':
      setMessages((prev) =>
        prev.map((msg) =>
          msg.id === data.messageId
            ? { ...msg, isDeleted: true, deletedAt: data.deletedAt }
            : msg
        )
      );
      break;
      
    case 'message_starred':
      setMessages((prev) =>
        prev.map((msg) =>
          msg.id === data.messageId
            ? { ...msg, isStarred: data.isStarred, starredAt: data.starredAt }
            : msg
        )
      );
      break;
      
    case 'message_status':
      setMessages((prev) =>
        prev.map((msg) =>
          msg.id === data.messageId
            ? {
                ...msg,
                deliveredAt: data.delivered ? new Date().toISOString() : msg.deliveredAt,
                readAt: data.read ? new Date().toISOString() : msg.readAt,
              }
            : msg
        )
      );
      break;
  }
}, [lastMessage]);
```

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–

### 6.1 ä½¿ç”¨ React.memo åŒ…è£…æ¶ˆæ¯ç»„ä»¶

åˆ›å»ºä¸€ä¸ª memo åŒ–çš„æ¶ˆæ¯ç»„ä»¶ï¼š

```typescript
const MessageBubble = React.memo(({ message, isOwn, isEditing, onContextMenu, onEdit, onCancel }: any) => {
  // æ¸²æŸ“é€»è¾‘
  return (/* ... */);
});
```

### 6.2 ä½¿ç”¨ useCallback åŒ…è£…äº‹ä»¶å¤„ç†å‡½æ•°

ç¡®ä¿æ‰€æœ‰äº‹ä»¶å¤„ç†å‡½æ•°éƒ½ä½¿ç”¨ `useCallback` åŒ…è£…ï¼š

```typescript
const handleReplyMessage = useCallback((message: any) => {
  setReplyToMessage(message);
  setContextMenu(null);
  inputRef.current?.focus();
}, []);

const handleEditMessage = useCallback(async (messageId: string, newText: string) => {
  // ...
}, []);

// ... å…¶ä»–å‡½æ•°åŒç†
```

---

## ä¸ƒã€å®æ–½æ­¥éª¤

### ç¬¬ 1 æ­¥ï¼šå¤‡ä»½ç°æœ‰æ–‡ä»¶
```bash
cp web/app/chat/[id]/page.tsx web/app/chat/[id]/page.tsx.backup
```

### ç¬¬ 2 æ­¥ï¼šæ·»åŠ å¯¼å…¥
åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ æ‰€æœ‰æ–°ç»„ä»¶çš„å¯¼å…¥

### ç¬¬ 3 æ­¥ï¼šæ‰©å±•çŠ¶æ€
æ·»åŠ æ‰€æœ‰æ–°çš„çŠ¶æ€å˜é‡

### ç¬¬ 4 æ­¥ï¼šæ·»åŠ æ–°åŠŸèƒ½å‡½æ•°
é€ä¸ªæ·»åŠ æ¶ˆæ¯æ“ä½œã€åª’ä½“ä¸Šä¼ ç­‰å‡½æ•°

### ç¬¬ 5 æ­¥ï¼šæ›´æ–°UI
æ›´æ–°æ¶ˆæ¯æ¸²æŸ“ã€è¾“å…¥åŒºåŸŸã€å¤´éƒ¨ç­‰UI

### ç¬¬ 6 æ­¥ï¼šæ·»åŠ å¯¹è¯æ¡†
åœ¨é¡µé¢åº•éƒ¨æ·»åŠ æ‰€æœ‰å¯¹è¯æ¡†ç»„ä»¶

### ç¬¬ 7 æ­¥ï¼šæµ‹è¯•
å…¨é¢æµ‹è¯•æ‰€æœ‰æ–°åŠŸèƒ½

---

## å…«ã€æµ‹è¯•æ¸…å•

- [ ] åª’ä½“æ–‡ä»¶ä¸Šä¼ å’Œæ˜¾ç¤º
- [ ] å¼•ç”¨æ¶ˆæ¯å‘é€å’Œæ˜¾ç¤º
- [ ] æ¶ˆæ¯ç¼–è¾‘åŠŸèƒ½
- [ ] æ¶ˆæ¯åˆ é™¤åŠŸèƒ½
- [ ] æ¶ˆæ¯è½¬å‘åŠŸèƒ½
- [ ] æ¶ˆæ¯æ˜Ÿæ ‡åŠŸèƒ½
- [ ] å³é”®èœå•æ˜¾ç¤ºæ­£ç¡®é€‰é¡¹
- [ ] æ¶ˆæ¯æœç´¢åŠŸèƒ½
- [ ] å†å²æ¶ˆæ¯åˆ†é¡µåŠ è½½
- [ ] è‰ç¨¿è‡ªåŠ¨ä¿å­˜å’ŒåŠ è½½
- [ ] WebSocket å®æ—¶æ›´æ–°

---

## ä¹ã€å¸¸è§é—®é¢˜

### Q1ï¼šå¦‚ä½•è·³è½¬åˆ°æŒ‡å®šæ¶ˆæ¯ï¼Ÿ
Aï¼šå¯ä»¥ä½¿ç”¨ `scrollIntoView` æˆ–ç»´æŠ¤ä¸€ä¸ªæ¶ˆæ¯IDåˆ°DOMå…ƒç´ çš„æ˜ å°„ã€‚

### Q2ï¼šå¦‚ä½•å¤„ç†å¤§é‡æ¶ˆæ¯çš„æ€§èƒ½é—®é¢˜ï¼Ÿ
Aï¼šä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼ˆreact-windowï¼‰æˆ–æ¶ˆæ¯åˆ†é¡µã€‚

### Q3ï¼šå¦‚ä½•å¤„ç†åª’ä½“æ–‡ä»¶çš„åŠ è½½å¤±è´¥ï¼Ÿ
Aï¼šåœ¨ MediaPreview ç»„ä»¶ä¸­æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ã€‚

---

**å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼ŒèŠå¤©é¡µé¢å°†å…·å¤‡å®Œæ•´çš„ç°ä»£å³æ—¶é€šè®¯åŠŸèƒ½ï¼**

